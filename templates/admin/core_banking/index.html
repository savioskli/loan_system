{% extends "admin/base.html" %}

{% block title %}Core Banking Systems{% endblock %}

{% block styles %}
<!-- DataTables CSS -->
 
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    /* Custom styles for dark mode compatibility */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_processing,
    .modal-content {
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .page-container {
        padding: 1.5rem;
    }
    
    @media (min-width: 768px) {
        .page-container {
            padding: 2rem;
        }
    }
    .dataTables_wrapper .dataTables_paginate {
        @apply text-gray-700 dark:text-gray-300;
    }

    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        @apply bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-md shadow-sm;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        @apply bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        @apply bg-primary text-white border-primary hover:bg-primary hover:text-white;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100 dark:bg-gray-900">
    <div class="flex-1 overflow-x-hidden overflow-y-auto page-container">
        <!-- Header -->
        <div class="bg-white dark:bg-gray-800 shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-primary rounded-full p-3">
                        <i class="fas fa-university text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Core Banking Systems</h1>
                        <p class="text-gray-600 dark:text-gray-400">Manage your core banking integrations</p>
                    </div>
                </div>
                <button onclick="showAddModal()" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i>
                    Add System
                </button>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Total Systems -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="bg-blue-100 dark:bg-blue-900 rounded-full p-3">
                        <i class="fas fa-server text-blue-500 dark:text-blue-300"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Systems</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ total_systems }}</p>
                    </div>
                </div>
            </div>

            <!-- Active Systems -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="bg-green-100 dark:bg-green-900 rounded-full p-3">
                        <i class="fas fa-check-circle text-green-500 dark:text-green-300"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Systems</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ active_systems }}</p>
                    </div>
                </div>
            </div>

            <!-- Total Endpoints -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="bg-yellow-100 dark:bg-yellow-900 rounded-full p-3">
                        <i class="fas fa-network-wired text-yellow-500 dark:text-yellow-300"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Endpoints</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ total_endpoints }}</p>
                    </div>
                </div>
            </div>

            <!-- Active Endpoints -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="bg-cyan-100 dark:bg-cyan-900 rounded-full p-3">
                        <i class="fas fa-plug text-cyan-500 dark:text-cyan-300"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Endpoints</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ active_endpoints }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Systems Table -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 sm:mb-0">
                        <i class="fas fa-table mr-2 text-gray-400"></i>
                        Banking Systems
                    </h2>
                </div>
            </div>

            <div class="overflow-x-auto p-6">
                <table id="systemsTable" class="w-full">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Base URL</th>
                            <th>Auth Type</th>
                            <th>Status</th>
                            <th>Endpoints</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for system in systems %}
                        <tr>
                            <td>{{ system.name }}</td>
                            <td>{{ system.base_url }}</td>
                            <td>{{ system.auth_type }}</td>
                            <td>
                                {% if system.is_active %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                    Active
                                </span>
                                {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                                    Inactive
                                </span>
                                {% endif %}
                            </td>
                            <td>{{ system.endpoints|length }}</td>
                            <td>{{ system.updated_at|datetime }}</td>
                            <td>
                                <div class="flex space-x-2">
                                    <a href="{{ url_for('admin.view_system', system_id=system.id) }}" 
                                       class="text-cyan-600 hover:text-cyan-900 dark:text-cyan-400 dark:hover:text-cyan-300"
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button onclick="showEditModal()" 
                                            class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300"
                                            title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteSystem({{ system.id }})" 
                                            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add System Modal -->
<div class="modal fade" id="addSystemModal" tabindex="-1" aria-labelledby="addSystemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="modal-header border-b border-gray-200 dark:border-gray-700 p-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Add Banking System
                </h3>
                <button type="button" class="text-gray-400 hover:text-gray-500" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body p-6">
                <form id="addSystemForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">System Name</label>
                            <input type="text" name="name" required
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Base URL</label>
                            <input type="url" name="base_url" required
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Port</label>
                            <input type="number" name="port"
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Authentication Type</label>
                            <select name="auth_type" onchange="updateAuthFields()" required
                                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50">
                                <option value="">Select Type</option>
                                <option value="basic">Basic Auth</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="api_key">API Key</option>
                            </select>
                        </div>
                    </div>

                    <div id="authFields" class="space-y-6 hidden">
                        <!-- Dynamic auth fields will be inserted here -->
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                        <textarea name="description" rows="3"
                                 class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-gray-50 dark:bg-gray-700 px-6 py-3 flex justify-end space-x-2">
                <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 dark:hover:bg-gray-500" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" onclick="submitAddSystem()" class="px-4 py-2 text-sm font-medium text-white bg-primary border border-transparent rounded-md shadow-sm hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    Add System
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit System Modal -->
<div class="modal fade" id="editSystemModal" tabindex="-1">
    <div class="modal-dialog max-w-2xl">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <!-- Similar structure to Add Modal but with id="editSystemForm" -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
function updateAuthFields() {
    const authType = $('select[name="auth_type"]').val();
    const authFields = $('#authFields');
    authFields.html('').removeClass('hidden');

    const inputClasses = 'mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50';
    const labelClasses = 'block text-sm font-medium text-gray-700 dark:text-gray-300';

    switch (authType) {
        case 'basic':
            authFields.html(`
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="${labelClasses}">Username</label>
                        <input type="text" name="username" required class="${inputClasses}">
                    </div>
                    <div>
                        <label class="${labelClasses}">Password</label>
                        <input type="password" name="password" required class="${inputClasses}">
                    </div>
                </div>
            `);
            break;
        case 'bearer':
            authFields.html(`
                <div>
                    <label class="${labelClasses}">Token</label>
                    <input type="text" name="token" required class="${inputClasses}">
                </div>
            `);
            break;
        case 'api_key':
            authFields.html(`
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="${labelClasses}">Key Name</label>
                        <input type="text" name="key_name" required class="${inputClasses}">
                    </div>
                    <div>
                        <label class="${labelClasses}">Key Value</label>
                        <input type="text" name="key_value" required class="${inputClasses}">
                    </div>
                </div>
            `);
            break;
        default:
            authFields.addClass('hidden');
    }
}

function showAddModal() {
    const modal = new bootstrap.Modal(document.getElementById('addSystemModal'));
    modal.show();
}

function showEditModal() {
    const modal = new bootstrap.Modal(document.getElementById('editSystemModal'));
    modal.show();
}

$(document).ready(function() {
    // Initialize Select2
    $('select').select2({
        theme: 'classic',
        width: '100%'
    });
    
    // Initialize DataTable
    const table = $('#systemsTable').DataTable({
        responsive: true,
        dom: '<"flex flex-col md:flex-row justify-between items-center mb-4"<"flex-1"f><"flex-shrink-0 mt-2 md:mt-0"l>>rt<"flex flex-col md:flex-row justify-between items-center mt-4"<"flex-1"i><"flex-shrink-0 mt-2 md:mt-0"p>>',
        language: {
            search: "",
            searchPlaceholder: "Search systems..."
        }
    });
});

async function submitAddSystem() {
    const form = $('#addSystemForm');
    const formData = new FormData(form[0]);
    const data = {
        name: formData.get('name'),
        base_url: formData.get('base_url'),
        port: formData.get('port'),
        auth_type: formData.get('auth_type'),
        description: formData.get('description'),
        auth_credentials: {}
    };

    switch (data.auth_type) {
        case 'basic':
            data.auth_credentials = {
                username: formData.get('username'),
                password: formData.get('password')
            };
            break;
        case 'bearer':
            data.auth_credentials = {
                token: formData.get('token')
            };
            break;
        case 'api_key':
            data.auth_credentials = {
                key_name: formData.get('key_name'),
                key_value: formData.get('key_value')
            };
            break;
    }

    try {
        const response = await fetch('{{ url_for("admin.add_system") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            showNotification('error', result.message || 'Error adding system');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('error', 'Error adding system');
    }
}

function showNotification(type, message) {
    const toast = $('<div>')
        .addClass(`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg ${
            type === 'error' ? 'bg-red-500' : 'bg-green-500'
        } text-white transform transition-transform duration-300 translate-y-0`)
        .text(message)
        .appendTo('body');

    setTimeout(() => {
        toast.addClass('translate-y-full');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

async function deleteSystem(systemId) {
    if (!confirm('Are you sure you want to delete this system?')) return;

    try {
        const response = await fetch(`/admin/core-banking/system/${systemId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });

        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            showNotification('error', result.message || 'Error deleting system');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('error', 'Error deleting system');
    }
}

function editSystem(systemId) {
    // Fetch system data and populate form
    fetch(`/admin/core-banking/system/${systemId}`)
        .then(response => response.json())
        .then(data => {
            const form = $('#editSystemForm');
            form.find('[name="name"]').val(data.name);
            form.find('[name="base_url"]').val(data.base_url);
            form.find('[name="port"]').val(data.port);
            form.find('[name="auth_type"]').val(data.auth_type).trigger('change');
            form.find('[name="description"]').val(data.description);
            $('#editSystemModal').modal('show');
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('error', 'Error loading system data');
        });
}
</script>
{% endblock %}
