{% extends "admin/base.html" %}

{% block title %}Core Banking Systems{% endblock %}

{% block styles %}
<!-- DataTables CSS -->
 
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    /* Custom styles for dark mode compatibility */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_processing,
    .modal-content {
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .page-container {
        padding: 1.5rem;
    }
    
    @media (min-width: 768px) {
        .page-container {
            padding: 2rem;
        }
    }
    .dataTables_wrapper .dataTables_paginate {
        @apply text-gray-700 dark:text-gray-300;
    }

    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        @apply bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-md shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 transition-colors duration-200;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        @apply bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        @apply bg-primary text-white border-primary hover:bg-primary hover:text-white;
    }
    
    /* Enhanced Modal Styles */
    .modal.fade .modal-dialog {
        transform: scale(0.95);
        transition: transform 0.2s ease-out;
    }
    
    .modal.show .modal-dialog {
        transform: scale(1);
    }
    
    .form-loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    .form-loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 2rem;
        height: 2rem;
        margin: -1rem 0 0 -1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .field-tooltip {
        position: relative;
        display: inline-block;
        margin-left: 0.5rem;
        color: #6b7280;
    }
    
    .field-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    
    .tooltip-text {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        z-index: 1070;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        padding: 0.5rem;
        background-color: #1f2937;
        color: white;
        text-align: center;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        transition: opacity 0.2s;
        white-space: nowrap;
    }
    
    /* Input padding styles */
    .modal input[type="text"],
    .modal input[type="url"],
    .modal input[type="number"],
    .modal select,
    .modal textarea {
        padding: 0.625rem 0.75rem;
    }
    
    .modal select {
        padding-right: 2rem;
    }
    
    .modal textarea {
        padding: 0.75rem;
    }
    
    /* Native Select Styles */
    .modal select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    
    .modal select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
    
    .dark .modal select {
        background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239CA3AF' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100 dark:bg-gray-900">
    <div class="flex-1 overflow-x-hidden overflow-y-auto page-container">
        <!-- Header -->
        <div class="bg-white dark:bg-gray-800 shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-primary rounded-full p-3">
                        <i class="fas fa-university text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Core Banking Systems</h1>
                        <p class="text-gray-600 dark:text-gray-400">Manage your core banking integrations</p>
                    </div>
                </div>
                <button onclick="showAddModal()" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i>
                    Add System
                </button>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Total Systems -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="bg-blue-100 dark:bg-blue-900 rounded-full p-3">
                        <i class="fas fa-server text-blue-500 dark:text-blue-300"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Systems</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ total_systems }}</p>
                    </div>
                </div>
            </div>

            <!-- Active Systems -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="bg-green-100 dark:bg-green-900 rounded-full p-3">
                        <i class="fas fa-check-circle text-green-500 dark:text-green-300"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Systems</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ active_systems }}</p>
                    </div>
                </div>
            </div>

            <!-- Total Endpoints -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="bg-yellow-100 dark:bg-yellow-900 rounded-full p-3">
                        <i class="fas fa-network-wired text-yellow-500 dark:text-yellow-300"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Endpoints</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ total_endpoints }}</p>
                    </div>
                </div>
            </div>

            <!-- Active Endpoints -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="bg-cyan-100 dark:bg-cyan-900 rounded-full p-3">
                        <i class="fas fa-plug text-cyan-500 dark:text-cyan-300"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Endpoints</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ active_endpoints }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Systems Table -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 sm:mb-0">
                        <i class="fas fa-table mr-2 text-gray-400"></i>
                        Banking Systems
                    </h2>
                    <button onclick="showAddEndpointModal()" class="inline-flex items-center px-4 py-2 bg-secondary text-white rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition-colors duration-200">
                        <i class="fas fa-link mr-2"></i>
                        Add Endpoint
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto p-6">
                <table id="systemsTable" class="w-full">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Base URL</th>
                            <th>Auth Type</th>
                            <th>Status</th>
                            <th>Endpoints</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for system in systems %}
                        <tr>
                            <td>{{ system.name }}</td>
                            <td>{{ system.base_url }}</td>
                            <td>{{ system.auth_type }}</td>
                            <td>
                                {% if system.is_active %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                    Active
                                </span>
                                {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                                    Inactive
                                </span>
                                {% endif %}
                            </td>
                            <td>{{ system.endpoints|length }}</td>
                            <td>{{ system.updated_at|datetime }}</td>
                            <td>
                                <div class="flex space-x-2">
                                    <button onclick="showAddEndpointModal({{ system.id }})" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition-colors duration-200">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button onclick="viewSystem({{ system.id }})" 
                                            class="text-cyan-600 hover:text-cyan-900 dark:text-cyan-400 dark:hover:text-cyan-300"
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="editSystem({{ system.id }})" 
                                            class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300"
                                            title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteSystem({{ system.id }})" 
                                            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add System Modal -->
<div class="modal fade" id="addSystemModal" tabindex="-1" aria-labelledby="addSystemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="modal-header border-b border-gray-200 dark:border-gray-700 p-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Add Banking System
                </h3>
                <button type="button" class="text-gray-400 hover:text-gray-500 transition-colors duration-200" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body p-6">
                <form id="addSystemForm" class="space-y-6 relative">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                System Name
                                <span class="field-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Enter a unique name for the banking system</span>
                                </span>
                            </label>
                            <input type="text" name="name" required
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 transition-colors duration-200">
                            <div class="text-sm text-red-500 mt-1 hidden"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Base URL
                                <span class="field-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">The base URL of the banking system API</span>
                                </span>
                            </label>
                            <input type="url" name="base_url" required
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 transition-colors duration-200">
                            <div class="text-sm text-red-500 mt-1 hidden"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Port
                                <span class="field-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Optional: Specify a custom port number</span>
                                </span>
                            </label>
                            <input type="number" name="port"
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 transition-colors duration-200">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Authentication Type
                                <span class="field-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Select the authentication method required by the banking system API</span>
                                </span>
                            </label>
                            <select name="auth_type" onchange="updateAuthFields(false)" required
                                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 transition-colors duration-200">
                                <option value="">Select Authentication Type</option>
                                <option value="none">No Authentication</option>
                                <option value="basic">Basic Auth (Username/Password)</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="api_key">API Key</option>
                                <option value="oauth2">OAuth 2.0</option>
                            </select>
                            <div class="text-sm text-red-500 mt-1 hidden"></div>
                        </div>
                    </div>
                    <div id="addAuthFields"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Description
                            <span class="field-tooltip">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltip-text">Add any additional notes or details about this system</span>
                            </span>
                        </label>
                        <textarea name="description" rows="3"
                                 class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 transition-colors duration-200"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-t border-gray-200 dark:border-gray-700 p-4 flex justify-end space-x-3">
                <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" onclick="submitAddSystem()" class="px-4 py-2 text-sm font-medium text-white bg-primary border border-transparent rounded-md shadow-sm hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                    <span class="submit-text">Add System</span>
                    <span class="loading-text hidden">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Adding...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit System Modal -->
<div class="modal fade" id="editSystemModal" tabindex="-1" aria-labelledby="editSystemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="modal-header border-b border-gray-200 dark:border-gray-700 p-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Edit Banking System
                </h3>
                <button type="button" class="text-gray-400 hover:text-gray-500" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body p-6">
                <form id="editSystemForm" class="space-y-6 relative">
                    <input type="hidden" name="system_id" id="editSystemId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                System Name
                                <span class="field-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Unique name to identify the banking system</span>
                                </span>
                            </label>
                            <input type="text" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Enter system name">
                            <div class="text-sm text-red-500 mt-1 hidden"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Base URL
                                <span class="field-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Base URL of the banking system API</span>
                                </span>
                            </label>
                            <input type="url" name="base_url" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="https://api.example.com">
                            <div class="text-sm text-red-500 mt-1 hidden"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Port
                                <span class="field-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Optional port number if not using standard ports</span>
                                </span>
                            </label>
                            <input type="number" name="port" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g., 8080">
                            <div class="text-sm text-red-500 mt-1 hidden"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Authentication Type
                                <span class="field-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text">Type of authentication required by the API</span>
                                </span>
                            </label>
                            <select name="auth_type" required onchange="updateAuthFields(true)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select authentication type</option>
                                <option value="none">None</option>
                                <option value="basic">Basic Auth</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="api_key">API Key</option>
                                <option value="oauth2">OAuth 2.0</option>
                            </select>
                            <div class="text-sm text-red-500 mt-1 hidden"></div>
                        </div>
                    </div>
                    <div id="editAuthFields" class="space-y-6">
                        <!-- Auth fields will be dynamically added here -->
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Description
                            <span class="field-tooltip">
                                <i class="fas fa-info-circle"></i>
                                <span class="tooltip-text">Optional description of the banking system</span>
                            </span>
                        </label>
                        <textarea name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Enter system description"></textarea>
                        <div class="text-sm text-red-500 mt-1 hidden"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-t border-gray-200 dark:border-gray-700 p-4 flex justify-end space-x-3">
                <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" onclick="submitEditSystem()" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md shadow-sm hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
                    <span class="submit-text">Save Changes</span>
                    <span class="loading-text hidden">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Saving...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Add Endpoint Modal -->
<div class="modal fade" id="addEndpointModal" tabindex="-1" aria-labelledby="addEndpointModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="modal-header border-b border-gray-200 dark:border-gray-700 p-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Add Endpoint
                </h3>
                <button type="button" class="close text-gray-400 hover:text-gray-500" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-6">
                <form id="addEndpointForm" class="space-y-6 relative" onsubmit="submitAddEndpoint(event)">
                    <input type="hidden" name="system_id" id="endpointSystemId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Endpoint Name *
                            </label>
                            <input type="text" name="name" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                HTTP Method *
                            </label>
                            <select name="method" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Path *
                            <span class="text-xs text-gray-500">(e.g., /api/v1/users)</span>
                        </label>
                        <input type="text" name="path" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Description
                        </label>
                        <textarea name="description" rows="2" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Parameters
                            <span class="text-xs text-gray-500">(JSON format)</span>
                        </label>
                        <textarea name="parameters" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white font-mono"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Headers
                            <span class="text-xs text-gray-500">(JSON format)</span>
                        </label>
                        <textarea name="headers" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white font-mono"></textarea>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="is_active" checked class="h-4 w-4 text-primary border-gray-300 rounded">
                        <label class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                            Active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-t border-gray-200 dark:border-gray-700 p-4 flex justify-end space-x-3">
                <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition-colors duration-200" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="submit" form="addEndpointForm" class="px-4 py-2 text-sm font-medium text-white bg-secondary border border-transparent rounded-md shadow-sm hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition-colors duration-200">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>
<!-- System Details Modal -->
<div class="modal fade" id="viewSystemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <div class="modal-header border-b border-gray-200 dark:border-gray-700 p-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="systemDetailsTitle">
                    System Details
                </h3>
                <button type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body p-6">
                <div id="systemDetailsContent" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    Loading...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script>
function updateAuthFields(isEdit = false) {
    const formPrefix = isEdit ? 'edit' : 'add';
    const authType = document.querySelector(`#${formPrefix}SystemForm [name="auth_type"]`).value;
    const authFieldsContainer = document.getElementById(`${formPrefix}AuthFields`);
    const inputClasses = 'mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 transition-colors duration-200 px-4 py-2.5';
    const labelClasses = 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1';
    const tooltipClasses = 'field-tooltip';
    const tooltipIconClasses = 'fas fa-info-circle';
    const containerClasses = 'bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700';

    // Clear existing auth fields
    authFieldsContainer.innerHTML = '';

    if (authType === 'none') {
        authFieldsContainer.innerHTML = `
            <div class="${containerClasses}">
                <p class="text-sm text-gray-600 dark:text-gray-300">
                    <i class="fas fa-info-circle mr-2"></i>
                    No authentication will be used for API requests to this banking system.
                </p>
            </div>
        `;
    } else if (authType === 'basic') {
        authFieldsContainer.innerHTML = `
            <div class="${containerClasses}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="${labelClasses}">
                            Username
                            <span class="${tooltipClasses}">
                                <i class="${tooltipIconClasses}"></i>
                                <span class="tooltip-text">Enter the API username</span>
                            </span>
                        </label>
                        <input type="text" name="username" required class="${inputClasses}" placeholder="API Username">
                        <div class="text-sm text-red-500 mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="${labelClasses}">
                            Password
                            <span class="${tooltipClasses}">
                                <i class="${tooltipIconClasses}"></i>
                                <span class="tooltip-text">Enter the API password</span>
                            </span>
                        </label>
                        <input type="password" name="password" required class="${inputClasses}" placeholder="API Password">
                        <div class="text-sm text-red-500 mt-1 hidden"></div>
                    </div>
                </div>
            </div>
        `;
    } else if (authType === 'bearer') {
        authFieldsContainer.innerHTML = `
            <div class="${containerClasses}">
                <div>
                    <label class="${labelClasses}">
                        Bearer Token
                        <span class="${tooltipClasses}">
                            <i class="${tooltipIconClasses}"></i>
                            <span class="tooltip-text">Enter the authentication token (without 'Bearer' prefix)</span>
                        </span>
                    </label>
                    <input type="text" name="token" required class="${inputClasses}" placeholder="Enter token">
                    <div class="text-sm text-red-500 mt-1 hidden"></div>
                </div>
            </div>
        `;
    } else if (authType === 'api_key') {
        authFieldsContainer.innerHTML = `
            <div class="${containerClasses}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="${labelClasses}">
                            Key Name
                            <span class="${tooltipClasses}">
                                <i class="${tooltipIconClasses}"></i>
                                <span class="tooltip-text">Header or query parameter name for the API key</span>
                            </span>
                        </label>
                        <input type="text" name="key_name" required class="${inputClasses}" placeholder="e.g., X-API-Key">
                        <div class="text-sm text-red-500 mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="${labelClasses}">
                            Key Value
                            <span class="${tooltipClasses}">
                                <i class="${tooltipIconClasses}"></i>
                                <span class="tooltip-text">The actual API key value</span>
                            </span>
                        </label>
                        <input type="text" name="key_value" required class="${inputClasses}" placeholder="Enter API key">
                        <div class="text-sm text-red-500 mt-1 hidden"></div>
                    </div>
                </div>
            </div>
        `;
    } else if (authType === 'oauth2') {
        authFieldsContainer.innerHTML = `
            <div class="${containerClasses}">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="${labelClasses}">
                                Client ID
                                <span class="${tooltipClasses}">
                                    <i class="${tooltipIconClasses}"></i>
                                    <span class="tooltip-text">OAuth 2.0 client identifier</span>
                                </span>
                            </label>
                            <input type="text" name="client_id" required class="${inputClasses}" placeholder="Enter Client ID">
                            <div class="text-sm text-red-500 mt-1 hidden"></div>
                        </div>
                        <div>
                            <label class="${labelClasses}">
                                Client Secret
                                <span class="${tooltipClasses}">
                                    <i class="${tooltipIconClasses}"></i>
                                    <span class="tooltip-text">OAuth 2.0 client secret</span>
                                </span>
                            </label>
                            <input type="password" name="client_secret" required class="${inputClasses}" placeholder="Enter Client Secret">
                            <div class="text-sm text-red-500 mt-1 hidden"></div>
                        </div>
                    </div>
                    <div>
                        <label class="${labelClasses}">
                            Token URL
                            <span class="${tooltipClasses}">
                                <i class="${tooltipIconClasses}"></i>
                                <span class="tooltip-text">URL for obtaining OAuth 2.0 tokens</span>
                            </span>
                        </label>
                        <input type="url" name="token_url" required class="${inputClasses}" placeholder="Enter Token URL">
                        <div class="text-sm text-red-500 mt-1 hidden"></div>
                    </div>
                </div>
            </div>
        `;
    }
}

function showAddModal() {
    // Clear form
    const form = document.getElementById('addSystemForm');
    form.reset();
    form.querySelectorAll('.text-red-500').forEach(el => el.classList.add('hidden'));
    
    // Update auth fields
    updateAuthFields(false);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addSystemModal'));
    modal.show();
}

$(document).ready(function() {
    // Initialize DataTable
    const table = $('#systemsTable').DataTable({
        responsive: true,
        dom: '<"flex flex-col md:flex-row justify-between items-center mb-4"<"flex-1"f><"flex-shrink-0 mt-2 md:mt-0"l>>rt<"flex flex-col md:flex-row justify-between items-center mt-4"<"flex-1"i><"flex-shrink-0 mt-2 md:mt-0"p>>',
        language: {
            search: "",
            searchPlaceholder: "Search systems..."
        },
        columnDefs: [{
            targets: -1, // Last column (actions)
            orderable: false,
            searchable: false
        }]
    });

    // Prevent DataTables from handling clicks on action links
    $('#systemsTable').on('click', 'a', function(e) {
        e.stopPropagation();
    });
});

async function submitAddSystem() {
    const form = document.getElementById('addSystemForm');
    const submitBtn = form.closest('.modal-content').querySelector('button[onclick="submitAddSystem()"]');
    
    // Clear previous errors
    form.querySelectorAll('.text-red-500').forEach(el => el.classList.add('hidden'));
    
    // Basic form validation
    let isValid = true;
    form.querySelectorAll('[required]').forEach(input => {
        if (!input.value) {
            isValid = false;
            const errorDiv = input.nextElementSibling;
            errorDiv.textContent = 'This field is required';
            errorDiv.classList.remove('hidden');
        }
    });
    
    if (!isValid) return;
    
    // Show loading state
    form.classList.add('form-loading');
    submitBtn.disabled = true;
    submitBtn.querySelector('.submit-text').classList.add('hidden');
    submitBtn.querySelector('.loading-text').classList.remove('hidden');
    
    // Collect form data
    const formData = new FormData(form);
    const data = {
        name: formData.get('name'),
        base_url: formData.get('base_url'),
        port: formData.get('port') ? parseInt(formData.get('port')) : null,
        description: formData.get('description'),
        auth_type: formData.get('auth_type'),
    };

    // Add auth credentials based on auth type
    switch (data.auth_type) {
        case 'basic':
            data.username = formData.get('username');
            data.password = formData.get('password');
            break;
        case 'bearer':
            data.token = formData.get('token');
            break;
        case 'api_key':
            data.key_name = formData.get('key_name');
            data.key_value = formData.get('key_value');
            break;
        case 'oauth2':
            data.client_id = formData.get('client_id');
            data.client_secret = formData.get('client_secret');
            data.token_url = formData.get('token_url');
            break;
    }
    
    fetch('/admin/core-banking/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Banking system added successfully');
            $('#addSystemModal').modal('hide');
            location.reload();
        } else {
            showNotification('error', data.message || 'Failed to add banking system');
            // Show field-specific errors if available
            if (data.errors) {
                Object.entries(data.errors).forEach(([field, error]) => {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input) {
                        const errorDiv = input.nextElementSibling;
                        errorDiv.textContent = error;
                        errorDiv.classList.remove('hidden');
                    }
                });
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', 'An error occurred while adding the banking system');
    })
    .finally(() => {
        // Reset loading state
        form.classList.remove('form-loading');
        submitBtn.disabled = false;
        submitBtn.querySelector('.submit-text').classList.remove('hidden');
        submitBtn.querySelector('.loading-text').classList.add('hidden');
    });
}

function showNotification(type, message) {
    const toast = $('<div>')
        .addClass(`fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg ${
            type === 'error' ? 'bg-red-500' : 'bg-green-500'
        } text-white transform transition-transform duration-300 translate-y-0`)
        .text(message)
        .appendTo('body');

    setTimeout(() => {
        toast.addClass('translate-y-full');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

async function deleteSystem(systemId) {
    if (!confirm('Are you sure you want to delete this system?')) return;

    try {
        const response = await fetch(`/admin/core-banking/system/${systemId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });

        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            showNotification('error', result.message || 'Error deleting system');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('error', 'Error deleting system');
    }
}

async function editSystem(systemId) {
    try {
        const response = await fetch(`/admin/core-banking/${systemId}`);
        const data = await response.json();
        
        if (!data.success) {
            showNotification('error', data.message || 'Error loading system data');
            return;
        }

        const system = data.system;
        const form = document.getElementById('editSystemForm');
        
        // Set system ID
        document.getElementById('editSystemId').value = systemId;
        
        // Set basic fields
        form.querySelector('[name="name"]').value = system.name;
        form.querySelector('[name="base_url"]').value = system.base_url;
        form.querySelector('[name="port"]').value = system.port || '';
        form.querySelector('[name="description"]').value = system.description || '';
        
        // Set auth type and trigger change event
        const authTypeSelect = form.querySelector('[name="auth_type"]');
        authTypeSelect.value = system.auth_type;
        updateAuthFields(true);
        
        // Set auth fields based on type
        if (system.auth_type === 'basic') {
            form.querySelector('[name="username"]').value = system.username || '';
            form.querySelector('[name="password"]').value = system.password || '';
        } else if (system.auth_type === 'bearer') {
            form.querySelector('[name="token"]').value = system.token || '';
        } else if (system.auth_type === 'api_key') {
            form.querySelector('[name="key_name"]').value = system.key_name || '';
            form.querySelector('[name="key_value"]').value = system.key_value || '';
        } else if (system.auth_type === 'oauth2') {
            form.querySelector('[name="client_id"]').value = system.client_id || '';
            form.querySelector('[name="client_secret"]').value = system.client_secret || '';
            form.querySelector('[name="token_url"]').value = system.token_url || '';
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editSystemModal'));
        modal.show();
    } catch (error) {
        console.error('Error:', error);
        showNotification('error', 'Error loading system data');
    }
}

async function submitEditSystem() {
    const form = document.getElementById('editSystemForm');
    const submitBtn = form.closest('.modal-content').querySelector('button[onclick="submitEditSystem()"]');
    const systemId = document.getElementById('editSystemId').value;
    
    // Clear previous errors
    form.querySelectorAll('.text-red-500').forEach(el => el.classList.add('hidden'));
    
    // Basic form validation
    let isValid = true;
    form.querySelectorAll('[required]').forEach(input => {
        if (!input.value) {
            isValid = false;
            const errorDiv = input.nextElementSibling;
            errorDiv.textContent = 'This field is required';
            errorDiv.classList.remove('hidden');
        }
    });
    
    if (!isValid) return;
    
    // Show loading state
    form.classList.add('form-loading');
    submitBtn.disabled = true;
    submitBtn.querySelector('.submit-text').classList.add('hidden');
    submitBtn.querySelector('.loading-text').classList.remove('hidden');
    
    // Collect form data
    const formData = new FormData(form);
    const data = {
        name: formData.get('name'),
        base_url: formData.get('base_url'),
        port: formData.get('port') ? parseInt(formData.get('port')) : null,
        description: formData.get('description'),
        auth_type: formData.get('auth_type'),
    };

    // Add auth credentials based on auth type
    switch (data.auth_type) {
        case 'basic':
            data.username = formData.get('username');
            data.password = formData.get('password');
            break;
        case 'bearer':
            data.token = formData.get('token');
            break;
        case 'api_key':
            data.key_name = formData.get('key_name');
            data.key_value = formData.get('key_value');
            break;
        case 'oauth2':
            data.client_id = formData.get('client_id');
            data.client_secret = formData.get('client_secret');
            data.token_url = formData.get('token_url');
            break;
    }
    
    try {
        const response = await fetch(`/admin/core-banking/${systemId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            showNotification('success', 'Banking system updated successfully');
            $('#editSystemModal').modal('hide');
            location.reload();
        } else {
            showNotification('error', result.message || 'Failed to update banking system');
            // Show field-specific errors if available
            if (result.errors) {
                Object.entries(result.errors).forEach(([field, error]) => {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input) {
                        const errorDiv = input.nextElementSibling;
                        errorDiv.textContent = error;
                        errorDiv.classList.remove('hidden');
                    }
                });
            }
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('error', 'An error occurred while updating the banking system');
    } finally {
        // Reset loading state
        form.classList.remove('form-loading');
        submitBtn.disabled = false;
        submitBtn.querySelector('.submit-text').classList.remove('hidden');
        submitBtn.querySelector('.loading-text').classList.add('hidden');
    }
}

function viewSystem(systemId) {
    // Show loading state
    $('#viewSystemModal').modal('show');
    $('#systemDetailsContent').html('Loading...');
    
    // Fetch system details
    fetch(`/api/core-banking/system/${systemId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const content = generateSystemDetailsHTML(data.data);
                $('#systemDetailsContent').html(content);
                initializeChart(data.data.chart_data);
            } else {
                showNotification('error', data.message || 'Failed to load system details');
                $('#systemDetailsContent').html('Failed to load system details');
            }
        })
        .catch(error => {
            showNotification('error', 'Failed to load system details');
            console.error('Error:', error);
            $('#systemDetailsContent').html('Failed to load system details');
        });
}

function generateSystemDetailsHTML(data) {
    const { system, stats, endpoints, logs } = data;
    
    return `
        <!-- System Info -->
        <div class="lg:col-span-1">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <h4 class="text-lg font-medium mb-4">System Information</h4>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm font-medium text-gray-500 dark:text-gray-400">Name</label>
                        <p class="text-gray-900 dark:text-white">${system.name}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-500 dark:text-gray-400">Base URL</label>
                        <p class="text-gray-900 dark:text-white">${system.base_url}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-500 dark:text-gray-400">Auth Type</label>
                        <p class="text-gray-900 dark:text-white">${system.auth_type}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-500 dark:text-gray-400">Status</label>
                        <p>${system.is_active ? 
                            '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>' :
                            '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>'
                        }</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="lg:col-span-2">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <h4 class="text-lg font-medium mb-4">Statistics</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-gray-800 rounded p-3">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Total Requests</p>
                        <p class="text-xl font-semibold">${stats.total_requests}</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded p-3">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Error Rate</p>
                        <p class="text-xl font-semibold">${((stats.error_requests / stats.total_requests) * 100 || 0).toFixed(1)}%</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded p-3">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Active Endpoints</p>
                        <p class="text-xl font-semibold">${stats.active_endpoints}</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded p-3">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Success Rate</p>
                        <p class="text-xl font-semibold">${stats.success_rate.toFixed(1)}%</p>
                    </div>
                </div>
                
                <!-- Chart -->
                <div class="mt-6">
                    <canvas id="requestsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tables Section -->
        <div class="lg:col-span-3">
            <div class="space-y-6">
                <!-- Endpoints Table -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h4 class="text-lg font-medium mb-4">Endpoints</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2">Name</th>
                                    <th class="px-4 py-2">Path</th>
                                    <th class="px-4 py-2">Method</th>
                                    <th class="px-4 py-2">Status</th>
                                    <th class="px-4 py-2">Success Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${endpoints.map(endpoint => `
                                    <tr>
                                        <td class="px-4 py-2">${endpoint.name}</td>
                                        <td class="px-4 py-2">${endpoint.path}</td>
                                        <td class="px-4 py-2">${endpoint.method}</td>
                                        <td class="px-4 py-2">${endpoint.is_active ? 
                                            '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>' :
                                            '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>'
                                        }</td>
                                        <td class="px-4 py-2">${data.endpoint_stats[endpoint.id].success_rate.toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Logs -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h4 class="text-lg font-medium mb-4">Recent Logs</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2">Time</th>
                                    <th class="px-4 py-2">Method</th>
                                    <th class="px-4 py-2">URL</th>
                                    <th class="px-4 py-2">Status</th>
                                    <th class="px-4 py-2">Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.map(log => `
                                    <tr>
                                        <td class="px-4 py-2">${new Date(log.created_at).toLocaleString()}</td>
                                        <td class="px-4 py-2">${log.request_method}</td>
                                        <td class="px-4 py-2">${log.request_url}</td>
                                        <td class="px-4 py-2">${log.response_status || 'N/A'}</td>
                                        <td class="px-4 py-2">${log.error_message || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function initializeChart(chartData) {
    const ctx = document.getElementById('requestsChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: 'Successful Requests',
                    data: chartData.success_data,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true
                },
                {
                    label: 'Failed Requests',
                    data: chartData.error_data,
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Request History (Last 7 Days)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Function to show add endpoint modal
function showAddEndpointModal(systemId) {
    if (!systemId) {
        showNotification('error', 'System ID is required');
        return;
    }
    document.getElementById('endpointSystemId').value = systemId;
    const modal = new bootstrap.Modal(document.getElementById('addEndpointModal'));
    modal.show();
}

// Function to handle endpoint form submission
function submitAddEndpoint(event) {
    event.preventDefault();
    
    const form = document.getElementById('addEndpointForm');
    const systemId = document.getElementById('endpointSystemId').value;
    
    if (!systemId) {
        showNotification('error', 'System ID is required');
        return;
    }

    const formData = new FormData(form);
    
    // Convert FormData to a plain object
    const data = {
        system_id: parseInt(systemId),
        name: formData.get('name'),
        path: formData.get('path'),
        method: formData.get('method'),
        description: formData.get('description') || '',
        is_active: formData.get('is_active') === 'on'
    };

    // Handle JSON fields
    try {
        const parameters = formData.get('parameters');
        data.parameters = parameters && parameters.trim() ? JSON.parse(parameters) : {};
        
        const headers = formData.get('headers');
        data.headers = headers && headers.trim() ? JSON.parse(headers) : {};
    } catch (error) {
        showNotification('error', 'Invalid JSON format in parameters or headers');
        return;
    }
    
    // Validate required fields
    if (!data.name || !data.path || !data.method) {
        showNotification('error', 'Please fill in all required fields');
        return;
    }
    
    console.log('Submitting endpoint data:', data);
    
    fetch('/admin/core-banking/endpoints/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || 'Network response was not ok');
            });
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            showNotification('success', 'Endpoint added successfully');
            $('#addEndpointModal').modal('hide');
            location.reload();
        } else {
            throw new Error(result.message || 'Failed to add endpoint');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', error.message || 'An error occurred while adding the endpoint');
    });
}

// Add form submit event listener
document.getElementById('addEndpointForm').addEventListener('submit', submitAddEndpoint);
</script>
{% endblock %}
