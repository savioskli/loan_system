{% extends "base.html" %}
{% block title %}Modules Management{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-semibold text-gray-900">Modules Management</h1>
            <button onclick="openCreateModal()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                Create Module
            </button>
        </div>

        <!-- Modules Table -->
        <div class="overflow-x-auto bg-white shadow-md rounded-lg">
            <table id="modulesTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sort</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Module Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Module</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% macro render_modules(modules, level=0) %}
                        {% for item in modules %}
                            <tr class="hover:bg-gray-50" data-id="{{ item.module.id }}" data-parent-id="{{ item.module.parent_id }}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="handle cursor-move text-gray-500 hover:text-gray-700">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9h8M8 15h8" />
                                        </svg>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900">{{ 'â€”' * level }} {{ item.module.name }}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">{{ item.module.description }}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-blue-600 hover:text-blue-800">
                                        <a href="{{ item.module.url }}" target="_blank">{{ item.module.url }}</a>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">{{ item.module.parent.name if item.module.parent else '-' }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="text-indigo-600 hover:text-indigo-900 mr-2" onclick="openEditModal({{ item.module.id }})">Edit</button>
                                    <button class="text-red-600 hover:text-red-900 mr-2" onclick="deleteModule({{ item.module.id }})">Delete</button>
                                    <button class="text-yellow-600 hover:text-yellow-900" onclick="toggleHideModule({{ item.module.id }}, {{ 'true' if item.module.hidden else 'false' }})">
                                        {{ 'Unhide' if item.module.hidden else 'Hide' }}
                                    </button>
                                </td>
                            </tr>
                            {{ render_modules(item.children, level + 1) }}
                        {% endfor %}
                    {% endmacro %}
                    {{ render_modules(hierarchical_modules) }}
                </tbody>
            </table>
        </div>

        <!-- Create Module Modal -->
        <div id="createModuleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Create New Module</h2>
                    <button onclick="closeCreateModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form action="{{ url_for('post_disbursement_modules.create_module') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-4">
                        <label for="create_name" class="block text-gray-700 text-sm font-bold mb-2">Module Name:</label>
                        <input type="text" id="create_name" name="name" required
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label for="create_description" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                        <textarea id="create_description" name="description" rows="3"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="create_url" class="block text-gray-700 text-sm font-bold mb-2">URL:</label>
                        <input type="text" id="create_url" name="url" required
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-6">
                        <label for="create_parent_id" class="block text-gray-700 text-sm font-bold mb-2">Parent Module:</label>
                        <select id="create_parent_id" name="parent_id"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">None</option>
                            {% for module in parent_modules %}
                            <option value="{{ module.id }}">{{ module.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex items-center justify-end space-x-4">
                        <button type="button" onclick="closeCreateModal()"
                                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Create Module
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Module Modal -->
        <div id="editModuleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Edit Module</h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="editModuleForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="edit_module_id" name="module_id">
                    <div class="mb-4">
                        <label for="edit_name" class="block text-gray-700 text-sm font-bold mb-2">Module Name:</label>
                        <input type="text" id="edit_name" name="name" required
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label for="edit_description" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                        <textarea id="edit_description" name="description" rows="3"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="edit_url" class="block text-gray-700 text-sm font-bold mb-2">URL:</label>
                        <input type="text" id="edit_url" name="url" required
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-6">
                        <label for="edit_parent_id" class="block text-gray-700 text-sm font-bold mb-2">Parent Module:</label>
                        <select id="edit_parent_id" name="parent_id"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">None</option>
                            {% for module in parent_modules %}
                            <option value="{{ module.id }}">{{ module.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex items-center justify-end space-x-4">
                        <button type="button" onclick="closeEditModal()"
                                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tableBody = document.querySelector('#modulesTable tbody');

    const sortableOptions = {
        animation: 150,
        handle: '.handle',
        ghostClass: 'bg-gray-100',
        dragClass: 'bg-gray-200',
        onStart: function (evt) {
            document.body.style.cursor = 'grabbing';
        },
        onEnd: function (evt) {
            document.body.style.cursor = 'default';
            const newOrder = Array.from(tableBody.querySelectorAll('tr')).map(row => ({
                id: row.getAttribute('data-id'),
                parent_id: row.getAttribute('data-parent-id') || null
            }));
            saveOrder(newOrder);
        }
    };

    Sortable.create(tableBody, sortableOptions);
});

function saveOrder(order) {
    fetch('{{ url_for("post_disbursement_modules.reorder_modules") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ order: order })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Order saved successfully');
        } else {
            alert('Failed to save order: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving order:', error);
        alert('Failed to save order. Please try again.');
    });
}

function openCreateModal() {
    document.getElementById('createModuleModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    // Reset form
    document.getElementById('create_name').value = '';
    document.getElementById('create_description').value = '';
    document.getElementById('create_url').value = '';
    document.getElementById('create_parent_id').value = '';
}

function closeCreateModal() {
    document.getElementById('createModuleModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function openEditModal(moduleId) {
    fetch(`/admin/modules/${moduleId}/edit`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('edit_module_id').value = data.id;
        document.getElementById('edit_name').value = data.name;
        document.getElementById('edit_description').value = data.description;
        document.getElementById('edit_url').value = data.url;
        document.getElementById('edit_parent_id').value = data.parent_id || '';
        document.getElementById('editModuleModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    })
    .catch(error => {
        console.error('Error fetching module data:', error);
        alert('Failed to load module data. Please try again.');
    });
}

function closeEditModal() {
    document.getElementById('editModuleModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

document.getElementById('editModuleForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const moduleId = document.getElementById('edit_module_id').value;

    fetch(`/admin/modules/${moduleId}/edit`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEditModal();
            location.reload();
        } else {
            alert(data.message || 'Failed to update module.');
        }
    })
    .catch(error => {
        console.error('Error updating module:', error);
        alert('Failed to update module. Please try again.');
    });
});

function deleteModule(moduleId) {
    if (confirm('Are you sure you want to delete this module? This action cannot be undone.')) {
        fetch(`/admin/modules/${moduleId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to delete module.');
            }
        })
        .catch(error => {
            console.error('Error deleting module:', error);
            alert('Failed to delete module. Please try again.');
        });
    }
}

function toggleHideModule(moduleId, isHidden) {
    fetch(`/admin/modules/${moduleId}/toggle_hide`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ hidden: !isHidden })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Failed to toggle module visibility.');
        }
    })
    .catch(error => {
        console.error('Error toggling module visibility:', error);
        alert('Failed to toggle module visibility. Please try again.');
    });
}

// Modal event listeners
window.onclick = function(event) {
    const createModal = document.getElementById('createModuleModal');
    const editModal = document.getElementById('editModuleModal');
    if (event.target === createModal) {
        closeCreateModal();
    } else if (event.target === editModal) {
        closeEditModal();
    }
};

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCreateModal();
        closeEditModal();
    }
});

// Form validation and error handling
const forms = document.querySelectorAll('form');
forms.forEach(form => {
    form.addEventListener('submit', function(event) {
        const nameInput = form.querySelector('[name="name"]');
        const urlInput = form.querySelector('[name="url"]');

        if (!nameInput.value.trim()) {
            event.preventDefault();
            alert('Module name is required.');
            nameInput.focus();
            return;
        }


    });
});
</script>
{% endblock %}
