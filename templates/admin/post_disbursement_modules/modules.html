{% extends "base.html" %}
{% block title %}Modules Management{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-semibold text-gray-900">Modules Management</h1>
            <button onclick="openCreateModal()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                Create Module
            </button>
        </div>

        <!-- Modules Table -->
        <div class="overflow-x-auto bg-white shadow-md rounded-lg">
            <table id="modulesTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sort</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Module Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Module</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Selected Tables</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Map Columns</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Define Structure</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">View / Edit Structure</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% macro render_modules(modules, level=0) %}
                        {% for item in modules %}
                            <tr class="hover:bg-gray-50" data-id="{{ item.module.id }}" data-parent-id="{{ item.module.parent_id }}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="handle cursor-move text-gray-500 hover:text-gray-700">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9h8M8 15h8" />
                                        </svg>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900">{{ 'â€”' * level }} {{ item.module.name }}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">{{ item.module.description }}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-blue-600 hover:text-blue-800">
                                        <a href="{{ item.module.url }}" target="_blank">{{ item.module.url }}</a>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">{{ item.module.parent.name if item.module.parent else '-' }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="text-indigo-600 hover:text-indigo-900 mr-2" onclick="openEditModal({{ item.module.id }})">Edit</button>
                                    <button class="text-red-600 hover:text-red-900 mr-2" onclick="deleteModule({{ item.module.id }})">Delete</button>
                                    <button class="text-yellow-600 hover:text-yellow-900" onclick="toggleHideModule({{ item.module.id }}, {{ 'true' if item.module.hidden else 'false' }})">
                                        {{ 'Unhide' if item.module.hidden else 'Hide' }}
                                    </button>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="text-green-600 hover:text-green-900" onclick="openTablesModal({{ item.module.id }})">Select Tables</button>
                                    <div class="mt-2">
                                        {% if item.module.selected_tables %}
                                            <form id="saveTablesForm_{{ item.module.id }}" method="POST">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <input type="hidden" name="module_id" value="{{ item.module.id }}">
                                                <ul>
                                                    {% for table in item.module.selected_tables %}
                                                        <li class="text-sm text-gray-700 flex items-center">
                                                            <input type="checkbox" name="tables" value="{{ table }}" checked> {{ table }}
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                                <button type="submit" class="text-blue-600 hover:text-blue-900 mt-2">Save</button>
                                            </form>
                                        {% else %}
                                            <span class="text-sm text-gray-500">No tables selected</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="text-blue-600 hover:text-blue-900" onclick="openTableMappingModal({{ item.module.id }}, 'CoreBankingSystem')">
                                        Map Columns
                                    </button>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="openExpectedStructureModal({{ item.module.id }})" class="text-green-600 hover:text-green-900">
                                    Define Structure
                                </button>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    {% for expected_structure in item.expected_structures %}
                                    <button class="text-green-600 hover:text-green-900"
                                            onclick="openViewEditExpectedStructureModal({{ item.module.id }}, {{ expected_structure.id }})">
                                        View/Edit Structure
                                    </button>
                                    {% endfor %}
                                </td>
                            </tr>
                            {{ render_modules(item.children, level + 1) }}
                        {% endfor %}
                    {% endmacro %}
                    {{ render_modules(hierarchical_modules) }}
                </tbody>
            </table>
        </div>

        <!-- Create Module Modal -->
        <div id="createModuleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Create New Module</h2>
                    <button onclick="closeCreateModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form action="{{ url_for('post_disbursement_modules.create_module') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-4">
                        <label for="create_name" class="block text-gray-700 text-sm font-bold mb-2">Module Name:</label>
                        <input type="text" id="create_name" name="name" required
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label for="create_description" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                        <textarea id="create_description" name="description" rows="3"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="create_url" class="block text-gray-700 text-sm font-bold mb-2">URL:</label>
                        <input type="text" id="create_url" name="url" required
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-6">
                        <label for="create_parent_id" class="block text-gray-700 text-sm font-bold mb-2">Parent Module:</label>
                        <select id="create_parent_id" name="parent_id"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">None</option>
                            {% for module in parent_modules %}
                            <option value="{{ module.id }}">{{ module.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex items-center justify-end space-x-4">
                        <button type="button" onclick="closeCreateModal()"
                                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Create Module
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Module Modal -->
        <div id="editModuleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Edit Module</h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="editModuleForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="edit_module_id" name="module_id">
                    <div class="mb-4">
                        <label for="edit_name" class="block text-gray-700 text-sm font-bold mb-2">Module Name:</label>
                        <input type="text" id="edit_name" name="name" required
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label for="edit_description" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                        <textarea id="edit_description" name="description" rows="3"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="edit_url" class="block text-gray-700 text-sm font-bold mb-2">URL:</label>
                        <input type="text" id="edit_url" name="url" required
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-6">
                        <label for="edit_parent_id" class="block text-gray-700 text-sm font-bold mb-2">Parent Module:</label>
                        <select id="edit_parent_id" name="parent_id"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">None</option>
                            {% for module in parent_modules %}
                            <option value="{{ module.id }}">{{ module.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex items-center justify-end space-x-4">
                        <button type="button" onclick="closeEditModal()"
                                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tables Modal -->
        <div id="tablesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md modal-container">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Select Tables</h2>
                    <button onclick="closeTablesModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="tablesForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="tables_module_id" name="module_id">
                    <div class="mb-4">
                        <label for="tables_select" class="block text-gray-700 text-sm font-bold mb-2">Select Tables:</label>
                        <select id="tables_select" name="tables" multiple
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <!-- Options will be populated via JavaScript -->
                        </select>
                    </div>
                    <div class="flex items-center justify-end space-x-4">
                        <button type="button" onclick="closeTablesModal()"
                                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Save Tables
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Table Mapping Modal -->
        <div id="tableMappingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-lg modal-container">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Map Table Columns</h2>
                    <button onclick="closeTableMappingModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="tableMappingForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="mapping_module_id" name="module_id">
                    <input type="hidden" id="mapping_table_name" name="table_name">
                    <div class="mb-4">
                        <label for="expected_table" class="block text-gray-700 text-sm font-bold mb-2">Expected Table:</label>
                        <select id="expected_table" name="expected_table"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">Select Expected Table</option>
                            <option value="CoreBankingSystem">CoreBankingSystem</option>
                            <option value="CoreBankingEndpoint">CoreBankingEndpoint</option>
                            <option value="LoanLedgerEntries">LoanLedgerEntries</option>
                            <option value="LoanApplications">LoanApplications</option>
                            <option value="LoanDisbursements">LoanDisbursements</option>
                            <option value="Members">Members</option>
                            <option value="Users">Users</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="expected_columns" class="block text-gray-700 text-sm font-bold mb-2">Expected Columns:</label>
                        <select id="expected_columns" name="expected_columns" multiple
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <!-- Options will be populated via JavaScript based on selected expected table -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="actual_columns" class="block text-gray-700 text-sm font-bold mb-2">Actual Columns:</label>
                        <select id="actual_columns" name="actual_columns" multiple
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <!-- Options will be populated via JavaScript based on selected table -->
                        </select>
                    </div>
                    <div class="flex items-center justify-end space-x-4">
                        <button type="button" onclick="closeTableMappingModal()"
                                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Save Mapping
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Expected Structure Modal -->
        <div id="expectedStructureModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md modal-container">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Define Expected Structure</h2>
                    <button onclick="closeExpectedStructureModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="expectedStructureForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="expected_module_id" name="module_id">
                    <div class="mb-4">
                        <label for="expected_table_name" class="block text-gray-700 text-sm font-bold mb-2">Table Name:</label>
                        <input type="text" id="expected_table_name" name="table_name" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label for="expected_columns" class="block text-gray-700 text-sm font-bold mb-2">List of Columns:</label>
                        <textarea id="expected_columns" name="columns" rows="5" required
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <div class="flex items-center justify-end space-x-4">
                        <button type="button" onclick="closeExpectedStructureModal()"
                                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Save Structure
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- View/Edit Expected Structure Modal -->
        <div id="viewEditExpectedStructureModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md modal-container">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">View/Edit Expected Structure</h2>
                    <button onclick="closeViewEditExpectedStructureModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="viewEditExpectedStructureForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="view_edit_module_id" name="module_id">
                    <input type="hidden" id="view_edit_structure_id" name="structure_id">
                    <div class="mb-4">
                        <label for="view_edit_table_name" class="block text-gray-700 text-sm font-bold mb-2">Table Name:</label>
                        <input type="text" id="view_edit_table_name" name="table_name" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label for="view_edit_columns" class="block text-gray-700 text-sm font-bold mb-2">List of Columns:</label>
                        <textarea id="view_edit_columns" name="columns" rows="5" required
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <div class="flex items-center justify-end space-x-4">
                        <button type="button" onclick="closeViewEditExpectedStructureModal()"
                                class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>



    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tableBody = document.querySelector('#modulesTable tbody');

    const sortableOptions = {
        animation: 150,
        handle: '.handle',
        ghostClass: 'bg-gray-100',
        dragClass: 'bg-gray-200',
        onStart: function (evt) {
            document.body.style.cursor = 'grabbing';
        },
        onEnd: function (evt) {
            document.body.style.cursor = 'default';
            const newOrder = Array.from(tableBody.querySelectorAll('tr')).map(row => ({
                id: row.getAttribute('data-id'),
                parent_id: row.getAttribute('data-parent-id') || null
            }));
            saveOrder(newOrder);
        }
    };

    Sortable.create(tableBody, sortableOptions);
});

function saveOrder(order) {
    fetch('{{ url_for("post_disbursement_modules.reorder_modules") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ order: order })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Order saved successfully');
        } else {
            alert('Failed to save order: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving order:', error);
        alert('Failed to save order. Please try again.');
    });
}

function openCreateModal() {
    document.getElementById('createModuleModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    // Reset form
    document.getElementById('create_name').value = '';
    document.getElementById('create_description').value = '';
    document.getElementById('create_url').value = '';
    document.getElementById('create_parent_id').value = '';
}

function closeCreateModal() {
    document.getElementById('createModuleModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function openEditModal(moduleId) {
    fetch(`/admin/modules/${moduleId}/edit`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('edit_module_id').value = data.id;
        document.getElementById('edit_name').value = data.name;
        document.getElementById('edit_description').value = data.description;
        document.getElementById('edit_url').value = data.url;
        document.getElementById('edit_parent_id').value = data.parent_id || '';
        document.getElementById('editModuleModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    })
    .catch(error => {
        console.error('Error fetching module data:', error);
        alert('Failed to load module data. Please try again.');
    });
}

function closeEditModal() {
    document.getElementById('editModuleModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

document.getElementById('editModuleForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const moduleId = document.getElementById('edit_module_id').value;

    fetch(`/admin/modules/${moduleId}/edit`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEditModal();
            location.reload();
        } else {
            alert(data.message || 'Failed to update module.');
        }
    })
    .catch(error => {
        console.error('Error updating module:', error);
        alert('Failed to update module. Please try again.');
    });
});

function deleteModule(moduleId) {
    if (confirm('Are you sure you want to delete this module? This action cannot be undone.')) {
        fetch(`/admin/modules/${moduleId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to delete module.');
            }
        })
        .catch(error => {
            console.error('Error deleting module:', error);
            alert('Failed to delete module. Please try again.');
        });
    }
}

function toggleHideModule(moduleId, isHidden) {
    fetch(`/admin/modules/${moduleId}/toggle_hide`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ hidden: !isHidden })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Failed to toggle module visibility.');
        }
    })
    .catch(error => {
        console.error('Error toggling module visibility:', error);
        alert('Failed to toggle module visibility. Please try again.');
    });
}

function openTablesModal(moduleId) {
    document.getElementById('tables_module_id').value = moduleId;
    fetch(`/admin/modules/${moduleId}/available-tables`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
    })
    .then(data => {
        if (data.tables && Array.isArray(data.tables)) {
            const select = document.getElementById('tables_select');
            select.innerHTML = '';
            data.tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table;
                option.textContent = table;
                select.appendChild(option);
            });
            document.getElementById('tablesModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        } else {
            alert('No tables available or invalid response format.');
        }
    })
    .catch(error => {
        console.error('Error fetching tables:', error);
        alert('Failed to load tables. Please try again.');
    });
}

function closeTablesModal() {
    document.getElementById('tablesModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

document.getElementById('tablesForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const moduleId = document.getElementById('tables_module_id').value;
    const selectedTables = Array.from(document.querySelectorAll('#tables_select option:checked')).map(option => option.value);

    fetch(`/admin/modules/${moduleId}/tables`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json', // Ensure JSON content type
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ tables: selectedTables }) // Send data as JSON
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeTablesModal();
            location.reload();
        } else {
            alert(data.message || 'Failed to save tables.');
        }
    })
    .catch(error => {
        console.error('Error saving tables:', error);
        alert('Failed to save tables. Please try again.');
    });
});

// Handle saving of selected tables
document.querySelectorAll('form[id^="saveTablesForm_"]').forEach(form => {
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const moduleId = formData.get('module_id');
        // Corrected line: Use form element to query checkboxes within this form
        const selectedTables = Array.from(form.querySelectorAll('input[name="tables"]:checked')).map(input => input.value);

        fetch(`/admin/modules/${moduleId}/tables`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ tables: selectedTables })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to save tables.');
            }
        })
        .catch(error => {
            console.error('Error saving tables:', error);
            alert('Failed to save tables. Please try again.');
        });
    });
});

// Modal event listeners
window.onclick = function(event) {
    const createModal = document.getElementById('createModuleModal');
    const editModal = document.getElementById('editModuleModal');
    const tablesModal = document.getElementById('tablesModal');
    const tableMappingModal = document.getElementById('tableMappingModal');
    if (event.target === createModal) {
        closeCreateModal();
    } else if (event.target === editModal) {
        closeEditModal();
    } else if (event.target === tablesModal) {
        closeTablesModal();
    } else if (event.target === tableMappingModal) {
        closeTableMappingModal();
    }
};

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCreateModal();
        closeEditModal();
        closeTablesModal();
        closeTableMappingModal();
    }
});

// Form validation and error handling
const forms = document.querySelectorAll('form');
forms.forEach(form => {
    form.addEventListener('submit', function(event) {
        const nameInput = form.querySelector('[name="name"]');
        const urlInput = form.querySelector('[name="url"]');

        if (!nameInput.value.trim()) {
            event.preventDefault();
            alert('Module name is required.');
            nameInput.focus();
            return;
        }

        if (!urlInput.value.trim()) {
            event.preventDefault();
            alert('URL is required.');
            urlInput.focus();
            return;
        }

        // Basic URL validation
        try {
            new URL(urlInput.value);
        } catch (e) {
            event.preventDefault();
            alert('Please enter a valid URL (including http:// or https://)');
            urlInput.focus();
            return;
        }
    });
});

function openTableMappingModal(moduleId, tableName) {
    document.getElementById('mapping_module_id').value = moduleId;
    document.getElementById('mapping_table_name').value = tableName;
    document.getElementById('tableMappingModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Populate expected columns based on selected expected table
    const expectedTableSelect = document.getElementById('expected_table');
    const expectedColumnsSelect = document.getElementById('expected_columns');
    expectedColumnsSelect.innerHTML = '';

    expectedTableSelect.addEventListener('change', function() {
        const selectedTable = expectedTableSelect.value;
        let columns = [];

        switch (selectedTable) {
            case 'CoreBankingSystem':
                columns = ['id', 'name', 'is_active', 'base_url', 'port', 'database_name', 'auth_credentials_dict'];
                break;
            case 'CoreBankingEndpoint':
                columns = ['id', 'system_id', 'name', 'is_active', 'parameters'];
                break;
            case 'LoanLedgerEntries':
                columns = ['LoanID', 'LedgerID', 'OutstandingBalance', 'ArrearsAmount', 'ArrearsDays'];
                break;
            case 'LoanApplications':
                columns = ['LoanAppID', 'LoanNo', 'LoanAmount'];
                break;
            case 'LoanDisbursements':
                columns = ['LoanAppID', 'LoanStatus'];
                break;
            case 'Members':
                columns = ['MemberID', 'Name', 'ContactInfo', 'AccountDetails'];
                break;
            case 'Users':
                columns = ['UserID', 'Username', 'PasswordHash', 'Role'];
                break;
            default:
                columns = [];
        }

        expectedColumnsSelect.innerHTML = '';
        columns.forEach(column => {
            const option = document.createElement('option');
            option.value = column;
            option.textContent = column;
            expectedColumnsSelect.appendChild(option);
        });
    });

    // Populate actual columns based on the selected table
    const actualColumnsSelect = document.getElementById('actual_columns');
    actualColumnsSelect.innerHTML = '';

    // Fetch actual columns from the server based on the selected table
    fetch(`/admin/modules/${moduleId}/table-columns?table=${tableName}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
        }
        return response.json();
    })
    .then(data => {
        if (data.columns && Array.isArray(data.columns)) {
            data.columns.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                actualColumnsSelect.appendChild(option);
            });
        } else {
            alert('No columns available or invalid response format.');
        }
    })
    .catch(error => {
        console.error('Error fetching columns:', error);
        alert('Failed to load columns. Please try again.');
    });
}

function closeTableMappingModal() {
    document.getElementById('tableMappingModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

document.getElementById('tableMappingForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const moduleId = document.getElementById('mapping_module_id').value;
    const tableName = document.getElementById('mapping_table_name').value;
    const expectedColumns = Array.from(document.querySelectorAll('#expected_columns option:checked')).map(option => option.value);
    const actualColumns = Array.from(document.querySelectorAll('#actual_columns option:checked')).map(option => option.value);

    fetch(`/admin/modules/${moduleId}/map-columns`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            table_name: tableName,
            expected_columns: expectedColumns,
            actual_columns: actualColumns
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeTableMappingModal();
            location.reload();
        } else {
            alert(data.message || 'Failed to save column mapping.');
        }
    })
    .catch(error => {
        console.error('Error saving column mapping:', error);
        alert('Failed to save column mapping. Please try again.');
    });
});

function openExpectedStructureModal(moduleId) {
    document.getElementById('expected_module_id').value = moduleId;
    document.getElementById('expectedStructureModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeExpectedStructureModal() {
    document.getElementById('expectedStructureModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

document.getElementById('expectedStructureForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const moduleId = document.getElementById('expected_module_id').value;

    fetch(`/admin/modules/${moduleId}/expected-structure`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeExpectedStructureModal();
            location.reload();
        } else {
            alert(data.message || 'Failed to save expected structure.');
        }
    })
    .catch(error => {
        console.error('Error saving expected structure:', error);
        alert('Failed to save expected structure. Please try again.');
    });
});

function openViewEditExpectedStructureModal(moduleId, structureId) {
    // Set the module ID and structure ID in the modal
    document.getElementById('view_edit_module_id').value = moduleId;
    document.getElementById('view_edit_structure_id').value = structureId;

    // Show the modal
    document.getElementById('viewEditExpectedStructureModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Fetch the expected structure data via AJAX
    fetch(`/admin/modules/${moduleId}/expected-structure/${structureId}/fetch`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Populate the modal fields with the fetched data
            document.getElementById('view_edit_table_name').value = data.table_name;
            document.getElementById('view_edit_columns').value = data.columns.join(', ');
        } else {
            alert(data.message || 'Failed to fetch expected structure.');
        }
    })
    .catch(error => {
        console.error('Error fetching expected structure:', error);
        alert('Failed to fetch expected structure. Please try again.');
    });
}

function closeViewEditExpectedStructureModal() {
    document.getElementById('viewEditExpectedStructureModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

document.getElementById('viewEditExpectedStructureForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const moduleId = document.getElementById('view_edit_module_id').value;
    const structureId = document.getElementById('view_edit_structure_id').value;

    fetch(`/admin/modules/${moduleId}/expected-structure/${structureId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeViewEditExpectedStructureModal();
            location.reload();
        } else {
            alert(data.message || 'Failed to update expected structure.');
        }
    })
    .catch(error => {
        console.error('Error updating expected structure:', error);
        alert('Failed to update expected structure. Please try again.');
    });
});


</script>
{% endblock %}
