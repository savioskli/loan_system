{% extends "base.html" %}
{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}
{% block content %}
    {% include 'user/post_disbursement_sidebar.html' %}
    
    <div class="p-4 sm:ml-64">
        <div class="sm:flex sm:items-center">
            <div class="sm:flex-auto">
                <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">Auction Process</h1>
                <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Manage and track property auctions for defaulted loans.</p>
            </div>
            <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
                <button type="button" onclick="openNewAuctionModal()" class="inline-flex items-center justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 sm:w-auto">
                    Add New Auction
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-4">
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-yellow-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Pending Auctions</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ pending_auctions }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-check text-green-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Completed Auctions</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ completed_auctions }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-home text-blue-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Properties Listed</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ properties_listed }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-dollar-sign text-green-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Recovery</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">KES {{ "{:,.2f}".format(total_recovery) }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Auction Status</label>
                    <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                        <option>All Status</option>
                        <option>Scheduled</option>
                        <option>In Progress</option>
                        <option>Completed</option>
                        <option>Cancelled</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Property Type</label>
                    <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                        <option>All Types</option>
                        <option>Residential</option>
                        <option>Commercial</option>
                        <option>Industrial</option>
                        <option>Land</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Auction Date</label>
                    <input type="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search</label>
                    <input type="text" placeholder="Search by property or reference" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="mt-8 flex flex-col">
            <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Reference No.</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Property Details</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Property Type</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Reserve Price</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Auction Date</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Status</th>
                                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800">
                                {% for auction in auctions %}
                                <tr>
                                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-900 dark:text-gray-100">AUC-{{ "%04d"|format(auction.id) }}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">{{ auction.property_description }}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">{{ auction.property_type }}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">KES {{ "{:,.2f}".format(auction.reserve_price) }}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">{{ auction.auction_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm">
                                        <span class="inline-flex rounded-full px-2 text-xs font-semibold leading-5 
                                            {% if auction.status == 'Scheduled' %}bg-yellow-100 text-yellow-800
                                            {% elif auction.status == 'Completed' %}bg-green-100 text-green-800
                                            {% elif auction.status == 'Cancelled' %}bg-red-100 text-red-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ auction.status }}
                                        </span>
                                    </td>
                                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                        <div class="flex space-x-2">
                                            <button onclick="viewAuctionDetails({{ auction.id }})" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-primary bg-primary-50 hover:bg-primary-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                                <svg class="-ml-0.5 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                                View
                                            </button>
                                            <button onclick="viewAuctionHistory({{ auction.id }})" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-purple-700 bg-purple-50 hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                                                <svg class="-ml-0.5 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                                                History
                                            </button>
                                            <button onclick="openAddAuctionUpdateModal({{ auction.id }})" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-teal-700 bg-teal-50 hover:bg-teal-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                                                <svg class="-ml-0.5 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                                Add Update
                                            </button>
                                            <button onclick="openEditAuctionModal({{ auction.id }})" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-green-700 bg-green-50 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                                <svg class="-ml-0.5 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                                Edit
                                            </button>
                                            <button onclick="confirmDeleteAuction({{ auction.id }})" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                <svg class="-ml-0.5 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                                        No auctions found
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Auction Modal -->    
    <div id="newAuctionModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                <!-- Modal Header -->
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Register New Auction</h3>
                            <p class="text-sm text-gray-500">Create a new auction for a property</p>
                        </div>
                        <button type="button" onclick="closeNewAuctionModal()" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="px-6 py-4">
                    <form id="newAuctionForm" class="wizard-form">
                        <div class="space-y-6">
                            <!-- Wizard Steps Indicator -->
                            <div class="wizard-steps flex mb-6">
                                <div class="step flex-1 text-center py-2 border-b-2 border-gray-200 text-gray-400" data-step="1">1. Customer</div>
                                <div class="step flex-1 text-center py-2 border-b-2 border-gray-200 text-gray-400" data-step="2">2. Property</div>
                                <div class="step flex-1 text-center py-2 border-b-2 border-gray-200 text-gray-400" data-step="3">3. Auction & Docs</div>
                                <div class="step flex-1 text-center py-2 border-b-2 border-gray-200 text-gray-400" data-step="4">4. Staff</div>
                            </div>
                            
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <!-- Hidden fields for raw values -->
                            <input type="hidden" name="raw_outstanding_balance" id="raw_outstanding_balance">
                            <input type="hidden" name="raw_days_in_arrears" id="raw_days_in_arrears">
                            <input type="hidden" name="raw_installment_amount" id="raw_installment_amount">
                            
                            <!-- Hidden fields for names -->
                            <input type="hidden" name="customer_name" id="customer_name">
                            <input type="hidden" name="assigned_staff_name" id="assigned_staff_name">
                            <input type="hidden" name="supervisor_name" id="supervisor_name">
                            
                            <!-- Step 1: Customer & Loan Info -->
                            <div class="wizard-step" data-step="1">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Customer Information</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Customer</label>
                                            <select id="customer_id" name="customer_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                                <option value="">Select Customer</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Loan Account</label>
                                            <select id="loan_id" name="loan_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                                <option value="">Select Loan</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Outstanding Balance</label>
                                            <input type="text" id="outstanding_balance" name="outstanding_balance" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" readonly>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Days in Arrears</label>
                                            <input type="text" id="days_in_arrears" name="days_in_arrears" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" readonly>
                                        </div>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Missed Payments</label>
                                            <input type="text" id="missed_payments" name="missed_payments" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" readonly>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Installment Amount</label>
                                            <input type="text" id="installment_amount" name="installment_amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Property Details -->
                            <div class="wizard-step hidden" data-step="2">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Property Details</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="property_type" class="block text-sm font-medium text-gray-700">Property Type</label>
                                            <select id="property_type" name="property_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                                <option value="">Select Property Type</option>
                                                <option value="Residential">Residential</option>
                                                <option value="Commercial">Commercial</option>
                                                <option value="Industrial">Industrial</option>
                                                <option value="Land">Land</option>
                                                <option value="Movable Property">Movable Property</option>
                                                <option value="Chattels">Chattels</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="property_location" class="block text-sm font-medium text-gray-700">Property Location</label>
                                            <input type="text" id="property_location" name="property_location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label for="property_description" class="block text-sm font-medium text-gray-700">Property Description</label>
                                        <textarea id="property_description" name="property_description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" placeholder="Enter detailed property description..." required></textarea>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="valuation_amount" class="block text-sm font-medium text-gray-700">Valuation Amount (KES)</label>
                                            <input type="number" id="valuation_amount" name="valuation_amount" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                        <div>
                                            <label for="reserve_price" class="block text-sm font-medium text-gray-700">Reserve Price (KES)</label>
                                            <input type="number" id="reserve_price" name="reserve_price" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Auction Details & Attachments -->
                            <div class="wizard-step hidden" data-step="3">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Auction Details</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="auction_date" class="block text-sm font-medium text-gray-700">Auction Date</label>
                                            <input type="datetime-local" id="auction_date" name="auction_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                        <div>
                                            <label for="auction_venue" class="block text-sm font-medium text-gray-700">Auction Venue</label>
                                            <input type="text" id="auction_venue" name="auction_venue" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="auctioneer_name" class="block text-sm font-medium text-gray-700">Auctioneer Name</label>
                                            <input type="text" id="auctioneer_name" name="auctioneer_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                        </div>
                                        <div>
                                            <label for="auctioneer_contact" class="block text-sm font-medium text-gray-700">Auctioneer Contact</label>
                                            <input type="tel" id="auctioneer_contact" name="auctioneer_contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                        </div>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="advertisement_date" class="block text-sm font-medium text-gray-700">Advertisement Date</label>
                                            <input type="date" id="advertisement_date" name="advertisement_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                        </div>
                                        <div>
                                            <label for="advertisement_medium" class="block text-sm font-medium text-gray-700">Advertisement Medium</label>
                                            <input type="text" id="advertisement_medium" name="advertisement_medium" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                                        <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                            <option value="">Select Status</option>
                                            <option value="Scheduled">Scheduled</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                    <div class="mt-4">
                                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                                        <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" placeholder="Enter any additional notes..."></textarea>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Attachments</label>
                                        <div id="dropZone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                            <div class="space-y-1 text-center">
                                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                                <div class="flex text-sm text-gray-600">
                                                    <label for="file-upload" class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-dark focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary">
                                                        <span>Upload a file</span>
                                                        <input id="file-upload" name="file-upload" type="file" class="sr-only" multiple>
                                                    </label>
                                                    <p class="pl-1">or drag and drop</p>
                                                </div>
                                                <p class="text-xs text-gray-500">PNG, JPG, PDF up to 10MB</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 4: Staff Assignment -->
                            <div class="wizard-step hidden" data-step="4">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Staff Assignment</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Assigned Staff</label>
                                            <select id="assigned_staff_id" name="assigned_staff_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                                <option value="">Select Staff</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Supervisor</label>
                                            <select id="supervisor_id" name="supervisor_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                                <option value="">Select Supervisor</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Navigation Buttons -->
                            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                                <button type="button" id="cancelAuctionBtn" onclick="closeNewAuctionModal()" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Cancel
                                </button>
                                <div id="navButtons" class="flex items-center space-x-3">
                                    <button type="button" id="prevBtn" onclick="previousStep()" class="hidden inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Previous
                                    </button>
                                    <button type="button" id="nextBtn" onclick="nextStep()" class="inline-flex justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
                                        Next
                                    </button>
                                    <button type="submit" id="submitBtn" class="hidden inline-flex justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
                                        Create Auction
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewDetailsModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                <div class="px-6 pt-6 pb-4">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Auction Details</h3>
                            <p id="viewAuctionId" class="mt-1 text-sm text-gray-500 dark:text-gray-400"></p>
                        </div>
                        <button type="button" onclick="closeViewDetailsModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                            <span class="sr-only">Close</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-8">
                        <!-- Auction Information -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Auction Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Loan ID</label>
                                    <p id="viewLoanId" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Property Description</label>
                                    <p id="viewPropertyDescription" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Valuation Amount</label>
                                    <p id="viewValuationAmount" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Reserve Price</label>
                                    <p id="viewReservePrice" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Auction Date</label>
                                    <p id="viewAuctionDate" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Auction Venue</label>
                                    <p id="viewAuctionVenue" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Status</label>
                                    <p id="viewStatus" class="mt-1"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Auctioneer Information -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Auctioneer Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Auctioneer Name</label>
                                    <p id="viewAuctioneerName" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Auctioneer Contact</label>
                                    <p id="viewAuctioneerContact" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Advertisement Information -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Advertisement Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Advertisement Date</label>
                                    <p id="viewAdvertisementDate" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Advertisement Medium</label>
                                    <p id="viewAdvertisementMedium" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Notes</h4>
                            <p id="viewNotes" class="mt-1 text-sm text-gray-900 dark:text-gray-100 whitespace-pre-wrap"></p>
                        </div>

                        <!-- Attachments -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Attachments</h4>
                            <div id="viewAttachments" class="grid grid-cols-1 gap-2">
                                <!-- Attachments will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="bg-gray-100 dark:bg-gray-700 px-6 py-4">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeViewDetailsModal()" class="rounded-md border border-gray-300 bg-white dark:bg-gray-700 dark:border-gray-600 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Auction Modal -->
<div id="editAuctionModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
        <div class="inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-3xl">
            <form id="editAuctionForm" class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Edit Auction</h3>
                <input type="hidden" id="edit_auction_id" name="auction_id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Loan ID -->
                    <div>
                        <label for="edit_loan_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Loan ID</label>
                        <input type="text" id="edit_loan_id" name="loan_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    
                    <!-- Client Name -->
                    <div>
                        <label for="edit_client_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Client Name</label>
                        <input type="text" id="edit_client_name" name="client_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    
                    <!-- Property Type -->
                    <div>
                        <label for="edit_property_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Property Type</label>
                        <select id="edit_property_type" name="property_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600" required>
                            <option value="">Select Property Type</option>
                            <option value="Residential">Residential</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Industrial">Industrial</option>
                            <option value="Land">Land</option>
                            <option value="Movable Property">Movable Property</option>
                            <option value="Chattels">Chattels</option>
                        </select>
                    </div>
                    
                    <!-- Property Description -->
                    <div>
                        <label for="edit_property_description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Property Description</label>
                        <input type="text" id="edit_property_description" name="property_description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    
                    <!-- Valuation Amount -->
                    <div>
                        <label for="edit_valuation_amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Valuation Amount</label>
                        <input type="number" id="edit_valuation_amount" name="valuation_amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    
                    <!-- Reserve Price -->
                    <div>
                        <label for="edit_reserve_price" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Reserve Price</label>
                        <input type="number" id="edit_reserve_price" name="reserve_price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    
                    <!-- Auction Date -->
                    <div>
                        <label for="edit_auction_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Auction Date</label>
                        <input type="datetime-local" id="edit_auction_date" name="auction_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    
                    <!-- Auction Venue -->
                    <div>
                        <label for="edit_auction_venue" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Auction Venue</label>
                        <input type="text" id="edit_auction_venue" name="auction_venue" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                    
                    <!-- Auctioneer Name -->
                    <div>
                        <label for="edit_auctioneer_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Auctioneer Name</label>
                        <input type="text" id="edit_auctioneer_name" name="auctioneer_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    
                    <!-- Auctioneer Contact -->
                    <div>
                        <label for="edit_auctioneer_contact" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Auctioneer Contact</label>
                        <input type="tel" id="edit_auctioneer_contact" name="auctioneer_contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    
                    <!-- Advertisement Date -->
                    <div>
                        <label for="edit_advertisement_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Advertisement Date</label>
                        <input type="date" id="edit_advertisement_date" name="advertisement_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    
                    <!-- Advertisement Medium -->
                    <div>
                        <label for="edit_advertisement_medium" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Advertisement Medium</label>
                        <input type="text" id="edit_advertisement_medium" name="advertisement_medium" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                </div>

                <!-- Status -->
                <div class="mt-4">
                    <label for="edit_status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                    <select id="edit_status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600" required>
                        <option value="">Select Status</option>
                        <option value="Scheduled">Scheduled</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>

                <!-- Notes -->
                <div class="mt-4">
                    <label for="edit_notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes</label>
                    <textarea id="edit_notes" name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3 dark:bg-gray-700 dark:border-gray-600"></textarea>
                </div>

                <!-- Attachments -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Attachments</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md dark:border-gray-600">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600 dark:text-gray-400">
                                <label class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-dark focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary">
                                    <span>Upload a file</span>
                                    <input type="file" class="sr-only" multiple>
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">PNG, JPG, PDF up to 10MB</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeEditAuctionModal()" class="rounded-md border border-gray-300 bg-white dark:bg-gray-700 dark:border-gray-600 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">Cancel</button>
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">Update Auction</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Add Auction Update Modal -->
    <div id="addAuctionUpdateModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:align-middle">
                <form id="addAuctionUpdateForm" onsubmit="submitAuctionUpdate(event)" class="px-6 pt-5 pb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="update_auction_id" name="auction_id">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Add Auction Update</h3>
                            <button type="button" onclick="closeAddAuctionUpdateModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                <span class="sr-only">Close</span>
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <!-- Action Type -->
                        <div class="mb-4">
                            <label for="auction_action_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Action Type</label>
                            <select id="auction_action_type" name="action_type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 px-4 py-2">
                                <option value="">Select Action Type</option>
                                <option value="Valuation Report Received">Valuation Report Received</option>
                                <option value="Advertisement Placed">Advertisement Placed</option>
                                <option value="Auction Held">Auction Held</option>
                                <option value="Bid Received">Bid Received</option>
                                <option value="Property Sold">Property Sold</option>
                                <option value="Payment Received">Payment Received</option>
                                <option value="Notice Sent">Notice Sent</option>
                                <option value="Legal Action Initiated">Legal Action Initiated</option>
                                <option value="Postponed">Postponed</option>
                                <option value="Cancelled">Cancelled</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Action Date -->
                        <div class="mb-4">
                            <label for="auction_action_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Action Date</label>
                            <input type="datetime-local" id="auction_action_date" name="action_date" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 px-4 py-2">
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            <label for="auction_notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                            <textarea id="auction_notes" name="notes" rows="3"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 px-4 py-2"
                                placeholder="Enter detailed notes about the action..."></textarea>
                        </div>

                        <!-- Status -->
                        <div class="mb-4">
                            <label for="auction_status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                            <select id="auction_status" name="status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600 px-4 py-2">
                                <option value="">Select Status</option>
                                <option value="Scheduled">Scheduled</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>

                        <!-- Attachments -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Attachments</label>
                            <div id="auction_update_drop_zone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md dark:border-gray-600">
                                <div class="space-y-1 text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="flex text-sm text-gray-600 dark:text-gray-300">
                                        <label for="auction_attachments" class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-dark focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary">
                                            <span>Upload files</span>
                                            <input id="auction_attachments" name="attachments" type="file" class="sr-only" multiple>
                                        </label>
                                        <p class="pl-1 text-gray-500 dark:text-gray-400">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">PDF, DOC, DOCX, JPG, PNG up to 10MB each</p>
                                </div>
                            </div>
                            <div id="auction_update_file_list" class="mt-2 space-y-2"></div> <!-- To display selected files -->
                        </div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 px-6 py-3 sm:flex sm:flex-row-reverse mt-6 -mx-6 -mb-4 rounded-b-lg">
                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm">
                            Save Update
                        </button>
                        <button type="button" onclick="closeAddAuctionUpdateModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 dark:hover:bg-gray-500">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    function openEditAuctionModal(auctionId) {
    fetch(`/user/auction/${auctionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }
            // Populate form fields
            document.getElementById('edit_auction_id').value = data.id;
            document.getElementById('edit_loan_id').value = data.loan_id;
            document.getElementById('edit_client_name').value = data.client_name;
            document.getElementById('edit_property_type').value = data.property_type;
            document.getElementById('edit_property_description').value = data.property_description;
            document.getElementById('edit_valuation_amount').value = data.valuation_amount;
            document.getElementById('edit_reserve_price').value = data.reserve_price;
            // Format dates
            const auctionDate = new Date(data.auction_date);
            document.getElementById('edit_auction_date').value = auctionDate.toISOString().slice(0,16);
            document.getElementById('edit_auction_venue').value = data.auction_venue;
            document.getElementById('edit_auctioneer_name').value = data.auctioneer_name || '';
            document.getElementById('edit_auctioneer_contact').value = data.auctioneer_contact || '';
            if (data.advertisement_date) {
                const adDate = new Date(data.advertisement_date);
                document.getElementById('edit_advertisement_date').value = adDate.toISOString().split('T')[0];
            }
            document.getElementById('edit_advertisement_medium').value = data.advertisement_medium || '';
            document.getElementById('edit_status').value = data.status;
            document.getElementById('edit_notes').value = data.notes || '';
            // Show modal
            document.getElementById('editAuctionModal').classList.remove('hidden');
        })
        .catch(error => {
            showToast('error', 'Error loading auction data');
        });
}

function closeEditAuctionModal() {
    document.getElementById('editAuctionModal').classList.add('hidden');
}

// Handle form submission
document.getElementById('editAuctionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const auctionId = document.getElementById('edit_auction_id').value;
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    // Convert number fields
    data.valuation_amount = parseFloat(data.valuation_amount);
    data.reserve_price = parseFloat(data.reserve_price);
    
    fetch(`/user/update_auction/${auctionId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) throw new Error(data.error);
        showToast('success', 'Auction updated successfully');
        closeEditAuctionModal();
        window.location.reload();
    })
    .catch(error => {
        showToast('error', error.message || 'Failed to update auction');
    });
});
</script>

    <!-- Modal JavaScript -->
    <script>
let auctionUpdateFiles = []; // To store files for the auction update modal

function openAddAuctionUpdateModal(auctionId) {
    document.getElementById('add_auction_update_auction_id').value = auctionId;
    // Reset form fields if needed (optional, could be done on close)
    document.getElementById('addAuctionUpdateForm').reset();
    auctionUpdateFiles = [];
    updateAuctionUpdateFileList();
    document.getElementById('addAuctionUpdateModal').classList.remove('hidden');
}

function closeAddAuctionUpdateModal() {
    document.getElementById('addAuctionUpdateModal').classList.add('hidden');
    document.getElementById('addAuctionUpdateForm').reset();
    auctionUpdateFiles = [];
    updateAuctionUpdateFileList();
}

async function submitAuctionUpdate(event) {
    event.preventDefault();
    const form = event.target;
    const auctionId = document.getElementById('add_auction_update_auction_id').value;
    const formData = new FormData();

    formData.append('action_type', form.auction_action_type.value);
    formData.append('action_date', form.auction_action_date.value);
    formData.append('notes', form.auction_notes.value);
    formData.append('status', form.auction_status.value);
    
    // Append files
    auctionUpdateFiles.forEach(file => {
        formData.append('attachments', file);
    });

    // CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    try {
        const response = await fetch(`/user/auction/${auctionId}/add_update`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
                // 'Content-Type': 'multipart/form-data' is automatically set by browser for FormData
            },
            body: formData
        });
        const result = await response.json();
        if (response.ok) {
            showToast('success', result.message || 'Auction update added successfully.');
            closeAddAuctionUpdateModal();
            if (typeof fetchAuctionHistory === 'function') { // Check if fetchAuctionHistory exists
                fetchAuctionHistory(auctionId); // Refresh history if function is available
            } else {
                // Fallback or simple reload if the specific history refresh isn't available
                // This might be too disruptive if the user is on a specific part of the page.
                // Consider if a more targeted update is needed or if fetchAuctionHistory should be guaranteed.
                console.warn('fetchAuctionHistory function not found. Consider implementing it for a smoother UX.');
                // window.location.reload(); // Example: full page reload as a fallback
            }
            // Potentially, directly add the new history item to the DOM if fetchAuctionHistory isn't used
        } else {
            showToast('error', result.error || 'Failed to add auction update.');
        }
    } catch (error) {
        console.error('Error submitting auction update:', error);
        showToast('error', 'An error occurred while submitting the update.');
    }
}

// File handling for Auction Update Modal Attachments
document.addEventListener('DOMContentLoaded', () => {
    const auctionDropZone = document.getElementById('auction_update_drop_zone');
    const auctionFileInput = document.getElementById('auction_attachments');
    const auctionFileListDiv = document.getElementById('auction_update_file_list');

    if (auctionDropZone && auctionFileInput && auctionFileListDiv) {
        auctionDropZone.addEventListener('click', () => auctionFileInput.click());

        auctionDropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            auctionDropZone.classList.add('border-primary', 'bg-gray-50', 'dark:bg-gray-700');
        });

        auctionDropZone.addEventListener('dragleave', () => {
            auctionDropZone.classList.remove('border-primary', 'bg-gray-50', 'dark:bg-gray-700');
        });

        auctionDropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            auctionDropZone.classList.remove('border-primary', 'bg-gray-50', 'dark:bg-gray-700');
            const files = event.dataTransfer.files;
            handleAuctionUpdateFiles(files);
        });

        auctionFileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            handleAuctionUpdateFiles(files);
        });
    }
});

function handleAuctionUpdateFiles(files) {
    for (const file of files) {
        if (auctionUpdateFiles.length < 5) { // Limit number of files if desired
            if (file.size <= 10 * 1024 * 1024) { // 10MB limit
                auctionUpdateFiles.push(file);
            } else {
                showToast('error', `File ${file.name} is too large (max 10MB).`);
            }
        } else {
            showToast('error', 'Maximum 5 files allowed.');
            break;
        }
    }
    updateAuctionUpdateFileList();
}

function updateAuctionUpdateFileList() {
    const fileListDiv = document.getElementById('auction_update_file_list');
    if (!fileListDiv) return;
    fileListDiv.innerHTML = ''; // Clear existing list

    auctionUpdateFiles.forEach((file, index) => {
        const fileElement = document.createElement('div');
        fileElement.className = 'flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded-md text-sm';
        fileElement.innerHTML = `
            <span class="text-gray-700 dark:text-gray-300 truncate">${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
            <button type="button" onclick="removeAuctionUpdateFile(${index})" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-600">
                <i class="fas fa-times-circle"></i>
            </button>
        `;
        fileListDiv.appendChild(fileElement);
    });
}

function removeAuctionUpdateFile(index) {
    auctionUpdateFiles.splice(index, 1);
    updateAuctionUpdateFileList();
}


        function viewAuctionDetails(auctionId) {
            fetch(`/user/auction/${auctionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast('error', data.error);
                        return;
                    }

                    // Set auction details
                    document.getElementById('viewAuctionId').textContent = `AUC-${String(data.id).padStart(4, '0')}`;
                    document.getElementById('viewLoanId').textContent = data.loan_id;
                    document.getElementById('viewPropertyDescription').textContent = data.property_description;
                    document.getElementById('viewValuationAmount').textContent = formatCurrency(data.valuation_amount);
                    document.getElementById('viewReservePrice').textContent = formatCurrency(data.reserve_price);
                    document.getElementById('viewAuctionDate').textContent = formatDate(data.auction_date);
                    document.getElementById('viewAuctionVenue').textContent = data.auction_venue;
                    document.getElementById('viewAuctioneerName').textContent = data.auctioneer_name || 'N/A';
                    document.getElementById('viewAuctioneerContact').textContent = data.auctioneer_contact || 'N/A';
                    document.getElementById('viewAdvertisementDate').textContent = data.advertisement_date ? formatDate(data.advertisement_date) : 'N/A';
                    document.getElementById('viewAdvertisementMedium').textContent = data.advertisement_medium || 'N/A';
                    document.getElementById('viewNotes').textContent = data.notes || 'No notes available';

                    // Set status with appropriate styling
                    const statusElement = document.getElementById('viewStatus');
                    statusElement.innerHTML = `<span class="inline-flex rounded-full px-2 text-xs font-semibold leading-5 ${getStatusClass(data.status)}">${data.status}</span>`;

                    // Display attachments
                    const attachmentsContainer = document.getElementById('viewAttachments');
                    attachmentsContainer.innerHTML = '';
                    if (data.attachments && data.attachments.length > 0) {
                        data.attachments.forEach(attachment => {
                            const attachmentElement = document.createElement('div');
                            attachmentElement.className = 'flex items-center space-x-2';
                            attachmentElement.innerHTML = `
                                <a href="${attachment.file_path}" target="_blank" class="text-primary hover:text-primary-dark">
                                    <i class="fas fa-file-alt mr-2"></i>${attachment.file_name}
                                </a>
                            `;
                            attachmentsContainer.appendChild(attachmentElement);
                        });
                    } else {
                        attachmentsContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No attachments available</p>';
                    }

                    // Show modal
                    document.getElementById('viewDetailsModal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'An error occurred while fetching auction details');
                });
        }

        function closeViewDetailsModal() {
            document.getElementById('viewDetailsModal').classList.add('hidden');
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Scheduled':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Completed':
                    return 'bg-green-100 text-green-800';
                case 'Cancelled':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatCurrency(amount) {
            if (!amount) return 'KES 0.00';
            
            // Convert to number if it's a string
            if (typeof amount === 'string') {
                amount = parseFloat(amount.replace(/[^0-9.-]+/g, ''));
            }
            
            // Format with commas and 2 decimal places using toLocaleString
            return 'KES ' + amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // View auction history
        function viewAuctionHistory(auctionId) {
            fetch(`/user/auction/${auctionId}/history`)
                .then(response => response.json())
                .then(history => {
                    // Create modal content
                    let historyHtml = `
                        <div class="bg-white rounded-lg p-6 max-h-[80vh] overflow-y-auto">
                            <h3 class="text-lg font-semibold mb-4">Auction History</h3>
                            <div class="space-y-4">
                    `;


                    if (history.length > 0) {
                        history.forEach(record => {
                            historyHtml += `
                                <div class="border-l-4 border-blue-500 pl-4 py-2">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-medium">${record.action}</p>
                                            <p class="text-sm text-gray-600">${record.description}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm font-medium">${record.staff ? record.staff.full_name : 'System'}</p>
                                            <p class="text-xs text-gray-500">${new Date(record.created_at).toLocaleString()}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        historyHtml += `
                            <div class="text-center py-4">
                                <p class="text-gray-500">No history available for this auction</p>
                            </div>
                        `;
                    }

                    historyHtml += `
                            </div>
                        </div>
                    `;

                    // Show modal with history
                    Swal.fire({
                        title: 'Auction History',
                        html: historyHtml,
                        showCloseButton: true,
                        showConfirmButton: false,
                        width: '600px',
                        padding: '0',
                        customClass: {
                            popup: 'rounded-lg',
                            closeButton: 'top-4 right-4'
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching auction history:', error);
                    showToast('error', 'Failed to load auction history');
                });
        }

        // Confirm auction deletion
        function confirmDeleteAuction(auctionId) {
            Swal.fire({
                title: 'Are you sure?',
                text: 'This will permanently delete the auction and all its history.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteAuction(auctionId);
                }
            });
        }

        // Delete auction
        function deleteAuction(auctionId) {
            fetch(`/user/auction/${auctionId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Failed to delete auction'); });
                }
                return response.json();
            })
            .then(data => {
                showToast('success', 'Auction deleted successfully');
                // Reload the page to update the auction list
                setTimeout(() => window.location.reload(), 1000);
            })
            .catch(error => {
                console.error('Error deleting auction:', error);
                showToast('error', error.message || 'Failed to delete auction');
            });
        }

        function openAddAuctionUpdateModal(auctionId) {
            document.getElementById('update_auction_id').value = auctionId;
            document.getElementById('addAuctionUpdateModal').classList.remove('hidden');
        }

        function closeAddAuctionUpdateModal() {
            document.getElementById('addAuctionUpdateModal').classList.add('hidden');
            document.getElementById('addAuctionUpdateForm').reset(); // Reset form fields
        }

        function submitAuctionUpdate(event) {
            event.preventDefault();
            const form = event.target;
            const auctionId = form.auction_id.value;
            const action = form.action.value;
            const description = form.description.value;

            fetch(`/user/auction/${auctionId}/add_update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': form.csrf_token.value
                },
                body: JSON.stringify({ action, description })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Failed to add update'); });
                }
                return response.json();
            })
            .then(data => {
                showToast('success', data.message || 'Update added successfully');
                closeAddAuctionUpdateModal();
                // Optionally, refresh the auction history or table if needed
                if (typeof viewAuctionHistory === 'function') {
                    // If a viewAuctionHistory function exists and is open, refresh it or re-open it
                    // This is a simple way, might need more sophisticated logic depending on UI
                    // For now, we can just close any open history and let user re-open
                     if (Swal.isVisible()) {
                        Swal.close();
                        viewAuctionHistory(auctionId);
                    }
                }
            })
            .catch(error => {
                console.error('Error adding auction update:', error);
                showToast('error', error.message || 'Failed to add update');
            });
        }
        </script>

    <!-- Modal JavaScript -->
    <script>
        // Toast notification function
        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} transition-opacity duration-300`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function openNewAuctionModal() {
            document.getElementById('newAuctionModal').classList.remove('hidden');
        }

        function closeNewAuctionModal() {
            document.getElementById('newAuctionModal').classList.add('hidden');
        }

        // Handle form submission
        document.getElementById('newAuctionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = new FormData(this);
            
            // Log form data for debugging
            console.log('Submitting auction form data:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            const data = {
                loan_id: formData.get('loan_id'),
                client_name: formData.get('customer_name'), // Use the hidden field with customer name
                property_type: formData.get('property_type'),
                property_description: formData.get('property_description'),
                valuation_amount: parseFloat(formData.get('valuation_amount')),
                reserve_price: parseFloat(formData.get('reserve_price')),
                auction_date: formData.get('auction_date'),
                auction_venue: formData.get('auction_venue'),
                auctioneer_name: formData.get('auctioneer_name'),
                auctioneer_contact: formData.get('auctioneer_contact'),
                advertisement_date: formData.get('advertisement_date'),
                advertisement_medium: formData.get('advertisement_medium'),
                notes: formData.get('notes'),
                // Add staff assignment data
                assigned_staff_id: formData.get('assigned_staff_id'),
                assigned_staff_name: formData.get('assigned_staff_name'),
                supervisor_id: formData.get('supervisor_id'),
                supervisor_name: formData.get('supervisor_name'),
                status: formData.get('status') || 'Scheduled' // Default to Scheduled if not provided
            };
            
            console.log('Processed auction data:', data);

            // Send data to server
            fetch('/user/create_auction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Server error:', data.error);
                    showToast('error', data.error);
                } else {
                    console.log('Success response:', data);
                    showToast('success', 'Auction created successfully');
                    closeNewAuctionModal();
                    // Reload page to show new auction
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Submission error:', error);
                showToast('error', 'An error occurred while creating the auction');
            });
        });

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileUpload = document.getElementById('file-upload');

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            dropZone.classList.add('border-primary');
        }

        function unhighlight(e) {
            dropZone.classList.remove('border-primary');
        }

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            // Handle file upload logic here
            console.log('Files:', files);
        }
    </script>
    
    <!-- Wizard Functionality -->
    <script>
        // Wizard variables
        let currentStep = 1;
        const totalSteps = 4;
        
        // Function to update loan details in the form
        function updateLoanDetailsInForm(loan) {
            // Ensure loan object has all required properties with fallbacks
            const outstandingBalance = loan.outstanding_balance || loan.OutstandingBalance || loan.Balance || 0;
            const daysInArrears = parseInt(loan.days_in_arrears || loan.DaysInArrears || 0);
            const installmentAmount = loan.installment_amount || loan.InstallmentAmount || (outstandingBalance > 0 ? outstandingBalance / 12 : 0);
            
            // Format currency values
            const formattedOutstandingBalance = formatCurrency(outstandingBalance);
            const formattedInstallmentAmount = formatCurrency(installmentAmount);
            
            // Set raw values in hidden fields
            $('#raw_outstanding_balance').val(outstandingBalance);
            $('#raw_days_in_arrears').val(daysInArrears);
            $('#raw_installment_amount').val(installmentAmount);
            
            // Set formatted values in visible fields
            $('#outstanding_balance').val(formattedOutstandingBalance);
            $('#days_in_arrears').val(daysInArrears);
            
            // Calculate missed payments based on days in arrears
            const missedPayments = daysInArrears > 0 ? Math.ceil(daysInArrears / 30) : 0;
            $('#missed_payments').val(missedPayments);
            
            // Set installment amount, using outstanding_balance as fallback if not available
            if (loan.installment_amount || loan.InstallmentAmount) {
                $('#installment_amount').val(formattedInstallmentAmount);
            } else if (outstandingBalance > 0) {
                // Use outstanding_balance as fallback per memory instructions
                $('#installment_amount').val(formattedInstallmentAmount + ' (estimated)');
            } else {
                $('#installment_amount').val('KES 0.00');
            }
            
            console.log('Updated loan details:', {
                outstandingBalance: outstandingBalance,
                daysInArrears: daysInArrears,
                missedPayments: missedPayments,
                installmentAmount: installmentAmount
            });
        }
        
        // Wizard navigation functions
        function updateStepIndicator(step) {
            document.querySelectorAll('.wizard-steps .step').forEach((el, index) => {
                el.classList.toggle('border-primary', index < step);
                el.classList.toggle('text-primary', index < step);
            });
        }
        
        function validateStep(step) {
            const inputs = document.querySelectorAll(`.wizard-step[data-step="${step}"] [required]`);
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('border-red-500');
                } else {
                    input.classList.remove('border-red-500');
                }
            });
            
            return isValid;
        }
        
        function nextStep() {
            if (validateStep(currentStep)) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    updateStepDisplay();
                }
            } else {
                showToast('error', 'Please fill in all required fields');
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }
        
        function updateStepDisplay() {
            // Hide all steps
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.add('hidden');
            });
            
            // Show current step
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('hidden');
            
            // Update step indicator
            updateStepIndicator(currentStep);
            
            // Update navigation buttons
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === totalSteps);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== totalSteps);
        }
        
        // Initialize the wizard when the document is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize wizard display
            updateStepDisplay();
            
            // Add event listeners for Select2 initialization
            const openModalBtn = document.querySelector('button[onclick="openNewAuctionModal()"]');
            if (openModalBtn) {
                const originalOpenModal = openNewAuctionModal;
                openNewAuctionModal = function() {
                    originalOpenModal();
                    // Initialize Select2 dropdowns after modal is opened
                    if (typeof $ !== 'undefined') {
                        initializeSelect2Dropdowns();
                    }
                };
            }
        });
        
        // Function to initialize Select2 dropdowns
        function initializeSelect2Dropdowns() {
            if (typeof $ === 'undefined' || typeof $.fn.select2 === 'undefined') {
                console.warn('Select2 not available');
                return;
            }
            
            // Initialize customer dropdown
            $('#customer_id').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#newAuctionModal'),
                width: '100%',
                placeholder: 'Search for a customer...',
                allowClear: true,
                ajax: {
                    url: '/api/customers/search',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            q: params.term || '',
                            page: params.page || 1,
                            per_page: 10
                        };
                    },
                    processResults: function(data) {
                        console.log('Customer data received:', data);
                        
                        if (!data || !Array.isArray(data.items)) {
                            console.error('Invalid customer data format:', data);
                            return { results: [] };
                        }
                        
                        return {
                            results: data.items.map(item => ({
                                id: item.id,
                                text: item.text,
                                loans: item.loans || []
                            })),
                            pagination: {
                                more: data.has_more || false
                            }
                        };
                    },
                    cache: true
                }
            });
            
            // Initialize staff dropdowns
            $('#assigned_staff_id, #supervisor_id').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#newAuctionModal'),
                width: '100%',
                placeholder: 'Search for staff...',
                allowClear: true,
                ajax: {
                    url: '/api/collection-schedules/staff',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            term: params.term || '',
                            page: params.page || 1
                        };
                    },
                    processResults: function(data) {
                        if (!data || !Array.isArray(data)) {
                            return { results: [] };
                        }
                        // Format the staff data for Select2
                        const results = data.map(item => ({
                            id: item.id,
                            text: item.name || `${item.first_name} ${item.last_name}`,
                            position: item.role || item.position,
                            branch: item.branch
                        }));
                        return { results: results };
                    },
                    cache: true
                }
            });
            
            // Update hidden assigned_staff_name when selection changes
            $('#assigned_staff_id').on('select2:select', function(e) {
                const selectedText = e.params.data.text || '';
                $('#assigned_staff_name').val(selectedText);
                console.log('Assigned staff name set to:', selectedText);
            });
            
            // Clear assigned_staff_name when staff is cleared
            $('#assigned_staff_id').on('select2:clear', function() {
                $('#assigned_staff_name').val('');
                console.log('Assigned staff name cleared');
            });
            
            // Update hidden supervisor_name when selection changes
            $('#supervisor_id').on('select2:select', function(e) {
                const selectedText = e.params.data.text || '';
                $('#supervisor_name').val(selectedText);
                console.log('Supervisor name set to:', selectedText);
            });
            
            // Clear supervisor_name when supervisor is cleared
            $('#supervisor_id').on('select2:clear', function() {
                $('#supervisor_name').val('');
                console.log('Supervisor name cleared');
            });
            
            // When customer is selected, populate loans dropdown
            $('#customer_id').on('select2:select', function(e) {
                const customerId = e.params.data.id;
                const customerName = e.params.data.text || '';
                const customerLoans = e.params.data.loans || [];
                
                console.log('Selected customer:', e.params.data);
                
                // Store customer name in hidden field
                $('#customer_name').val(customerName);
                
                // Clear loan dropdown and add placeholder
                $('#loan_id').empty().append('<option value="">Select Loan</option>');
                
                // If customer has loans, populate them directly
                if (customerLoans && customerLoans.length > 0) {
                    console.log('Populating loans from customer data');
                    $('#loan_id').prop('disabled', false);
                    
                    customerLoans.forEach(loan => {
                        // Map the loan properties to a consistent format
                        const loanId = loan.id || loan.LoanAppID;
                        const loanNumber = loan.account_number || loan.LoanNo;
                        const outstandingBalance = loan.outstanding_balance || loan.Balance;
                        const daysInArrears = loan.days_in_arrears || loan.DaysInArrears || 0;
                        
                        console.log('Raw loan data:', loan);
                        
                        // Create a standardized loan object
                        const standardizedLoan = {
                            id: loanId,
                            account_number: loanNumber,
                            outstanding_balance: loan.OutstandingBalance || loan.outstanding_balance || loan.Balance,
                            days_in_arrears: daysInArrears,
                            installment_amount: loan.InstallmentAmount || loan.installment_amount
                        };
                        
                        console.log('Standardized loan data:', standardizedLoan);
                        
                        // Create the option with the loan number as text
                        const option = new Option(loanNumber, loanId, false, false);
                        
                        // Store the standardized loan data with the option
                        $(option).data('loan', standardizedLoan);
                        
                        // Add the option to the dropdown
                        $('#loan_id').append(option);
                    });
                    

                    
                    // Initialize Select2 for loan dropdown
                    $('#loan_id').select2({
                        theme: 'bootstrap-5',
                        dropdownParent: $('#newAuctionModal'),
                        width: '100%',
                        placeholder: 'Select a loan...'
                    });
                    
                    // Trigger the loan selection handler to populate loan details
                    $('#loan_id').on('select2:select', function(e) {
                        const loanId = e.params.data.id;
                        const loanOption = $(this).find('option:selected');
                        const loan = loanOption.data('loan');
                        
                        if (loan) {
                            updateLoanDetailsInForm(loan);
                        } else if (loanId) {
                            // Fetch loan details if not already available
                            $.ajax({
                                url: '/api/loans/' + loanId,
                                type: 'GET',
                                dataType: 'json',
                                success: function(data) {
                                    if (data) {
                                        updateLoanDetailsInForm(data);
                                    } else {
                                        showToast('error', 'No loan details found');
                                    }
                                },
                                error: function(xhr, status, error) {
                                    showToast('error', 'Failed to fetch loan details: ' + error);
                                }
                            });
                        }
                    });
                } else {
                    // If no loans in customer data, try to fetch them from API
                    console.log('Fetching loans from API for customer:', customerId);
                    $.ajax({
                        url: '/api/customers/' + customerId + '/loans',
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            if (data && data.length > 0) {
                                $('#loan_id').prop('disabled', false);
                                
                                // Add each loan as an option
                                data.forEach(function(loan) {
                                    console.log('API loan data:', loan);
                                    
                                    // Standardize the loan data format
                                    const standardizedLoan = {
                                        id: loan.id || loan.LoanAppID,
                                        account_number: loan.loan_no || loan.account_number || loan.LoanNo,
                                        outstanding_balance: loan.OutstandingBalance || loan.outstanding_balance || loan.Balance,
                                        days_in_arrears: loan.days_in_arrears || loan.DaysInArrears || 0,
                                        installment_amount: loan.InstallmentAmount || loan.installment_amount
                                    };
                                    
                                    console.log('API standardized loan data:', standardizedLoan);
                                    
                                    // Create the option with the loan number as text
                                    const option = new Option(standardizedLoan.account_number, standardizedLoan.id, false, false);
                                    
                                    // Store the standardized loan data with the option
                                    $(option).data('loan', standardizedLoan);
                                    
                                    // Add the option to the dropdown
                                    $('#loan_id').append(option);
                                });
                                
                                // Initialize Select2 for loan dropdown
                                $('#loan_id').select2({
                                    theme: 'bootstrap-5',
                                    dropdownParent: $('#newAuctionModal'),
                                    width: '100%',
                                    placeholder: 'Select a loan...'
                                });
                                
                                // Trigger the loan selection handler to populate loan details
                                $('#loan_id').on('select2:select', function(e) {
                                    const loanId = e.params.data.id;
                                    const loanOption = $(this).find('option:selected');
                                    const loan = loanOption.data('loan');
                                    
                                    if (loan) {
                                        updateLoanDetailsInForm(loan);
                                    } else if (loanId) {
                                        // Fetch loan details if not already available
                                        $.ajax({
                                            url: '/api/loans/' + loanId,
                                            type: 'GET',
                                            dataType: 'json',
                                            success: function(data) {
                                                if (data) {
                                                    updateLoanDetailsInForm(data);
                                                } else {
                                                    showToast('error', 'No loan details found');
                                                }
                                            },
                                            error: function(xhr, status, error) {
                                                showToast('error', 'Failed to fetch loan details: ' + error);
                                            }
                                        });
                                    }
                                });
                            } else {
                                showToast('error', 'No loans found for this customer');
                            }
                        },
                        error: function() {
                            showToast('error', 'Failed to fetch loans');
                        }
                    });
                }
            });
            
            // When loan is selected, populate loan details
            $('#loan_id').on('select2:select', function(e) {
                const loan = e.params.data;
                const loanId = loan.id;
                const loanAccountNo = loan.text || '';
                
                console.log('Selected loan:', loan);
                
                // Update visible fields with loan details
                $(this).val(loanId).trigger('change'); // Set the value and trigger change
                
                // Check if we already have the loan data
                const loanData = $(e.params.data.element).data('loan');
                if (loanData) {
                    console.log('Using cached loan data:', loanData);
                    // Check if the loan data has the required properties
                    if (loanData.outstanding_balance || loanData.OutstandingBalance) {
                        updateLoanDetailsInForm(loanData);
                    } else {
                        // If the loan data doesn't have the required properties, fetch it from the API
                        console.log('Cached loan data missing required properties, fetching from API');
                        $.ajax({
                            url: `/api/loans/${loanId}`,
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                console.log('Loan details received:', data);
                                updateLoanDetailsInForm(data);
                            },
                            error: function(xhr, status, error) {
                                console.error('Error fetching loan details:', error);
                                showToast('error', 'Failed to fetch loan details: ' + error);
                            }
                        });
                    }
                } else {
                    // Otherwise fetch loan details via API
                    console.log('Fetching loan details via API for loan:', loanId);
                    $.ajax({
                        url: `/api/loans/${loanId}`,
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            console.log('Loan details received:', data);
                            // Standardize the loan data format
                            const standardizedData = {
                                id: data.id || data.LoanAppID,
                                account_number: data.account_number || data.LoanNo,
                                outstanding_balance: data.outstanding_balance || data.OutstandingBalance,
                                days_in_arrears: data.days_in_arrears || data.DaysInArrears || 0,
                                installment_amount: data.installment_amount || data.InstallmentAmount
                            };
                            updateLoanDetailsInForm(standardizedData);
                        },
                        error: function(xhr, status, error) {
                            console.error('Error fetching loan details:', error);
                            showToast('error', 'Failed to fetch loan details: ' + error);
                        }
                    });
                }
            });
        }
    </script>
{% endblock %}
