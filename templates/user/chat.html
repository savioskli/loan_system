<style>
   /* iOS-style chat UI with enhanced features */
.chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}

/* Conversation History Modal Styles */
.history-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  justify-content: center;
  align-items: center;
}

.history-modal[style*="display: block"] {
  display: flex !important;
}

.modal-content {
  background-color: white;
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.modal-header {
  background-color: #007AFF;
  color: white;
  padding: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.clear-all-btn {
  background-color: #dc3545;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 5px 10px;
  font-size: 14px;
  cursor: pointer;
  margin-left: 10px;
}

.clear-all-btn:hover {
  background-color: #c82333;
}

.delete-conv-btn {
  background-color: #dc3545;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  margin-left: 8px;
}

.delete-conv-btn:hover {
  background-color: #c82333;
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
}

.modal-body {
  padding: 15px;
  max-height: calc(80vh - 60px);
  overflow-y: auto;
}

.conversation-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.conversation-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-radius: 8px;
  background-color: #f5f5f5;
  transition: background-color 0.2s ease;
}

.conversation-item:hover {
  background-color: #e5e5e5;
}

.current-conversation {
  border-left: 4px solid #007AFF;
}

.conv-info {
  flex: 1;
}

.conv-date {
  font-size: 14px;
  color: #333;
  margin-bottom: 4px;
}

.conv-count {
  font-size: 12px;
  color: #666;
}

.load-conv-btn {
  background-color: #007AFF;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 6px 12px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.load-conv-btn:hover {
  background-color: #0056b3;
}

/* Database badge styles */
.database-badge {
  display: inline-block;
  background-color: #f0f0f0;
  color: #666;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-left: 5px;
  font-weight: normal;
  vertical-align: middle;
  border: 1px solid #ddd;
}

#chatButton {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: #007AFF;
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
  z-index: 999;
  font-size: 24px;
}

#chatButton:hover {
  background-color: #005ecb;
  transform: scale(1.1);
}

#chatContainer {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 320px;
  height: 480px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
  display: none;
  flex-direction: column;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  z-index: 1000;
}

.chat-header {
  background-color: #007AFF;
  color: white;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
}

.chat-header span {
  font-weight: 600;
  font-size: 16px;
}

.chat-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.control-button {
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.control-button:hover {
  background-color: rgba(255, 255, 255, 0.3);
}

#closeChat {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 16px;
}

#chatMessages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 180px);
  min-height: 300px;
  height: 100%;
}

.message {
  max-width: 75%;
  padding: 8px 12px;
  border-radius: 18px;
  font-size: 13px;
  margin-bottom: 8px;
  word-wrap: break-word;
}

.user-message {
  background-color: #007AFF;
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 6px;
}

.bot-message {
  background-color: #E5E5EA;
  color: black;
  align-self: flex-start;
  border-bottom-left-radius: 6px;
}

/* Message type variations */
.error-message {
  background-color: #FFD2D2;
  color: #D00000;
  border-bottom-left-radius: 6px;
}

.warning-message {
  background-color: #FFF4D2;
  color: #B86E00;
  border-bottom-left-radius: 6px;
}

.info-message {
  background-color: #D2F1FF;
  color: #0055B8;
  border-bottom-left-radius: 6px;
}

.chat-input {
  padding: 10px;
  display: flex;
  gap: 6px;
  background: white;
  border-top: 1px solid #E5E5EA;
}

#messageInput {
  flex-grow: 1;
  padding: 8px;
  border: 1px solid #E5E5EA;
  border-radius: 18px;
  font-size: 13px;
  outline: none;
}

#sendMessage {
  padding: 8px 12px;
  background-color: #007AFF;
  color: white;
  border: none;
  border-radius: 18px;
  font-size: 13px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

#sendMessage:hover {
  background-color: #005ecb;
}

/* Notification styles */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 25px;
  border-radius: 4px;
  color: white;
  z-index: 2100;
  animation: slideIn 0.3s ease-out;
}

.notification.success {
  background-color: #28a745;
}

.notification.error {
  background-color: #dc3545;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Loading animation */
.loading {
  color: #666;
  background-color: #E5E5EA;
}

.dot-animation {
  display: inline-block;
  animation: dots 1.5s infinite;
}

@keyframes dots {
  0%, 20% { content: '.'; }
  40% { content: '..'; }
  60%, 100% { content: '...'; }
}

/* SQL message styling - with iOS flair */
.sql-message {
  width: 90%;
  padding: 0;
  overflow: hidden;
  background-color: transparent;
  align-self: flex-start;
  margin-bottom: 12px;
}

.sql-header {
  padding: 8px 12px;
  background-color: #D2D2D7;
  font-weight: 500;
  font-size: 12px;
  color: #333;
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
}

.sql-code {
  margin: 0;
  padding: 10px;
  background-color: #F2F2F7;
  color: #007AFF;
  font-family: "SF Mono", "Menlo", monospace;
  font-size: 12px;
  overflow-x: auto;
  white-space: pre-wrap;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  border: 1px solid #D2D2D7;
  border-top: none;
}

/* Table styling with iOS design */
.table-message {
  width: 90%;
  padding: 0;
  overflow: hidden;
  border-radius: 12px;
  background-color: transparent;
  align-self: flex-start;
  margin-bottom: 12px;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.data-table th {
  background-color: #007AFF;
  color: white;
  padding: 8px;
  text-align: left;
  font-weight: 500;
}

.data-table td {
  padding: 8px;
  border-bottom: 1px solid #E5E5EA;
  color: #333;
}

.data-table tr:nth-child(even) {
  background-color: #F9F9FB;
}

.data-table tr:hover {
  background-color: #F2F2F7;
}

/* Advanced mode toggle with iOS style */
.advanced-toggle {
  font-size: 12px;
  margin-left: 10px;
  display: flex;
  align-items: center;
}

.advanced-toggle label {
  display: flex;
  align-items: center;
  cursor: pointer;
  user-select: none;
  color: rgba(255, 255, 255, 0.9);
}

.advanced-toggle input {
  margin-right: 5px;
}
</style>
<!-- templates/chatbot.html -->
<!-- Enhanced chat UI with database selector -->
<div class="chat-widget">
  <button class="chat-button" id="chatButton"><i class="fas fa-comment-dots"></i></button>
  <div class="chat-container" id="chatContainer">
      <div class="chat-header">
          <span>AI Chat</span>
          <div class="chat-controls">
              <button id="newConversationBtn" class="control-button">New Chat</button>
              <button id="viewHistoryBtn" class="control-button">History</button>
              <div class="advanced-toggle">
                  <label><input type="checkbox" id="advancedMode"> Advanced</label>
              </div>
          </div>
          <button class="close-button" id="closeChat">&times;</button>
      </div>
      
      <!-- Add database selector -->
      <div class="database-selector">
          <label for="databaseSelect">Database focus:</label>
          <select id="databaseSelect">
              <option value="">All Databases</option>
              <option value="sacco_db">Sacco DB</option>
              <option value="loan_system">Loan System</option>
          </select>
          <span class="selector-info" id="selectorInfo">?</span>
      </div>
      
      <div class="chat-messages" id="chatMessages">
          <div class="message bot-message">Hello! How can I help you with your database queries today? You can select a specific database to focus on using the dropdown above.</div>
      </div>
      <div class="chat-input">
          <input type="text" id="messageInput" placeholder="Ask a question about your data...">
          <button id="sendMessage">Send</button>
      </div>
  </div>
</div>

<style>
/* Conversation history modal */
.history-modal {
  display: none;
  position: fixed;
  z-index: 1100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 10% auto;
  width: 80%;
  max-width: 500px;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.modal-header {
  background-color: #007AFF;
  color: white;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.modal-body {
  padding: 16px;
  max-height: 400px;
  overflow-y: auto;
}

.conversation-item {
  padding: 12px;
  border-bottom: 1px solid #E5E5EA;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.conversation-item:hover {
  background-color: #F2F2F7;
}

.current-conversation {
  background-color: #E1F0FF;
}

.conv-info {
  flex: 1;
}

.conv-date {
  font-weight: 500;
  margin-bottom: 4px;
  font-size: 14px;
}

.conv-count {
  font-size: 12px;
  color: #8E8E93;
}

.load-conv-btn {
  background-color: #007AFF;
  color: white;
  border: none;
  border-radius: 12px;
  padding: 6px 12px;
  font-size: 12px;
  cursor: pointer;
}

.load-conv-btn:hover {
  background-color: #005ecb;
}

/* Chat controls */
.chat-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.control-button {
  background-color: rgba(255,255,255,0.2);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 4px 8px;
  font-size: 11px;
  cursor: pointer;
}

.control-button:hover {
  background-color: rgba(255,255,255,0.3);
}

/* Add styles for database selector */
.database-selector {
  padding: 8px 12px;
  background-color: #F2F2F7;
  display: flex;
  align-items: center;
  font-size: 12px;
  border-bottom: 1px solid #E5E5EA;
}

.database-selector label {
  margin-right: 8px;
  color: #555;
  font-weight: 500;
}

.database-selector select {
  padding: 4px 8px;
  border-radius: 12px;
  border: 1px solid #D1D1D6;
  background-color: white;
  font-size: 12px;
  flex-grow: 1;
  max-width: 180px;
  outline: none;
}

.database-selector select:focus {
  border-color: #007AFF;
}

.selector-info {
  display: inline-block;
  width: 16px;
  height: 16px;
  background-color: #007AFF;
  color: white;
  border-radius: 50%;
  text-align: center;
  line-height: 16px;
  margin-left: 8px;
  font-size: 10px;
  cursor: pointer;
}

/* Account Summary Styles */
.account-summary-container {
  background-color: #f8f9fa;
  border-radius: 10px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  margin: 10px 0;
  overflow: hidden;
  width: 100%;
  max-width: 100%;
  font-size: 14px;
  height: 250px;
  max-height: 250px;
  min-height: 250px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}

.summary-header {
  background-color: #007AFF;
  color: white;
  padding: 12px 16px;
}

.summary-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.summary-section {
  border-bottom: 1px solid #e9ecef;
  padding: 0;
  margin: 0;
  max-width: 100%;
}

.summary-section:last-child {
  border-bottom: none;
}

.section-header {
  display: flex;
  align-items: center;
  padding: 6px 12px;
  background-color: #f1f3f5;
}

.section-icon {
  font-size: 18px;
  margin-right: 8px;
}

.section-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 500;
  color: #343a40;
}

.section-content {
  padding: 6px 12px;
  overflow-y: visible;
}

.summary-field {
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
  flex-wrap: wrap;
}

.field-label {
  font-weight: 500;
  color: #495057;
  flex: 1;
  min-width: 120px;
  padding-right: 10px;
}

.field-value {
  color: #212529;
  font-weight: 400;
  text-align: right;
  flex: 1;
  word-break: break-word;
  max-width: 60%;
}

/* Database badge for responses */
.database-badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 10px;
  background-color: #007AFF;
  color: white;
  font-size: 10px;
  margin-left: 6px;
  vertical-align: middle;
}

/* Existing styles remain the same */
</style>

<script>
// Function to clear all chat history
async function clearAllHistory() {
  if (!confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
    return;
  }

  try {
    console.log('Clearing all chat history for user:', currentUserId);
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    const response = await fetch('/user/clear_chat_history', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        user_id: currentUserId
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Server error:', errorText);
      throw new Error('Server returned an error: ' + response.status);
    }

    const data = await response.json();
    console.log('Clear all history response:', data);
    
    // Clear the conversation list
    document.querySelector('.conversation-list').innerHTML = '';
    // Close the modal
    document.getElementById('historyModal').style.display = 'none';
    // Show success message
    showNotification(data.message || 'All chat history cleared successfully', 'success');
  } catch (error) {
    console.error('Error clearing chat history:', error);
    showNotification(error.message || 'Failed to clear chat history', 'error');
  }
}

// Function to clear a specific conversation
async function clearConversationHistory(conversationId) {
  if (!confirm('Are you sure you want to delete this conversation? This cannot be undone.')) {
    return;
  }

  try {
    console.log('Clearing conversation:', conversationId, 'for user:', currentUserId);
    // Get CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    const response = await fetch('/user/clear_chat_history', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        user_id: currentUserId,
        conversation_id: conversationId
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Server error:', errorText);
      throw new Error('Server returned an error: ' + response.status);
    }

    const data = await response.json();
    console.log('Clear conversation response:', data);
    
    // Remove the conversation item from the list
    const item = document.querySelector(`[data-conversation-id="${conversationId}"]`);
    if (item) {
      item.remove();
    }
    // Show success message
    showNotification(data.message || 'Conversation deleted successfully', 'success');
  } catch (error) {
    console.error('Error deleting conversation:', error);
    showNotification(error.message || 'Failed to delete conversation', 'error');
  }
}

// Function to show notifications
function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);

  // Remove notification after 3 seconds
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// Get current user ID from template
const currentUserId = '{{ user_id|default("") }}';

document.addEventListener('DOMContentLoaded', function() {
  if (!currentUserId) {
    console.error('User ID not found');
    return;
  }

  const chatButton = document.getElementById('chatButton');
  const chatContainer = document.getElementById('chatContainer');
  const closeChat = document.getElementById('closeChat');
  const messageInput = document.getElementById('messageInput');
  const sendMessage = document.getElementById('sendMessage');
  const chatMessages = document.getElementById('chatMessages');
  const databaseSelect = document.getElementById('databaseSelect');
  const selectorInfo = document.getElementById('selectorInfo');
  
  // Initialize from localStorage
  if (localStorage.getItem('preferred_database')) {
      databaseSelect.value = localStorage.getItem('preferred_database');
  }
  
  // Database selector info tooltip
  selectorInfo.addEventListener('click', () => {
      addMessage("Database Focus Help: Select 'All Databases' to query across all data, or choose a specific database to focus your queries on that database only.", 'bot', 'info');
  });
  
  // Save database preference
  databaseSelect.addEventListener('change', (e) => {
      localStorage.setItem('preferred_database', e.target.value);
  });

  // Toggle chat window visibility
  chatButton.addEventListener('click', () => {
      chatContainer.style.display = chatContainer.style.display === 'none' || chatContainer.style.display === '' ? 'flex' : 'none';
  });

  // Close chat window
  closeChat.addEventListener('click', () => {
      chatContainer.style.display = 'none';
  });
  
  // Conversation management variables
  let currentConversationId = localStorage.getItem('currentConversationId') || null;
  
  // Conversation management buttons
  const newConversationBtn = document.getElementById('newConversationBtn');
  const viewHistoryBtn = document.getElementById('viewHistoryBtn');
  
  // Add event listeners for conversation management buttons
  if (newConversationBtn) {
      newConversationBtn.addEventListener('click', startNewConversation);
  }
  
  if (viewHistoryBtn) {
      viewHistoryBtn.addEventListener('click', showConversationHistory);
  }
  
  // Initialize a new conversation if needed
  function initializeConversation() {
      if (!currentConversationId) {
          currentConversationId = `conv_${Date.now()}_${Math.floor(Math.random() * 9000) + 1000}`;
          localStorage.setItem('currentConversationId', currentConversationId);
      }
  }
  
  // Start a new conversation
  function startNewConversation() {
      // Generate a new conversation ID
      currentConversationId = `conv_${Date.now()}_${Math.floor(Math.random() * 9000) + 1000}`;
      localStorage.setItem('currentConversationId', currentConversationId);
      
      // Clear chat messages
      chatMessages.innerHTML = '';
      
      // Add welcome message
      addMessage('New conversation started. How can I help you?', 'bot');
      
      console.log('New conversation started with ID:', currentConversationId);
  }
  
  // Load conversation history
  function loadConversationHistory(conversationId) {
      fetch(`/user/chat_history?conversation_id=${conversationId}`)
          .then(response => response.json())
          .then(data => {
              chatMessages.innerHTML = ''; // Clear current messages
              
              // Make sure we have an array of messages
              const messages = Array.isArray(data) ? data : [];
              
              if (messages.length === 0) {
                  // Welcome message for new conversations
                  addMessage('Welcome to the Loan System Chat! How can I help you today?', 'bot');
                  return;
              }
              
              // Display each message in the conversation
              messages.forEach(msg => {
                  addMessage(msg.message, 'user');
                  if (msg.sql_query && msg.sql_query !== 'null') {
                      addSqlMessage(msg.sql_query);
                  }
                  addMessage(msg.response, 'bot');
              });
              
              // Scroll to the bottom
              chatMessages.scrollTop = chatMessages.scrollHeight;
          })
          .catch(error => {
              console.error('Error loading conversation history:', error);
              // Show error message in chat
              addMessage('Error loading conversation history. Please try again.', 'bot', 'error');
          });
  }
  
  // Show conversation history modal
  function showConversationHistory() {
      console.log('Showing conversation history for user ID:', currentUserId);
      
      // Create modal if it doesn't exist
      let historyModal = document.getElementById('historyModal');
      if (!historyModal) {
          historyModal = document.createElement('div');
          historyModal.id = 'historyModal';
          historyModal.className = 'history-modal';
          historyModal.innerHTML = `
            <div class="modal-content">
              <div class="modal-header">
                <h3>Conversation History</h3>
                <div>
                  <button class="clear-all-btn" onclick="clearAllHistory()">Clear All</button>
                  <button class="close-modal" onclick="document.getElementById('historyModal').style.display='none'">&times;</button>
                </div>
              </div>
              <div class="modal-body">
                <div id="conversationList" class="conversation-list"></div>
              </div>
            </div>
          `;
          document.body.appendChild(historyModal);
          
          // Add event listener to close button
          const closeBtn = historyModal.querySelector('.close-modal');
          closeBtn.addEventListener('click', () => {
              historyModal.style.display = 'none';
          });
      }
      
      // Show the modal
      historyModal.style.display = 'block';
      
      // Show loading indicator
      const conversationList = document.getElementById('conversationList');
      conversationList.innerHTML = '<p>Loading conversations...</p>';
      
      // Fetch and display conversation list
      fetch(`/user/chat_history?user_id=${currentUserId}`)
          .then(response => {
              if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
          })
          .then(conversations => {
              console.log('Fetched conversations:', conversations);
              conversationList.innerHTML = '';
              
              if (!Array.isArray(conversations) || conversations.length === 0) {
                  conversationList.innerHTML = '<p>No previous conversations found.</p>';
                  return;
              }
              
              conversations.forEach(conv => {
                  const convItem = document.createElement('div');
                  convItem.className = 'conversation-item';
                  convItem.setAttribute('data-conversation-id', conv.conversation_id);
                  
                  // Format the date
                  let formattedDate = 'Unknown date';
                  try {
                      if (conv.started_at) {
                          const startDate = new Date(conv.started_at);
                          formattedDate = startDate.toLocaleString();
                      }
                  } catch (e) {
                      console.error('Error formatting date:', e);
                  }
                  
                  convItem.innerHTML = `
                    <div class="conv-info">
                      <div class="conv-date">${formattedDate}</div>
                      <div class="conv-count">${conv.message_count || 0} messages</div>
                    </div>
                    <button class="load-conv-btn">Load</button>
                    <button class="delete-conv-btn" onclick="clearConversationHistory('${conv.conversation_id}')">Delete</button>
                  `;
                  
                  // Highlight current conversation
                  if (conv.conversation_id === currentConversationId) {
                      convItem.classList.add('current-conversation');
                  }
                  
                  conversationList.appendChild(convItem);
                  
                  // Add event listener to load button
                  const loadBtn = convItem.querySelector('.load-conv-btn');
                  loadBtn.addEventListener('click', () => {
                      currentConversationId = conv.conversation_id;
                      localStorage.setItem('currentConversationId', currentConversationId);
                      loadConversationHistory(currentConversationId);
                      historyModal.style.display = 'none';
                  });
              });
          })
          .catch(error => {
              console.error('Error fetching conversation history:', error);
              conversationList.innerHTML = `<p class="error">Error loading conversations: ${error.message}</p>`;
          });
  }

  // Function to send user message
  function sendUserMessage() {
      const message = messageInput.value.trim();
      if (message) {
          // Ensure we have a conversation ID
          initializeConversation();
          
          // Get the selected database focus
          const dbFocus = databaseSelect.value;
          
          // Add user message to the chat
          addMessage(message, 'user');
          messageInput.value = '';
          
          // Show loading indicator
          const loadingId = showLoadingMessage();
          
          // Create the request payload
          let requestPayload = { 
              message: message,
              conversation_id: currentConversationId,
              user_id: currentUserId
          };
          
          if (dbFocus) {
              // Add a hint about database preference
              requestPayload.database_hint = dbFocus;
          }
          
          fetch('/user/chat', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token() }}'
              },
              body: JSON.stringify(requestPayload)
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
          })
          .then(data => {
              console.log('API Response:', data);
              
              // Remove loading message
              removeLoadingMessage(loadingId);
              
              // Handle different response types
              if (data.error) {
                  // Handle explicit error field
                  const errorMsg = `Error: ${data.error}`;
                  addMessage(errorMsg, 'bot', 'error');
                  
              } else if (data.type === 'error') {
                  // Handle error type responses
                  addMessage(data.content, 'bot', 'error');
                  
              } else if (data.type === 'message') {
                  // Handle simple message responses
                  addMessage(data.content, 'bot');
                  
              } else if (data.type === 'data_response') {
                  // Handle new data_response format with database info
                  
                  // Add database badge to response if available
                  let responseContent = data.content;
                  if (data.database) {
                      // Format database name for display
                      let displayDbName = data.database;
                      if (data.database === 'sacco_db') {
                          displayDbName = 'SACCO DB';
                      } else if (data.database === 'loan_system') {
                          displayDbName = 'Loan System';
                      }
                      responseContent += ` <span class="database-badge">${displayDbName}</span>`;
                  }
                  
                  // Check if this is an account summary response
                  const isAccountSummary = 
                      data.content.includes('Account Summary') || 
                      data.content.includes('Personal Information') || 
                      data.content.includes('account summary') || 
                      data.content.includes('summary for') || 
                      (data.content.includes('Loan Information') && data.content.includes('Account Details')) || 
                      (data.metadata && data.metadata.is_account_summary) || 
                      (message.toLowerCase().includes('account summary') || message.toLowerCase().includes('summary for'));
                  
                  // Check if we need to parse the content for account summary data
                  if (isAccountSummary) {
                      // Try to extract account summary data from the response
                      try {
                          let summaryData = null;
                          
                          // First try to extract from database results if available
                          if (data.data && data.data.length > 0) {
                              summaryData = extractAccountSummaryData(data.data);
                          }
                          
                          // If that fails, try to extract from the text content
                          if (!summaryData && data.content) {
                              summaryData = extractAccountSummaryData(data.content);
                          }
                          
                          if (summaryData) {
                              // Use the specialized account summary display
                              addAccountSummary(summaryData);
                              
                              // If in advanced mode, still show the SQL and data
                              if (isAdvancedUser()) {
                                  // Show SQL query
                                  if (data.sql) {
                                      addSqlMessage(data.sql);
                                  }
                                  
                                  // Show raw data if available
                                  if (data.data && data.data.length > 0) {
                                      addMessage("Raw data (advanced mode):", 'bot', 'info');
                                      addDataTable(data.data);
                                  }
                              }
                          } else {
                              // Fallback to normal display if extraction fails
                              addMessage(responseContent, 'bot', 'normal', true);
                              
                              // Show data preview for large result sets
                              if (data.data && data.data.length > 0) {
                                  const rowCount = data.row_count.total || data.data.length;
                                  if (rowCount > 3) {
                                      addMessage(`Showing ${Math.min(3, data.data.length)} of ${rowCount} results:`, 'bot', 'info');
                                      addDataTable(data.data.slice(0, 3));
                                  } else {
                                      addDataTable(data.data);
                                  }
                              }
                          }
                      } catch (error) {
                          console.error('Error processing account summary:', error);
                          // Fallback to normal display if extraction fails
                          addMessage(responseContent, 'bot', 'normal', true);
                      }
                  } else {
                      // Standard response handling
                      addMessage(responseContent, 'bot', 'normal', true);
                      
                      // If advanced mode is on, show additional details
                      if (isAdvancedUser()) {
                          // Show SQL query
                          if (data.sql) {
                              addSqlMessage(data.sql);
                          }
                          
                          // Show data preview for large result sets
                          if (data.data && data.data.length > 0) {
                              // Handle both old and new row_count format
                              const rowCount = data.row_count.total || data.row_count || data.data.length;
                              if (rowCount > 3) {
                                  addMessage(`Showing ${Math.min(3, data.data.length)} of ${rowCount} results:`, 'bot', 'info');
                                  addDataTable(data.data.slice(0, 3));
                              } else {
                                  addDataTable(data.data);
                              }
                          }
                      } else if (data.data && data.data.length === 0) {
                          addMessage("No records found in the database.", 'bot', 'info');
                      }
                  }
                  
              } else if (data.type === 'data') {
                  // Handle legacy data format
                  if (Array.isArray(data.content)) {
                      addDataTable(data.content);
                  } else {
                      addMessage(data.content || 'No results found', 'bot');
                  }
                  
              } else if (Array.isArray(data.content)) {
                  // Handle direct array responses
                  addDataTable(data.content);
                  
              } else if (data.content) {
                  // Fallback for any response with content field
                  addMessage(data.content, 'bot');
                  
              } else {
                  // Ultimate fallback for unexpected formats
                  addMessage('I processed your request but received an unexpected response format.', 'bot', 'warning');
              }
          })
          .catch(error => {
              console.error('Error:', error);
              // Remove loading message
              removeLoadingMessage(loadingId);
              // Handle network errors
              addMessage(`Failed to process: "${message}". Please check your connection and try again.`, 'bot', 'error');
          });
      }
  }

  // Function to show loading indicator
  function showLoadingMessage() {
      const loadingId = 'loading-' + Date.now();
      const loadingDiv = document.createElement('div');
      loadingDiv.id = loadingId;
      loadingDiv.classList.add('message', 'bot-message', 'loading');
      loadingDiv.innerHTML = 'Thinking<span class="dot-animation">...</span>';
      chatMessages.appendChild(loadingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return loadingId;
  }

  // Function to remove loading indicator
  function removeLoadingMessage(loadingId) {
      const loadingElement = document.getElementById(loadingId);
      if (loadingElement) {
          loadingElement.remove();
      }
  }

  // Function to check if user has enabled advanced mode
  function isAdvancedUser() {
      return localStorage.getItem('advanced_mode') === 'true';
  }

  // Function to extract account summary data from database results or text content
  function extractAccountSummaryData(data) {
      // Handle both database result objects and text-based summaries
      if (!data) return null;
      
      // Initialize summary object
      const summary = {};
      
      // Helper function to normalize field names
      function normalizeFieldName(name) {
          if (!name) return '';
          
          // Convert to lowercase for consistent matching
          const lowerName = name.toLowerCase();
          
          // Field mapping dictionary
          const fieldMap = {
              'memberid': 'memberId',
              'fullname': 'fullName',
              'phonenumber': 'phoneNumber',
              'accountbalance': 'accountBalance',
              'loanamount': 'loanAmount',
              'applicationdate': 'applicationDate',
              'applicationstatus': 'loanStatus',
              'repaymentperiod': 'repaymentPeriod',
              'interestrate': 'interestRate',
              'disbursedamount': 'disbursedAmount',
              'outstandingbalance': 'outstandingBalance',
              'repaymentduedate': 'nextRepaymentDueDate',
              'arrearsdays': 'daysInArrears'
          };
          
          return fieldMap[lowerName] || lowerName;
      }
      
      // Check if this might be a text-based summary instead of database results
      if (typeof data === 'string' || (data.length === 1 && data[0].content && typeof data[0].content === 'string')) {
          // Extract text content
          const textContent = typeof data === 'string' ? data : data[0].content;
          
          // Parse text-based summary using regex patterns
          // Extract name
          const nameMatch = textContent.match(/(?:summary for|account summary for)\s+([\w\s]+)(?:\:|\*\*|\n)/i);
          if (nameMatch && nameMatch[1]) {
              summary.fullName = nameMatch[1].trim();
          }
          
          // Extract phone number
          const phoneMatch = textContent.match(/phone\s*(?:number)?\s*(?:\:|\-)?\s*([\+\d\s]+)/i);
          if (phoneMatch && phoneMatch[1]) {
              summary.phoneNumber = phoneMatch[1].trim();
          }
          
          // Extract email
          const emailMatch = textContent.match(/email\s*(?:\:|\-)?\s*([\w\.-]+@[\w\.-]+\.[\w]+)/i);
          if (emailMatch && emailMatch[1]) {
              summary.email = emailMatch[1].trim();
          }
          
          // Extract account balance
          const balanceMatch = textContent.match(/(?:account\s*balance|balance)\s*(?:\:|\-)?\s*(?:KES|Ksh)?\s*([\d\,\.]+)/i);
          if (balanceMatch && balanceMatch[1]) {
              summary.accountBalance = balanceMatch[1].trim().replace(/,/g, '');
          }
          
          // Extract shares
          const sharesMatch = textContent.match(/shares\s*(?:\:|\-)?\s*(?:KES|Ksh)?\s*([\d\,\.]+)/i);
          if (sharesMatch && sharesMatch[1]) {
              summary.shares = sharesMatch[1].trim().replace(/,/g, '');
          }
          
          // Extract loan amount
          const loanAmountMatch = textContent.match(/loan\s*amount\s*(?:\:|\-)?\s*(?:KES|Ksh)?\s*([\d\,\.]+)/i);
          if (loanAmountMatch && loanAmountMatch[1]) {
              summary.loanAmount = loanAmountMatch[1].trim().replace(/,/g, '');
          }
          
          // Extract loan status
          const statusMatch = textContent.match(/(?:application\s*status|loan\s*status)\s*(?:\:|\-)?\s*([\w]+)/i);
          if (statusMatch && statusMatch[1]) {
              summary.loanStatus = statusMatch[1].trim();
          }
          
          // Extract application date
          const dateMatch = textContent.match(/(?:application\s*date)\s*(?:\:|\-)?\s*([\w\s\,\.]+\d{4})/i);
          if (dateMatch && dateMatch[1]) {
              summary.applicationDate = dateMatch[1].trim();
          }
          
          // Extract repayment period
          const periodMatch = textContent.match(/repayment\s*period\s*(?:\:|\-)?\s*(\d+)\s*(?:months|month)/i);
          if (periodMatch && periodMatch[1]) {
              summary.repaymentPeriod = periodMatch[1].trim();
          }
          
          // Extract interest rate
          const rateMatch = textContent.match(/interest\s*rate\s*(?:\:|\-)?\s*(\d+(?:\.\d+)?)\s*(?:%|percent)?/i);
          if (rateMatch && rateMatch[1]) {
              summary.interestRate = rateMatch[1].trim();
          }
          
          // Extract disbursed amount
          const disbursedMatch = textContent.match(/disbursed\s*amount\s*(?:\:|\-)?\s*(?:KES|Ksh)?\s*([\d\,\.]+)/i);
          if (disbursedMatch && disbursedMatch[1]) {
              summary.disbursedAmount = disbursedMatch[1].trim().replace(/,/g, '');
          }
          
          // Extract outstanding balance
          const outstandingMatch = textContent.match(/outstanding\s*balance\s*(?:\:|\-)?\s*(?:KES|Ksh)?\s*([\d\,\.]+)/i);
          if (outstandingMatch && outstandingMatch[1]) {
              summary.outstandingBalance = outstandingMatch[1].trim().replace(/,/g, '');
          }
          
          // Extract next payment due date
          const nextPaymentMatch = textContent.match(/(?:next\s*(?:payment|repayment)\s*(?:due\s*)?date)\s*(?:\:|\-)?\s*([\w\s\,\.]+\d{4})/i);
          if (nextPaymentMatch && nextPaymentMatch[1]) {
              summary.nextRepaymentDueDate = nextPaymentMatch[1].trim();
          }
          
          // Extract missed installments
          const missedMatch = textContent.match(/missed\s*installments\s*(?:\:|\-)?\s*(\d+)/i);
          if (missedMatch && missedMatch[1]) {
              summary.missedInstallments = missedMatch[1].trim();
          }
          
          // Return the extracted summary if we found any data
          return Object.keys(summary).length > 0 ? summary : null;
      }
      
      // Process database results
      try {
          // Handle API response format (array of arrays)
          if (Array.isArray(data) && data.length > 0) {
              // Process member data (first array)
              if (data[0] && data[0].length > 0 && data[0][0]) {
                  Object.entries(data[0][0]).forEach(([key, value]) => {
                      if (value === null) return;
                      const fieldName = normalizeFieldName(key);
                      summary[fieldName] = value;
                  });
              }
              
              // Process loan application data (second array)
              if (data[1] && data[1].length > 0 && data[1][0]) {
                  Object.entries(data[1][0]).forEach(([key, value]) => {
                      if (value === null) return;
                      const fieldName = normalizeFieldName(key);
                      summary[fieldName] = value;
                  });
              }
              
              // Process loan ledger data (fourth array)
              if (data[3] && data[3].length > 0 && data[3][0]) {
                  Object.entries(data[3][0]).forEach(([key, value]) => {
                      if (value === null) return;
                      const fieldName = normalizeFieldName(key);
                      summary[fieldName] = value;
                  });
                  
                  // Calculate missed installments based on days in arrears
                  if (data[3][0].ArrearsDays && !summary.missedInstallments) {
                      const daysInArrears = parseInt(data[3][0].ArrearsDays);
                      if (!isNaN(daysInArrears)) {
                          // As per user preference, calculate based on monthly installments
                          const daysPerMonth = 30;
                          const missedMonths = Math.ceil(daysInArrears / daysPerMonth);
                          summary.missedInstallments = missedMonths > 0 ? missedMonths : 0;
                      }
                  }
              }
          }
      } catch (error) {
          console.error('Error processing account summary data:', error);
      }
      
      // If we have a name in parts but not full name, construct it
      if (!summary.fullName && (summary.firstName || summary.lastName)) {
          const nameParts = [];
          if (summary.firstName) nameParts.push(summary.firstName);
          if (summary.middleName) nameParts.push(summary.middleName);
          if (summary.lastName) nameParts.push(summary.lastName);
          if (nameParts.length > 0) {
              summary.fullName = nameParts.join(' ');
          }
      }
      
      // For missed payments, calculate based on the number of missed installments rather than using raw days in arrears
      if (summary.daysInArrears && !summary.missedInstallments) {
          // Estimate missed installments based on days in arrears (assuming monthly installments)
          summary.missedInstallments = Math.ceil(summary.daysInArrears / 30);
      }
      
      // When InstallmentAmount is not available, use OutstandingBalance as a substitute rather than PenaltyAmount
      if (!summary.installmentAmount && summary.outstandingBalance && summary.repaymentPeriod) {
          // Rough estimate of installment amount
          summary.installmentAmount = Math.round(summary.outstandingBalance / summary.repaymentPeriod);
      }
      
      return Object.keys(summary).length > 0 ? summary : null;
  }

  // Function to add normal text messages to the chat window
  function addMessage(text, sender, style = 'normal', allowHTML = false) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
      
      // Add style class if provided
      if (style !== 'normal') {
          messageDiv.classList.add(`${style}-message`);
      }
      
      if (allowHTML) {
          messageDiv.innerHTML = text;
      } else {
          messageDiv.innerHTML = text.replace(/\n/g, '<br>');
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Function to add SQL code in a special format
  function addSqlMessage(sql) {
      const sqlDiv = document.createElement('div');
      sqlDiv.classList.add('sql-message');
      
      const header = document.createElement('div');
      header.classList.add('sql-header');
      header.innerHTML = 'SQL Query:';
      
      const code = document.createElement('pre');
      code.classList.add('sql-code');
      code.innerHTML = sql;
      
      sqlDiv.appendChild(header);
      sqlDiv.appendChild(code);
      chatMessages.appendChild(sqlDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Function to display data in a table format
  function addDataTable(data) {
      if (!data || data.length === 0) return;
      
      const tableDiv = document.createElement('div');
      tableDiv.classList.add('table-message');
      
      const table = document.createElement('table');
      table.classList.add('data-table');
      
      // Create table header
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      
      // Get columns from first row
      const columns = Object.keys(data[0]);
      columns.forEach(column => {
          const th = document.createElement('th');
          th.textContent = column;
          headerRow.appendChild(th);
      });
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement('tbody');
      data.forEach(row => {
          const tr = document.createElement('tr');
          columns.forEach(column => {
              const td = document.createElement('td');
              td.textContent = row[column] !== null ? row[column] : '';
              tr.appendChild(td);
          });
          tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      tableDiv.appendChild(table);
      chatMessages.appendChild(tableDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Function to display account summary in a visually appealing way
  function addAccountSummary(summaryData) {
      if (!summaryData) return;
      
      const summaryDiv = document.createElement('div');
      summaryDiv.classList.add('account-summary-container');
      
      // Create header with customer name
      const header = document.createElement('div');
      header.classList.add('summary-header');
      if (summaryData.fullName) {
          header.innerHTML = `<h3>Account Summary for ${summaryData.fullName}</h3><small style="color: rgba(255,255,255,0.7); display: block; font-size: 11px;">Scroll to see more details</small>`;
      } else {
          header.innerHTML = '<h3>Account Summary</h3><small style="color: rgba(255,255,255,0.7); display: block; font-size: 11px;">Scroll to see more details</small>';
      }
      summaryDiv.appendChild(header);
      
      // Create sections for different parts of the summary
      const sections = [
          {
              title: 'Personal Information',
              icon: 'ðŸ‘¤',
              fields: ['fullName', 'phoneNumber', 'email', 'nationalId', 'membershipDate']
          },
          {
              title: 'Account Details',
              icon: 'ðŸ’°',
              fields: ['accountBalance', 'shares', 'accountStatus']
          },
          {
              title: 'Loan Information',
              icon: 'ðŸ“',
              fields: ['loanAmount', 'loanStatus', 'applicationDate', 'repaymentPeriod', 'interestRate', 'purpose']
          },
          {
              title: 'Loan Ledger',
              icon: 'ðŸ“Š',
              fields: ['disbursedAmount', 'outstandingBalance', 'nextRepaymentDueDate', 'daysInArrears', 'missedInstallments']
          }
      ];
      
      // Field display names mapping (for better formatting)
      const fieldLabels = {
          fullName: 'Full Name',
          phoneNumber: 'Phone Number',
          email: 'Email',
          nationalId: 'National ID',
          membershipDate: 'Membership Date',
          accountBalance: 'Account Balance',
          shares: 'Shares',
          accountStatus: 'Account Status',
          loanAmount: 'Loan Amount',
          loanStatus: 'Loan Status',
          applicationDate: 'Application Date',
          repaymentPeriod: 'Repayment Period',
          interestRate: 'Interest Rate',
          purpose: 'Purpose',
          disbursedAmount: 'Disbursed Amount',
          outstandingBalance: 'Outstanding Balance',
          nextRepaymentDueDate: 'Next Repayment Due Date',
          daysInArrears: 'Days in Arrears',
          missedInstallments: 'Missed Installments'
      };
      
      // Format numbers with commas
      function formatNumber(value) {
          if (typeof value === 'number') {
              return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          }
          return value;
      }
      
      // Create each section if it has data
      sections.forEach(section => {
          // Check if this section has any data
          const hasData = section.fields.some(field => summaryData[field] !== undefined);
          if (!hasData) return;
          
          const sectionDiv = document.createElement('div');
          sectionDiv.classList.add('summary-section');
          
          const sectionHeader = document.createElement('div');
          sectionHeader.classList.add('section-header');
          sectionHeader.innerHTML = `<span class="section-icon">${section.icon}</span> <h4>${section.title}</h4>`;
          sectionDiv.appendChild(sectionHeader);
          
          const sectionContent = document.createElement('div');
          sectionContent.classList.add('section-content');
          
          section.fields.forEach(field => {
              if (summaryData[field] !== undefined) {
                  const fieldDiv = document.createElement('div');
                  fieldDiv.classList.add('summary-field');
                  
                  const label = document.createElement('span');
                  label.classList.add('field-label');
                  label.textContent = fieldLabels[field] || field;
                  
                  const value = document.createElement('span');
                  value.classList.add('field-value');
                  
                  // Format value based on field type
                  let displayValue = summaryData[field];
                  
                  // Format currency fields
                  if (['accountBalance', 'shares', 'loanAmount', 'disbursedAmount', 'outstandingBalance'].includes(field)) {
                      displayValue = formatNumber(displayValue);
                  }
                  
                  // Add 'months' to repaymentPeriod if it's just a number
                  if (field === 'repaymentPeriod' && !isNaN(displayValue)) {
                      displayValue = `${displayValue} months`;
                  }
                  
                  // Add '%' to interestRate if it's just a number
                  if (field === 'interestRate' && !isNaN(displayValue)) {
                      displayValue = `${displayValue}%`;
                  }
                  
                  value.textContent = displayValue;
                  
                  fieldDiv.appendChild(label);
                  fieldDiv.appendChild(value);
                  sectionContent.appendChild(fieldDiv);
              }
          });
          
          sectionDiv.appendChild(sectionContent);
          summaryDiv.appendChild(sectionDiv);
      });
      
      chatMessages.appendChild(summaryDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Event listeners for sending messages
  sendMessage.addEventListener('click', sendUserMessage);
  messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendUserMessage();
  });
  
  // Add toggle for advanced mode in chat header
  const advancedModeCheckbox = document.getElementById('advancedMode');
  if (advancedModeCheckbox) {
      // Set initial state from localStorage
      advancedModeCheckbox.checked = localStorage.getItem('advanced_mode') === 'true';
      
      advancedModeCheckbox.addEventListener('change', (e) => {
          localStorage.setItem('advanced_mode', e.target.checked);
      });
  }
  
  // Initialize conversation and load history when page loads
  initializeConversation();
  if (currentConversationId) {
      loadConversationHistory(currentConversationId);
  } else {
      // Welcome message for new users
      addMessage('Welcome to the Loan System Chat! How can I help you today?', 'bot');
  }
});
</script>
