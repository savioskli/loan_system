{% extends "base.html" %}

{% block title %}{{ module.name }}{% endblock %}

{% block content %}
<div class="container mx-auto max-w-6xl py-5">
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <div class="flex items-center space-x-4 mb-6">
            <div class="bg-primary rounded-full p-3">
                <i class="fas fa-file-alt text-white text-xl"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">{{ module.name }}</h2>
                <p class="text-gray-600 dark:text-gray-300">{{ module.description or 'Fill in the form details below' }}</p>
            </div>
        </div>

        <!-- Dynamic Form Content -->
        <form method="POST" class="space-y-6" id="dynamic-form" enctype="multipart/form-data">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for field in form_fields %}
                <div class="form-group">
                    <label for="{{ field.field_name }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {{ field.field_label }}
                        {% if field.is_required %}
                        <span class="text-red-500">*</span>
                        {% endif %}
                    </label>
                    
                    {% if field.field_type == 'text' %}
                        <input type="text" 
                               id="{{ field.field_name }}" 
                               name="{{ field.field_name }}" 
                               class="form-input block w-full rounded-md border-2 border-gray-300 px-2 py-1.5 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                               {% if field.is_required %}required{% endif %}
                               {% if field.field_placeholder %}placeholder="{{ field.field_placeholder }}"{% endif %}>
                    
                    {% elif field.field_type == 'number' %}
                        <input type="number" 
                               id="{{ field.field_name }}" 
                               name="{{ field.field_name }}" 
                               class="form-input block w-full rounded-md border-2 border-gray-300 px-2 py-1.5 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                               {% if field.is_required %}required{% endif %}
                               {% if field.field_placeholder %}placeholder="{{ field.field_placeholder }}"{% endif %}>
                    
                    {% elif field.field_type == 'textarea' %}
                        <textarea id="{{ field.field_name }}" 
                                  name="{{ field.field_name }}" 
                                  class="form-textarea block w-full rounded-md border-2 border-gray-300 px-2 py-1.5 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                                  rows="4"
                                  {% if field.is_required %}required{% endif %}
                                  {% if field.field_placeholder %}placeholder="{{ field.field_placeholder }}"{% endif %}></textarea>
                    
                    {% elif field.field_type == 'select' %}
                        <select id="{{ field.field_name }}" 
                                name="{{ field.field_name }}" 
                                class="select2 form-select block w-full rounded-md border-2 border-gray-300 px-2 py-1.5 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                                {% if field.is_required %}required{% endif %}>
                            <option value="">Select {{ field.field_label }}</option>
                            {% if field.options %}
                                {% for option in field.options %}
                                    <option value="{{ option.value }}">{{ option.label }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    
                    {% elif field.field_type == 'date' %}
                        <input type="date" 
                               id="{{ field.field_name }}" 
                               name="{{ field.field_name }}" 
                               class="form-input block w-full rounded-md border-2 border-gray-300 px-2 py-1.5 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                               {% if field.is_required %}required{% endif %}>
                    
                    {% elif field.field_type == 'file' %}
                        <input type="file" 
                               id="{{ field.field_name }}" 
                               name="{{ field.field_name }}" 
                               class="form-input block w-full rounded-md border-2 border-gray-300 px-2 py-1.5 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                               {% if field.is_required %}required{% endif %}
                               {% if field.validation_rules and field.validation_rules.accept %}
                               accept="{{ field.validation_rules.accept }}"
                               {% endif %}>
                    {% endif %}
                    
                    {% if field.validation_text %}
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ field.validation_text }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="flex justify-end space-x-4 mt-6">
                <a href="{{ url_for('user.dashboard') }}" 
                   class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-4 py-2 bg-primary border border-transparent rounded-md text-sm font-medium text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    Submit
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
/* Select2 Container Styling */
.select2-container {
    margin-bottom: 1rem;
    width: 100% !important;
}

/* Main Select Box Styling */
.select2-container--default .select2-selection--single {
    height: 48px;
    padding: 10px 16px;
    background-color: white !important;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    transition: all 0.2s ease;
}

/* Hover effect */
.select2-container--default .select2-selection--single:hover {
    border-color: #D1D5DB;
}

/* Focus effect */
.select2-container--default.select2-container--focus .select2-selection--single,
.select2-container--default.select2-container--open .select2-selection--single {
    border-color: #4F46E5;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
}

/* Dropdown Arrow Styling */
.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 46px;
    right: 12px;
}

.select2-container--default .select2-selection--single .select2-selection__arrow b {
    border-color: #6B7280 transparent transparent transparent;
    border-width: 6px 6px 0 6px;
}

/* Text Styling */
.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 28px;
    padding-left: 0;
    color: #374151;
    font-size: 0.95rem;
}

.select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: #9CA3AF;
}

/* Dropdown Styling */
.select2-dropdown {
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    background-color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    margin-top: 4px;
}

/* Search Field Styling */
.select2-container--default .select2-search--dropdown .select2-search__field {
    border: 2px solid #E5E7EB;
    border-radius: 6px;
    padding: 10px 12px;
    margin: 8px;
    width: calc(100% - 16px);
}

.select2-container--default .select2-search--dropdown .select2-search__field:focus {
    outline: none;
    border-color: #4F46E5;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
}

/* Options Styling */
.select2-results__option {
    padding: 12px 16px;
    color: #374151;
    transition: all 0.2s ease;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #4F46E5;
    color: white;
}

.select2-container--default .select2-results__option[aria-selected=true] {
    background-color: #EEF2FF;
    color: #4F46E5;
}

/* Disabled State */
.select2-container--default.select2-container--disabled .select2-selection--single {
    background-color: #F3F4F6 !important;
    cursor: not-allowed;
}
</style>

<script>
$(document).ready(function() {
    // Initialize Select2 on all select elements
    $('.select2').select2({
        width: '100%',
        theme: 'classic',
        placeholder: 'Select an option'
    });

    // Handle county change
    $('#county').on('change', function() {
        var selectedCounty = $(this).val();
        var subCountySelect = $('#sub_county');
        
        // Clear and disable sub-county if no county is selected
        if (!selectedCounty) {
            subCountySelect.empty().append('<option value="">First select a county...</option>');
            subCountySelect.prop('disabled', true).trigger('change');
            return;
        }

        // Fetch sub-counties
        $.ajax({
            url: `/user/get_sub_counties/${encodeURIComponent(selectedCounty)}`,
            method: 'GET',
            success: function(data) {
                subCountySelect.empty().append('<option value="">Select Sub County</option>');
                
                if (Array.isArray(data)) {
                    data.forEach(function(subCounty) {
                        subCountySelect.append(new Option(subCounty, subCounty));
                    });
                    subCountySelect.prop('disabled', false).trigger('change');
                } else {
                    console.error('Invalid data format received:', data);
                    subCountySelect.append('<option value="">Error loading sub-counties</option>');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching sub-counties:', error);
                subCountySelect.empty()
                    .append('<option value="">Error loading sub-counties</option>')
                    .prop('disabled', true)
                    .trigger('change');
            }
        });
    });

    // Initialize sub-county as disabled
    $('#sub_county').prop('disabled', true);

    // Handle form submission
    $('#dynamic-form').on('submit', function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        
        $.ajax({
            url: window.location.href,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    window.location.href = response.redirect;
                } else {
                    alert(response.message || 'Error submitting form');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert('Error submitting form');
            }
        });
    });
});
</script>
{% endblock %}
