{% extends "base.html" %}
{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
    {% include 'user/post_disbursement_sidebar.html' %}
    
    <div class="p-4 sm:ml-64">
        <div class="sm:flex sm:items-center">
            <div class="sm:flex-auto">
                <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">Field Visits</h1>
                <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Schedule and track field visits to borrowers.</p>
            </div>
            {% if error_message %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline">{{ error_message }}</span>
            </div>
            {% endif %}
            <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
                <button type="button" id="openFieldVisitModal" class="inline-flex items-center justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 sm:w-auto">
                    Schedule New Visit
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-4">
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar text-blue-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Scheduled Visits</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ stats.scheduled }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Completed Visits</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ stats.completed }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-yellow-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Pending Reports</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ stats.pending_reports }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-users text-purple-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">In Progress</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ stats.in_progress }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Visit Status</label>
                    <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                        <option>All Status</option>
                        <option>Scheduled</option>
                        <option>In Progress</option>
                        <option>Completed</option>
                        <option>Cancelled</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Field Officer</label>
                    <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                        <option>All Officers</option>
                        <option>John Doe</option>
                        <option>Jane Smith</option>
                        <option>Mike Johnson</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Visit Date</label>
                    <input type="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search</label>
                    <input type="text" placeholder="Search by customer or loan number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="mt-8 flex flex-col">
            <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Visit ID</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Customer Name</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Loan Number</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Field Officer</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Visit Date</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Status</th>
                                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800">
                                {% if field_visits %}
                                    {% for visit in field_visits %}
                                    <tr class="{% if visit.visit_date == today %}bg-blue-50 dark:bg-blue-900{% endif %}">
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-gray-900 dark:text-gray-100">{{ visit.id }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">{{ visit.customer_name }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">{{ visit.loan_account_no }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">{{ visit.field_officer_name }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-300">{{ visit.visit_date.strftime('%Y-%m-%d') }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm">
                                            {% if visit.status == 'scheduled' %}
                                            <span class="inline-flex rounded-full bg-yellow-100 px-2 text-xs font-semibold leading-5 text-yellow-800">Scheduled</span>
                                            {% elif visit.status == 'completed' %}
                                            <span class="inline-flex rounded-full bg-green-100 px-2 text-xs font-semibold leading-5 text-green-800">Completed</span>
                                            {% elif visit.status == 'in_progress' %}
                                            <span class="inline-flex rounded-full bg-blue-100 px-2 text-xs font-semibold leading-5 text-blue-800">In Progress</span>
                                            {% elif visit.status == 'cancelled' %}
                                            <span class="inline-flex rounded-full bg-red-100 px-2 text-xs font-semibold leading-5 text-red-800">Cancelled</span>
                                            {% else %}
                                            <span class="inline-flex rounded-full bg-gray-100 px-2 text-xs font-semibold leading-5 text-gray-800">{{ visit.status|capitalize }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                            <div class="flex justify-end space-x-2">
                                                <button class="view-details-btn bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-full text-xs transition" data-visit-id="{{ visit.id }}" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="update-visit-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-full text-xs transition" data-visit-id="{{ visit.id }}" data-customer-id="{{ visit.customer_id }}" data-customer-name="{{ visit.customer_name }}" title="Edit Field Visit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="py-4 text-center text-sm text-gray-500 dark:text-gray-300">No field visits found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding new field visit -->
    <div id="fieldVisitModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity hidden z-50">
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                    <!-- Modal Header -->
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Schedule New Field Visit</h3>
                                <p class="text-sm text-gray-500">Create a new field visit for a customer</p>
                            </div>
                            <button type="button" id="closeFieldVisitModal" class="text-gray-400 hover:text-gray-500">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Body -->
                    <div class="px-6 py-4">
                        <form id="fieldVisitForm" action="{{ url_for('user.create_field_visit') }}" method="POST" class="space-y-6" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="assigned_branch" id="branchInput" value="{{ branch_id }}">
                            <!-- Hidden fields for raw values -->
                            <input type="hidden" name="raw_outstanding_balance" id="raw_outstanding_balance">
                            <input type="hidden" name="raw_days_in_arrears" id="raw_days_in_arrears">
                            <input type="hidden" name="raw_installment_amount" id="raw_installment_amount">
                            
                            <!-- Hidden fields for customer and loan details -->
                            <input type="hidden" name="customer_name" id="customer_name">
                            <input type="hidden" name="loan_account_no" id="loan_account_no">
                            
                            <!-- Customer Information Section -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Customer Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Customer</label>
                                        <select id="customer_id" name="customer_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="">Select Customer</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Loan Account</label>
                                        <select id="loan_id" name="loan_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="">Select Loan</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Outstanding Balance</label>
                                        <input type="text" id="outstanding_balance" name="outstanding_balance" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Days in Arrears</label>
                                        <input type="text" id="days_in_arrears" name="days_in_arrears" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" readonly>
                                    </div>
                                </div>
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Missed Payments</label>
                                        <input type="text" id="missed_payments" name="missed_payments" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Installment Amount</label>
                                        <input type="text" id="installment_amount" name="installment_amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Visit Details Section -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Visit Details</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Purpose of Visit</label>
                                        <select id="purpose" name="purpose" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="">Select Purpose</option>
                                            <option value="collection">Collection</option>
                                            <option value="verification">Address Verification</option>
                                            <option value="follow_up">Follow-up</option>
                                            <option value="legal">Legal Notice Delivery</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Priority Level</label>
                                        <select id="priority" name="priority" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Visit Date</label>
                                        <input type="date" id="visit_date" name="visit_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Visit Time</label>
                                        <input type="time" id="visit_time" name="visit_time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Assignment Section -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Staff Assignment</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Field Officer</label>
                                        <select id="field_officer_id" name="field_officer_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="">Select Field Officer</option>
                                        </select>
                                        <input type="hidden" id="field_officer_name" name="field_officer_name" value="">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Supervisor</label>
                                        <select id="supervisor_id" name="supervisor_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3">
                                            <option value="">Select Supervisor</option>
                                        </select>
                                        <input type="hidden" id="supervisor_name" name="supervisor_name" value="">
                                    </div>
                                </div>

                            </div>
                            
                            <!-- Additional Information -->
                            <div class="bg-gray-50 p-6 rounded-lg mb-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-4">Additional Information</h4>
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Visit Location</label>
                                        <div class="mt-1">
                                            <input type="text" id="visitLocation" name="location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" placeholder="e.g., Customer's Home, Business Premises" required>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Alternative Contact Person</label>
                                        <div class="mt-1">
                                            <input type="text" id="alternativeContact" name="alternative_contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" placeholder="Name and contact of alternative person">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Visit Notes</label>
                                        <div class="mt-1">
                                            <textarea id="notes" name="notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" placeholder="Important details about the visit" required></textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
                                        <div class="mt-1">
                                            <textarea id="instructions" name="special_instructions" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" placeholder="Any special handling instructions or considerations"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Attachment -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Attachment</label>
                                <div class="mt-1">
                                    <input type="file" id="visitAttachment" name="attachment" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-2">
                                </div>
                            </div>
                            
                            <!-- Modal Footer -->
                            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                                <div class="flex justify-end space-x-3">
                                    <button type="button" id="cancelFieldVisitBtn" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Cancel
                                    </button>
                                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Schedule Visit
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for modal functionality -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Format functions for Select2 dropdowns - defined globally
        function formatCustomer(customer) {
            if (!customer.id) {
                return customer.text;
            }
            
            return $(`
                <div class="d-flex flex-column">
                    <div class="font-weight-bold">${customer.text}</div>
                    ${customer.phone ? `<div class="text-muted small">${customer.phone}</div>` : ''}
                    ${customer.id_number ? `<div class="text-muted small">${customer.id_number}</div>` : ''}
                </div>
            `);
        }
        
        function formatCustomerSelection(customer) {
            return customer.text || 'Select a customer';
        }
        
        function formatLoan(loan) {
            if (!loan.id) {
                return loan.text;
            }
            
            const outstandingBalance = loan.OutstandingBalance ? loan.OutstandingBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
            const daysInArrears = loan.DaysInArrears || 0;
            const missedPayments = Math.ceil(daysInArrears / 30);
            
            return $(`
                <div class="d-flex flex-column">
                    <div class="font-weight-bold">${loan.text}</div>
                    <div class="text-muted small">Outstanding: ${outstandingBalance}</div>
                    <div class="text-muted small">Days in Arrears: ${daysInArrears} (${missedPayments} missed payments)</div>
                </div>
            `);
        }
        
        function formatLoanSelection(loan) {
            return loan.text || 'Select a loan';
        }
        
        // Format functions for staff dropdowns
        function formatStaff(staff) {
            if (!staff.id) {
                return staff.text;
            }
            
            return $(`
                <div class="d-flex flex-column">
                    <div class="font-weight-bold">${staff.text}</div>
                    ${staff.role ? `<div class="text-muted small">${staff.role}</div>` : ''}
                    ${staff.branch ? `<div class="text-muted small">${staff.branch}</div>` : ''}
                </div>
            `);
        }
        
        function formatStaffSelection(staff) {
            return staff.text || 'Select staff';
        }
        
        // Wait for jQuery to be fully loaded
        $(document).ready(function() {
            
            // Flag to track if Select2 has been initialized
            let select2Initialized = false;
            // Helper functions
            function formatCurrency(amount) {
                if (amount === undefined || amount === null) return 'N/A';
                
                // Remove any existing commas and convert to number
                const cleanAmount = parseFloat(String(amount).replace(/,/g, ''));
                if (isNaN(cleanAmount)) return 'N/A';
                
                // Format with commas and 2 decimal places
                return cleanAmount.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
            
            function showLoading() {
                console.log('Loading...');
                // Add loading indicator if needed
            }
            
            function hideLoading() {
                console.log('Loading complete');
                // Remove loading indicator if needed
            }
            
            function showSuccess(message) {
                Swal.fire({
                    title: 'Success!',
                    text: message,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            }
            
            function showError(message) {
                Swal.fire({
                    title: 'Error!',
                    text: message,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
            
            // Modal handling
            const modal = document.getElementById('fieldVisitModal');
            const openModalBtn = document.getElementById('openFieldVisitModal');
            const closeModalBtn = document.getElementById('closeFieldVisitModal');
            const cancelBtn = document.getElementById('cancelFieldVisitBtn');
            
            // Open modal function
            function openModal() {
                modal.classList.remove('hidden');
            }
            
            // Open modal button click handler
            openModalBtn.addEventListener('click', function() {
                openModal();
                // Reset the form
                $('#fieldVisitForm')[0].reset();
                
                // Initialize Select2 only if not already initialized
                if (!select2Initialized) {
                    initializeSelect2Dropdowns();
                    select2Initialized = true;
                } else {
                    // Just clear the selections
                    $('#customer_id, #loan_id, #field_officer_id, #supervisor_id').val(null).trigger('change');
                }
            });
            
            // Close modal
            function closeModal() {
                modal.classList.add('hidden');
            }
            
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });
            // Function to initialize all Select2 dropdowns
            function initializeSelect2Dropdowns() {
                console.log('Initializing Select2 dropdowns');
                
                // Remove any existing select2 containers first
                $('.select2-container').remove();
                
                // Initialize customer select
                $('#customer_id').select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Search for a customer...',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#fieldVisitModal'),
                    ajax: {
                        url: '/api/customers/search',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            return {
                                q: params.term || '',
                                page: params.page || 1,
                                per_page: 10
                            };
                        },
                        processResults: function(data) {
                            console.log('Customer data received:', data);
                            
                            if (!data || !Array.isArray(data.items)) {
                                console.error('Invalid customer data format:', data);
                                return { results: [] };
                            }
                            
                            return {
                                results: data.items.map(item => ({
                                    id: item.id,
                                    text: item.text,
                                    loans: item.loans || []
                                })),
                                pagination: {
                                    more: data.has_more || false
                                }
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0,
                    templateResult: function(customer) {
                        return customer.loading ? 'Loading...' : customer.text;
                    },
                    templateSelection: function(customer) {
                        return customer.text;
                    }
                });
                
                // Initialize loan_id Select2 - this is handled differently as it's populated based on customer selection
                $('#loan_id').select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Select a loan',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#fieldVisitModal')
                });
                
                // Define staff select configuration
                const staffSelect2Config = {
                    theme: 'bootstrap-5',
                    placeholder: 'Select a field officer',
                    allowClear: true,
                    width: '100%',
                    ajax: {
                        url: '/api/collection-schedules/staff',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            console.log('Sending staff search:', params.term);
                            return {
                                term: params.term || '',
                                page: params.page || 1,
                                role_type: 'officer'  // Match collection schedule approach
                            };
                        },
                        processResults: function(data) {
                            console.log('Received staff data:', data);
                            if (!data || !Array.isArray(data)) {
                                console.error('Expected data to be an array:', data);
                                return { results: [] };
                            }
                            // Format the results to match the collection schedule approach
                            return {
                                results: data.map(item => ({
                                    id: item.id,
                                    text: item.name,
                                    role: item.role,
                                    branchId: item.branch_id
                                }))
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0,
                    templateResult: function(officer) {
                        if (officer.loading) return 'Loading...';
                        return officer.text || officer.name;
                    },
                    templateSelection: function(officer) {
                        return officer.text || officer.name;
                    }
                };
                
                // Initialize field_officer_id Select2
                $('#field_officer_id').select2({
                    ...staffSelect2Config,
                    dropdownParent: $('#fieldVisitModal')
                });
                
                // Update hidden field_officer_name when selection changes
                $('#field_officer_id').on('select2:select', function(e) {
                    const selectedText = e.params.data.text || e.params.data.name || '';
                    $('#field_officer_name').val(selectedText);
                });
                
                // Clear field_officer_name when field officer is cleared
                $('#field_officer_id').on('select2:clear', function() {
                    $('#field_officer_name').val('');
                });
                
                // Define supervisor select configuration
                const supervisorSelect2Config = {
                    theme: 'bootstrap-5',
                    placeholder: 'Select a supervisor',
                    allowClear: true,
                    width: '100%',
                    ajax: {
                        url: '/api/collection-schedules/staff',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            console.log('Sending supervisor search:', params.term);
                            return {
                                term: params.term || '',
                                page: params.page || 1,
                                role_type: 'supervisor'  // Match collection schedule approach
                            };
                        },
                        processResults: function(data) {
                            console.log('Received supervisor data:', data);
                            if (!data || !Array.isArray(data)) {
                                console.error('Expected data to be an array:', data);
                                return { results: [] };
                            }
                            // Format the results to match the collection schedule approach
                            return {
                                results: data.map(item => ({
                                    id: item.id,
                                    text: item.name,
                                    role: item.role,
                                    branchId: item.branch_id
                                }))
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0,
                    templateResult: function(supervisor) {
                        if (supervisor.loading) return 'Loading...';
                        return supervisor.text || supervisor.name;
                    },
                    templateSelection: function(supervisor) {
                        return supervisor.text || supervisor.name;
                    }
                };
                
                // Initialize supervisor_id Select2
                $('#supervisor_id').select2({
                    ...supervisorSelect2Config,
                    dropdownParent: $('#fieldVisitModal')
                });
                
                // Update hidden supervisor_name when selection changes
                $('#supervisor_id').on('select2:select', function(e) {
                    const selectedText = e.params.data.text || e.params.data.name || '';
                    $('#supervisor_name').val(selectedText);
                });
                
                // Clear supervisor_name when supervisor is cleared
                $('#supervisor_id').on('select2:clear', function() {
                    $('#supervisor_name').val('');
                });
            }
            
            // When customer is selected, populate loans dropdown
            $('#customer_id').on('select2:select', function(e) {
                const customerId = e.params.data.id;
                const customerName = e.params.data.text || '';
                const customerLoans = e.params.data.loans || [];
                
                console.log('Selected customer:', e.params.data);
                console.log('Selected customer loans:', customerLoans);
                
                // Store customer name in hidden field
                $('#customer_name').val(customerName);
                
                // Clear loan dropdown
                $('#loan_id').empty();
                
                // Add default option
                $('#loan_id').append(new Option('Select a loan', '', true, true));
                
                // Add loans to dropdown
                if (customerLoans.length > 0) {
                    customerLoans.forEach(loan => {
                        // Format the loan balance with commas
                        const formattedBalance = formatCurrency(loan.OutstandingBalance);
                        
                        const option = new Option(
                            `${loan.LoanNo} - Balance: ${formattedBalance}`, 
                            loan.LoanAppID, 
                            false, 
                            false
                        );
                        $(option).data('loan', loan);
                        $('#loan_id').append(option);
                    });
                } else {
                    // Fetch loans from API
                    $.ajax({
                        url: `/api/customers/${customerId}/loans`,
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            if (data.loans && data.loans.length > 0) {
                                data.loans.forEach(loan => {
                                    // Format the loan balance with commas
                                    const formattedBalance = formatCurrency(loan.OutstandingBalance);
                                    
                                    const option = new Option(
                                        `${loan.LoanNo} - Balance: ${formattedBalance}`, 
                                        loan.LoanAppID, 
                                        false, 
                                        false
                                    );
                                    $(option).data('loan', loan);
                                    $('#loan_id').append(option);
                                });
                            } else {
                                $('#loan_id').append(new Option('No loans found', '', true, true));
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error fetching loans:', error);
                            $('#loan_id').append(new Option('Error loading loans', '', true, true));
                        }
                    });
                }
                
                // Trigger change to refresh Select2
                $('#loan_id').trigger('change');
            });
            
            // When loan is selected, populate loan details
            $('#loan_id').on('select2:select', function(e) {
                const loanId = e.params.data.id;
                const loan = $(e.params.data.element).data('loan');
                
                console.log('Selected loan:', loan);
                
                if (loan) {
                    // Store loan account number in hidden field
                    $('#loan_account_no').val(loan.LoanNo);
                    
                    // Store raw values in hidden fields for form submission
                    $('#raw_outstanding_balance').val(loan.OutstandingBalance);
                    $('#raw_days_in_arrears').val(loan.DaysInArrears || 0);
                    
                    // Update form fields with loan details
                    $('#outstanding_balance').val(formatCurrency(loan.OutstandingBalance));
                    
                    // Set days in arrears (if available, otherwise default to 0)
                    const daysInArrears = loan.DaysInArrears || 0;
                    $('#days_in_arrears').val(daysInArrears);
                    
                    // Calculate missed payments (1 per 30 days, minimum 1)
                    const missedPayments = Math.max(1, Math.ceil(daysInArrears / 30));
                    $('#missed_payments').val(missedPayments);
                    
                    // Set installment amount (use OutstandingBalance as fallback if InstallmentAmount is not available)
                    const installmentAmount = loan.InstallmentAmount || (loan.OutstandingBalance / 12);
                    $('#raw_installment_amount').val(installmentAmount);
                    $('#installment_amount').val(formatCurrency(installmentAmount));
                    
                    // Set priority based on days in arrears
                    let priorityValue = 'Low';
                    if (daysInArrears >= 90) priorityValue = 'Critical';
                    else if (daysInArrears >= 60) priorityValue = 'High';
                    else if (daysInArrears >= 30) priorityValue = 'Medium';
                    
                    $('#priority').val(priorityValue);
                } else {
                    // If loan data is not available in the option, fetch it
                    const customerId = $('#customer_id').val();
                    if (customerId && loanId) {
                        $.ajax({
                            url: `/api/customers/${customerId}/loans`,
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                if (data.loans && data.loans.length > 0) {
                                    const selectedLoan = data.loans.find(l => l.id == loanId);
                                    if (selectedLoan) {
                                        updateLoanDetailsInForm(selectedLoan);
                                    }
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Error fetching loan details:', error);
                            }
                        });
                    }
                }
            });
            
            // Helper function to format currency
            function formatCurrency(amount) {
                if (amount === undefined || amount === null) return 'N/A';
                
                // Remove any existing commas and convert to number
                const cleanAmount = parseFloat(String(amount).replace(/,/g, ''));
                if (isNaN(cleanAmount)) return 'N/A';
                
                // Format with commas and 2 decimal places
                return cleanAmount.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
            
            // Function to update loan details in the form
            function updateLoanDetailsInForm(loan) {
                console.log('Updating loan details in form:', loan);
                
                const outstandingBalance = loan.outstanding_balance || 0;
                const daysInArrears = loan.days_in_arrears || 0;
                
                // Calculate missed payments based on days in arrears (1 per 30 days)
                // Using Math.ceil to round up - if 31 days in arrears, that's 2 missed payments
                const missedPayments = Math.max(1, Math.ceil(daysInArrears / 30));
                
                // Use installment_amount if available, otherwise use outstanding_balance
                const installmentAmount = loan.installment_amount || outstandingBalance;
                
                console.log('Calculated values:', {
                    outstandingBalance,
                    daysInArrears,
                    missedPayments,
                    installmentAmount
                });
                
                // Set priority based on days in arrears
                let priorityValue = 'Low';
                if (daysInArrears >= 90) priorityValue = 'Critical';
                else if (daysInArrears >= 60) priorityValue = 'High';
                else if (daysInArrears >= 30) priorityValue = 'Medium';
                
                // Update form fields - using the correct IDs that match the HTML
                $('#outstanding_balance').val(formatCurrency(outstandingBalance));
                $('#days_in_arrears').val(daysInArrears);
                $('#missed_payments').val(missedPayments);
                $('#installment_amount').val(formatCurrency(installmentAmount));
                $('#priority').val(priorityValue);
                
                // Get customer name and loan account number
                // Get customer name from Select2 data or dropdown
                let customerName = $('#customer_name').val();
                if (!customerName) {
                    const customerData = $('#customer_id').select2('data')[0];
                    customerName = customerData ? (customerData.text || customerData.name || 'Unknown Customer') : 'Unknown Customer';
                    $('#customer_name').val(customerName);
                }
                
                // Get loan account number from Select2 data or dropdown
                let loanAccountNo = $('#loan_account_no').val();
                if (!loanAccountNo) {
                    const loanData = $('#loan_id').select2('data')[0];
                    if (loanData) {
                        const loanText = loanData.text || '';
                        loanAccountNo = loanText.split(' - ')[0].trim(); // Extract loan number from the option text
                    } else {
                        loanAccountNo = 'Unknown Loan';
                    }
                    $('#loan_account_no').val(loanAccountNo);
                }
                
                // Add hidden fields for form submission
                if (!$('#hidden_fields').length) {
                    const hiddenFields = `
                        <div id="hidden_fields">
                            <input type="hidden" name="raw_outstanding_balance" value="${outstandingBalance}">
                            <input type="hidden" name="raw_days_in_arrears" value="${daysInArrears}">
                            <input type="hidden" name="raw_installment_amount" value="${installmentAmount}">
                            <input type="hidden" name="outstanding_balance" value="${formatCurrency(outstandingBalance)}">
                            <input type="hidden" name="days_in_arrears" value="${daysInArrears}">
                            <input type="hidden" name="missed_payments" value="${missedPayments}">
                            <input type="hidden" name="installment_amount" value="${formatCurrency(installmentAmount)}">
                            <input type="hidden" name="customer_name" value="${customerName}">
                            <input type="hidden" name="loan_account_no" value="${loanAccountNo}">
                        </div>
                    `;
                    $('#fieldVisitForm').append(hiddenFields);
                } else {
                    $('#hidden_fields input[name="raw_outstanding_balance"]').val(outstandingBalance);
                    $('#hidden_fields input[name="raw_days_in_arrears"]').val(daysInArrears);
                    $('#hidden_fields input[name="raw_installment_amount"]').val(installmentAmount);
                    $('#hidden_fields input[name="outstanding_balance"]').val(formatCurrency(outstandingBalance));
                    $('#hidden_fields input[name="days_in_arrears"]').val(daysInArrears);
                    $('#hidden_fields input[name="missed_payments"]').val(missedPayments);
                    $('#hidden_fields input[name="installment_amount"]').val(formatCurrency(installmentAmount));
                    $('#hidden_fields input[name="customer_name"]').val(customerName);
                    $('#hidden_fields input[name="loan_account_no"]').val(loanAccountNo);
                }
            }
            
            // Handle form submission
            $('#fieldVisitForm').on('submit', function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm()) {
                    return false;
                }
                
                // Show loading state
                showLoading();
                
                // Create FormData object
                const formData = new FormData(this);
                
                // Ensure staff IDs are properly handled
                const fieldOfficerId = $('#field_officer_id').val();
                const supervisorId = $('#supervisor_id').val();
                
                // Convert IDs to integers (if they exist)
                if (fieldOfficerId) {
                    formData.set('field_officer_id', parseInt(fieldOfficerId, 10));
                }
                
                if (supervisorId) {
                    formData.set('supervisor_id', parseInt(supervisorId, 10));
                }
                
                // Set default branch ID
                formData.set('assigned_branch_id', 1);
                
                // Ensure customer name and loan account number are included
                const customerName = $('#customer_name').val() || 'Unknown Customer';
                const loanAccountNo = $('#loan_account_no').val() || 'Unknown Loan';
                
                formData.set('customer_name', customerName);
                formData.set('loan_account_no', loanAccountNo);
                
                console.log('Customer Name:', customerName);
                console.log('Loan Account No:', loanAccountNo);
                
                // Log form data for debugging
                console.log('Submitting form data...');
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ': ' + pair[1]);
                }
                
                // Check if we're in edit mode
                const isEditMode = $('#fieldVisitForm').attr('data-edit-mode') === 'true';
                let url = $(this).attr('action');
                let method = isEditMode ? 'PUT' : 'POST';
                
                // For edit mode, we need to handle the method override for Flask
                if (isEditMode) {
                    // Flask doesn't natively support PUT requests in forms
                    // We'll use POST but add a special header
                    method = 'POST';
                    // Remove any existing _method field to avoid duplicates
                    formData.delete('_method');
                    // Add the method override field that Flask will recognize
                    formData.append('_method', 'PUT');
                }
                
                // Submit form via AJAX
                $.ajax({
                    url: url,
                    type: method,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            Swal.fire({
                                title: 'Success!',
                                text: isEditMode ? 'Field visit updated successfully.' : 'Field visit scheduled successfully.',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then((result) => {
                                // Close modal
                                closeModal();
                                
                                // Reload page to show updated data
                                window.location.reload();
                            });
                        } else {
                            // Show error message
                            showError(response.message || 'An error occurred');
                        }
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error submitting form:', error);
                        
                        // Parse error response
                        let errorMessage = isEditMode ? 
                            'An error occurred while updating the field visit' : 
                            'An error occurred while scheduling the field visit';
                        
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMessage = response.error;
                                
                                // Highlight missing fields if provided
                                if (response.missing_fields) {
                                    response.missing_fields.forEach(field => {
                                        $(`[name=${field}]`).addClass('border-red-500');
                                    });
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        
                        // Show error message
                        showError(errorMessage);
                    }
                });
            });
            
            // Form validation function
            function validateForm() {
                // Reset validation errors
                $('.border-red-500').removeClass('border-red-500');
                $('.invalid-feedback').remove();
                
                // Check required fields
                let isValid = true;
                const requiredFields = ['customer_id', 'loan_id', 'field_officer_id', 'visit_date', 'visit_time', 'location', 'purpose', 'notes'];
                
                requiredFields.forEach(field => {
                    const value = $(`[name=${field}]`).val();
                    if (!value) {
                        const element = $(`[name=${field}]`);
                        element.addClass('border-red-500');
                        // Add specific error message for ID fields
                        if (['customer_id', 'loan_id', 'field_officer_id'].includes(field)) {
                            element.after(`<div class="invalid-feedback d-block text-red-500">This field is required and must have a valid ID</div>`);
                        }
                        isValid = false;
                    }
                });
                
                if (!isValid) {
                    showError('Please fill in all required fields');
                }
                
                // Validate date format
                const visitDate = $('#visit_date').val();
                if (visitDate && !isValidDate(visitDate)) {
                    isValid = false;
                    $('#visit_date').addClass('border-red-500');
                    $('#visit_date').after(`<div class="invalid-feedback">Please enter a valid date (YYYY-MM-DD).</div>`);
                }
                
                // Validate time format
                const visitTime = $('#visit_time').val();
                if (visitTime && !isValidTime(visitTime)) {
                    isValid = false;
                    $('#visit_time').addClass('is-invalid');
                    $('#visit_time').after(`<div class="invalid-feedback">Please enter a valid time (HH:MM).</div>`);
                }
                
                return isValid;
            }
            
            // Date validation helper
            function isValidDate(dateString) {
                const regex = /^\d{4}-\d{2}-\d{2}$/;
                if (!regex.test(dateString)) return false;
                
                const date = new Date(dateString);
                return date instanceof Date && !isNaN(date);
            }
            
            // Time validation helper
            function isValidTime(timeString) {
                const regex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
                return regex.test(timeString);
            }
            
            // Handle view details button clicks
            $(document).on('click', '.view-details-btn', function() {
                const visitId = $(this).data('visit-id');
                console.log('Viewing details for visit:', visitId);
                
                // Fetch visit details from the server
                $.ajax({
                    url: `/api/field-visits/${visitId}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            // Display visit details in a modal or alert for now
                            const visit = response.visit;
                            
                            // Format the details for display
                            const details = `
                                <h3 class="text-lg font-medium text-gray-900">Field Visit Details</h3>
                                <div class="mt-2">
                                    <p><strong>Customer:</strong> ${visit.customer_name}</p>
                                    <p><strong>Loan Account:</strong> ${visit.loan_account_no}</p>
                                    <p><strong>Field Officer:</strong> ${visit.field_officer_name}</p>
                                    <p><strong>Visit Date:</strong> ${new Date(visit.visit_date).toLocaleDateString()}</p>
                                    <p><strong>Visit Time:</strong> ${visit.visit_time}</p>
                                    <p><strong>Location:</strong> ${visit.location}</p>
                                    <p><strong>Purpose:</strong> ${visit.purpose}</p>
                                    <p><strong>Priority:</strong> ${visit.priority}</p>
                                    <p><strong>Status:</strong> ${visit.status}</p>
                                    <p><strong>Notes:</strong> ${visit.notes}</p>
                                </div>
                            `;
                            
                            // Show details in a modal or alert
                            Swal.fire({
                                title: 'Field Visit Details',
                                html: details,
                                icon: 'info',
                                confirmButtonText: 'Close'
                            });
                        } else {
                            showError(response.message || 'Failed to load visit details');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching visit details:', error);
                        showError('Failed to load visit details');
                    }
                });
            });
            
            // Handle update button clicks
            $(document).on('click', '.update-visit-btn', function() {
                const visitId = $(this).data('visit-id');
                console.log('Updating visit:', visitId);
                
                // Show loading indicator
                showLoading();
                
                // Fetch the field visit data
                $.ajax({
                    url: `/user/api/field-visits/${visitId}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        hideLoading();
                        if (response.success) {
                            const visit = response.visit;
                            
                            // Debug: Log the visit data to see what we're receiving
                            console.log('Visit data received:', visit);
                            console.log('Location:', visit.location);
                            console.log('Alternative Contact:', visit.alternative_contact);
                            console.log('Special Instructions:', visit.special_instructions);
                            console.log('Attachment:', visit.attachment);
                            
                            // Update the form title to indicate edit mode
                            $('#fieldVisitModal h3').text('Edit Field Visit');
                            $('#fieldVisitModal p').text('Update field visit details');
                            
                            // Set form to edit mode
                            $('#fieldVisitForm').attr('action', `/user/api/field-visits/${visitId}`);
                            $('#fieldVisitForm').attr('data-edit-mode', 'true');
                            $('#fieldVisitForm').append(`<input type='hidden' name='_method' value='PUT'>`);
                            
                            // Populate the form with visit data
                            // Customer information - make it editable like in add new field visit
                            // Initialize the customer dropdown with Select2
                            $('#customer_id').select2({
                                theme: 'bootstrap-5',
                                placeholder: 'Search for a customer...',
                                allowClear: true,
                                width: '100%',
                                dropdownParent: $('#fieldVisitModal'),
                                ajax: {
                                    url: '/api/customers/search',
                                    dataType: 'json',
                                    delay: 250,
                                    data: function(params) {
                                        return {
                                            q: params.term || '',
                                            page: params.page || 1,
                                            per_page: 10
                                        };
                                    },
                                    processResults: function(data) {
                                        console.log('Customer data received:', data);
                                        
                                        if (!data || !Array.isArray(data.items)) {
                                            console.error('Invalid customer data format:', data);
                                            return { results: [] };
                                        }
                                        
                                        return {
                                            results: data.items.map(item => ({
                                                id: item.id,
                                                text: item.text,
                                                loans: item.loans || []
                                            })),
                                            pagination: {
                                                more: data.has_more || false
                                            }
                                        };
                                    },
                                    cache: true
                                },
                                minimumInputLength: 0,
                                templateResult: function(customer) {
                                    return customer.loading ? 'Loading...' : customer.text;
                                },
                                templateSelection: function(customer) {
                                    return customer.text;
                                }
                            });
                            
                            // Set the current customer
                            const customerOption = new Option(visit.customer_name, visit.customer_id, true, true);
                            $('#customer_id').append(customerOption).trigger('change');
                            $('#customer_name').val(visit.customer_name);
                            
                            // Create customer data object for loan selection
                            const customerData = {
                                id: visit.customer_id,
                                text: visit.customer_name,
                                loans: [{
                                    id: visit.loan_account_no,
                                    text: visit.loan_account_no,
                                    OutstandingBalance: visit.outstanding_balance,
                                    DaysInArrears: visit.days_in_arrears,
                                    InstallmentAmount: visit.installment_amount
                                }]
                            };
                            
                            // Store customer data for loan selection
                            $('#customer_id').data('customerData', customerData);
                            
                            // Add event listener for customer selection changes
                            $('#customer_id').on('select2:select', function(e) {
                                const customerId = e.params.data.id;
                                const customerName = e.params.data.text;
                                
                                // Update hidden customer name field
                                $('#customer_name').val(customerName);
                                
                                // Clear and disable loan dropdown until loans are loaded
                                $('#loan_id').empty().prop('disabled', true);
                                $('#loan_id').append(new Option('Loading loans...', '')).trigger('change');
                                
                                // Clear loan details
                                $('#outstanding_balance').val('');
                                $('#raw_outstanding_balance').val('');
                                $('#days_in_arrears').val('');
                                $('#raw_days_in_arrears').val('');
                                $('#missed_payments').val('');
                                $('#installment_amount').val('');
                                $('#raw_installment_amount').val('');
                                
                                // Fetch customer loans
                                $.ajax({
                                    url: `/user/api/customers/${customerId}/loans`,
                                    type: 'GET',
                                    dataType: 'json',
                                    success: function(response) {
                                        if (response.success && response.loans) {
                                            // Enable loan dropdown
                                            $('#loan_id').empty().prop('disabled', false);
                                            $('#loan_id').append(new Option('Select a loan', '')).trigger('change');
                                            
                                            // Store loans data for later use
                                            const customerData = {
                                                id: customerId,
                                                text: customerName,
                                                loans: response.loans
                                            };
                                            $('#customer_id').data('customerData', customerData);
                                            
                                            // Add loans to dropdown
                                            response.loans.forEach(function(loan) {
                                                const option = new Option(loan.text, loan.id, false, false);
                                                $('#loan_id').append(option);
                                            });
                                            
                                            $('#loan_id').trigger('change');
                                        } else {
                                            // No loans found
                                            $('#loan_id').empty().prop('disabled', false);
                                            $('#loan_id').append(new Option('No loans found', '')).trigger('change');
                                        }
                                    },
                                    error: function() {
                                        console.error('Failed to fetch loans for customer');
                                        $('#loan_id').empty().prop('disabled', false);
                                        $('#loan_id').append(new Option('Error loading loans', '')).trigger('change');
                                    }
                                });
                            });
                            
                            // Initialize the loan dropdown with Select2 like in add new field visit
                            $('#loan_id').select2({
                                theme: 'bootstrap-5',
                                placeholder: 'Select a loan',
                                allowClear: true,
                                width: '100%',
                                dropdownParent: $('#fieldVisitModal')
                            });
                            
                            // Remove any existing event listeners to prevent duplicates
                            $('#customer_id').off('select2:select');
                            
                            // Add event listener for customer selection changes - exactly like in add new field visit
                            $('#customer_id').on('select2:select', function(e) {
                                const customerId = e.params.data.id;
                                const customerName = e.params.data.text || '';
                                const customerLoans = e.params.data.loans || [];
                                
                                console.log('Selected customer:', e.params.data);
                                console.log('Selected customer loans:', customerLoans);
                                
                                // Store customer name in hidden field
                                $('#customer_name').val(customerName);
                                
                                // Clear loan dropdown
                                $('#loan_id').empty();
                                
                                // Add default option
                                $('#loan_id').append(new Option('Select a loan', '', true, true));
                                
                                // Add loans to dropdown
                                if (customerLoans.length > 0) {
                                    customerLoans.forEach(loan => {
                                        // Format the loan balance with commas
                                        const formattedBalance = formatCurrency(loan.OutstandingBalance);
                                        
                                        const option = new Option(
                                            `${loan.LoanNo} - Balance: ${formattedBalance}`, 
                                            loan.LoanAppID, 
                                            false, 
                                            false
                                        );
                                        $(option).data('loan', loan);
                                        $('#loan_id').append(option);
                                    });
                                } else {
                                    // If no loans, fetch them from the API - use the same API endpoint as in add new field visit
                                    $.ajax({
                                        url: `/api/customers/${customerId}/loans`,
                                        type: 'GET',
                                        dataType: 'json',
                                        success: function(data) {
                                            console.log('Loans API response:', data);
                                            if (data.loans && data.loans.length > 0) {
                                                data.loans.forEach(loan => {
                                                    // Format the loan balance with commas
                                                    const formattedBalance = formatCurrency(loan.OutstandingBalance);
                                                    
                                                    const option = new Option(
                                                        `${loan.LoanNo} - Balance: ${formattedBalance}`, 
                                                        loan.LoanAppID, 
                                                        false, 
                                                        false
                                                    );
                                                    $(option).data('loan', loan);
                                                    $('#loan_id').append(option);
                                                });
                                            } else {
                                                $('#loan_id').append(new Option('No loans found', '', true, true));
                                            }
                                        },
                                        error: function(xhr, status, error) {
                                            console.error('Error fetching loans:', error);
                                            $('#loan_id').append(new Option('Error loading loans', '', true, true));
                                        }
                                    });
                                }
                                
                                // Trigger change to refresh Select2
                                $('#loan_id').trigger('change');
                            });
                            
                            // Add event listener for loan selection changes - exactly like in add new field visit
                            $('#loan_id').on('select2:select', function(e) {
                                const loanId = e.params.data.id;
                                const loan = $(e.params.data.element).data('loan');
                                
                                console.log('Selected loan:', loan);
                                
                                if (loan) {
                                    // Store loan account number in hidden field
                                    $('#loan_account_no').val(loan.LoanNo);
                                    
                                    // Store raw values in hidden fields for form submission
                                    $('#raw_outstanding_balance').val(loan.OutstandingBalance);
                                    $('#raw_days_in_arrears').val(loan.DaysInArrears || 0);
                                    
                                    // Update form fields with loan details
                                    $('#outstanding_balance').val(formatCurrency(loan.OutstandingBalance));
                                    
                                    // Set days in arrears (if available, otherwise default to 0)
                                    const daysInArrears = loan.DaysInArrears || 0;
                                    $('#days_in_arrears').val(daysInArrears);
                                    
                                    // Calculate missed payments (1 per 30 days, minimum 1) - per memory requirements
                                    const missedPayments = Math.ceil(daysInArrears / 30);
                                    $('#missed_payments').val(missedPayments);
                                    
                                    // Set installment amount (use OutstandingBalance as fallback if InstallmentAmount is not available)
                                    const installmentAmount = loan.InstallmentAmount || loan.OutstandingBalance || 0;
                                    $('#raw_installment_amount').val(installmentAmount);
                                    $('#installment_amount').val(formatCurrency(installmentAmount));
                                    
                                    // Set priority based on days in arrears
                                    let priorityValue = 'Low';
                                    if (daysInArrears >= 90) priorityValue = 'Critical';
                                    else if (daysInArrears >= 60) priorityValue = 'High';
                                    else if (daysInArrears >= 30) priorityValue = 'Medium';
                                    
                                    $('#priority').val(priorityValue);
                                } else {
                                    // If loan data is not available in the option, fetch it
                                    const customerId = $('#customer_id').val();
                                    if (customerId && loanId) {
                                        $.ajax({
                                            url: `/api/customers/${customerId}/loans`,
                                            type: 'GET',
                                            dataType: 'json',
                                            success: function(data) {
                                                if (data.loans && data.loans.length > 0) {
                                                    const selectedLoan = data.loans.find(l => l.LoanAppID == loanId);
                                                    if (selectedLoan) {
                                                        // Store loan account number in hidden field
                                                        $('#loan_account_no').val(selectedLoan.LoanNo);
                                                        
                                                        // Update form fields with loan details
                                                        $('#outstanding_balance').val(formatCurrency(selectedLoan.OutstandingBalance));
                                                        $('#raw_outstanding_balance').val(selectedLoan.OutstandingBalance);
                                                        
                                                        const daysInArrears = selectedLoan.DaysInArrears || 0;
                                                        $('#days_in_arrears').val(daysInArrears);
                                                        $('#raw_days_in_arrears').val(daysInArrears);
                                                        
                                                        const missedPayments = Math.ceil(daysInArrears / 30);
                                                        $('#missed_payments').val(missedPayments);
                                                        
                                                        const installmentAmount = selectedLoan.InstallmentAmount || selectedLoan.OutstandingBalance || 0;
                                                        $('#installment_amount').val(formatCurrency(installmentAmount));
                                                        $('#raw_installment_amount').val(installmentAmount);
                                                    }
                                                }
                                            }
                                        });
                                    }
                                }
                            });
                            
                            // Set the current loan - create a proper loan option with all the data
                            // Create a loan object similar to what we get from the API
                            const loanData = {
                                LoanAppID: visit.loan_id,
                                LoanNo: visit.loan_account_no,
                                OutstandingBalance: visit.outstanding_balance,
                                DaysInArrears: visit.days_in_arrears,
                                InstallmentAmount: visit.installment_amount
                            };
                            
                            // Format the loan balance with commas for display
                            const formattedBalance = formatCurrency(visit.outstanding_balance);
                            
                            // Create the loan option with formatted text
                            const loanOption = new Option(
                                `${visit.loan_account_no} - Balance: ${formattedBalance}`,
                                visit.loan_id,
                                true,
                                true
                            );
                            
                            // Attach the loan data to the option for later use
                            $(loanOption).data('loan', loanData);
                            
                            // Add the option to the dropdown and trigger change
                            $('#loan_id').append(loanOption).trigger('change');
                            
                            // Set the hidden loan account number field
                            $('#loan_account_no').val(visit.loan_account_no);
                            
                            // Loan details - make them editable
                            // Outstanding Balance - editable with proper formatting
                            const outstandingBalance = visit.outstanding_balance || 0;
                            $('#outstanding_balance').val(formatCurrency(outstandingBalance));
                            $('#raw_outstanding_balance').val(outstandingBalance);
                            $('#outstanding_balance').prop('readonly', false);
                            
                            // Days in Arrears - editable
                            const daysInArrears = visit.days_in_arrears || 0;
                            $('#days_in_arrears').val(daysInArrears);
                            $('#raw_days_in_arrears').val(daysInArrears);
                            $('#days_in_arrears').prop('readonly', false);
                            
                            // Calculate missed payments based on days in arrears per memory requirements
                            const missedPayments = Math.ceil(daysInArrears / 30);
                            $('#missed_payments').val(missedPayments);
                            $('#missed_payments').prop('readonly', false);
                            
                            // Installment Amount - editable with proper formatting
                            // Use outstanding_balance as fallback if installment_amount is not available
                            const installmentAmount = visit.installment_amount || visit.outstanding_balance || 0;
                            $('#installment_amount').val(formatCurrency(installmentAmount));
                            $('#raw_installment_amount').val(installmentAmount);
                            $('#installment_amount').prop('readonly', false);
                            
                            // Add event listener to days_in_arrears to update missed_payments
                            $('#days_in_arrears').on('input', function() {
                                const daysValue = parseInt($(this).val()) || 0;
                                const missedPaymentsValue = Math.ceil(daysValue / 30);
                                $('#missed_payments').val(missedPaymentsValue);
                                $('#raw_days_in_arrears').val(daysValue);
                            });
                            
                            // Visit details
                            $('#purpose').val(visit.purpose);
                            $('#priority').val(visit.priority);
                            $('#visit_date').val(visit.visit_date);
                            $('#visit_time').val(visit.visit_time);
                            
                            // Set location field (using correct ID 'visitLocation')
                            console.log('Location field exists:', $('#visitLocation').length > 0);
                            if ($('#visitLocation').length > 0) {
                                $('#visitLocation').val(visit.location);
                                console.log('Location set to:', visit.location);
                            } else {
                                console.error('Location field not found in the form');
                            }
                            
                            // Staff assignments - make fully editable with Select2
                            // Initialize field officer dropdown with Select2 and AJAX loading
                            $('#field_officer_id').select2({
                                theme: 'bootstrap-5',
                                width: '100%',
                                placeholder: 'Search for Field Officer',
                                minimumInputLength: 0,
                                dropdownParent: $('#fieldVisitModal'),
                                ajax: {
                                    url: '/api/collection-schedules/staff',
                                    dataType: 'json',
                                    delay: 250,
                                    data: function(params) {
                                        console.log('Sending staff search:', params.term);
                                        return {
                                            term: params.term || '',
                                            page: params.page || 1,
                                            role_type: 'officer'  // Match collection schedule approach
                                        };
                                    },
                                    processResults: function(data) {
                                        console.log('Received staff data:', data);
                                        if (!data || !Array.isArray(data)) {
                                            console.error('Expected data to be an array:', data);
                                            return { results: [] };
                                        }
                                        // Format the results to match the collection schedule approach
                                        return {
                                            results: data.map(item => ({
                                                id: item.id,
                                                text: item.name,
                                                role: item.role,
                                                branchId: item.branch_id
                                            }))
                                        };
                                    },
                                    cache: true
                                },
                                templateResult: formatStaff,
                                templateSelection: formatStaffSelection
                            });
                            
                            // Initialize supervisor dropdown with Select2 and AJAX loading
                            $('#supervisor_id').select2({
                                theme: 'bootstrap-5',
                                width: '100%',
                                placeholder: 'Search for Supervisor',
                                minimumInputLength: 0,
                                dropdownParent: $('#fieldVisitModal'),
                                ajax: {
                                    url: '/api/collection-schedules/staff',
                                    dataType: 'json',
                                    delay: 250,
                                    data: function(params) {
                                        return {
                                            term: params.term || '',
                                            page: params.page || 1,
                                            role_type: 'supervisor'  // Match collection schedule approach
                                        };
                                    },
                                    processResults: function(data) {
                                        if (!data || !Array.isArray(data)) {
                                            console.error('Expected supervisor data to be an array:', data);
                                            return { results: [] };
                                        }
                                        // Format the results to match the collection schedule approach
                                        return {
                                            results: data.map(item => ({
                                                id: item.id,
                                                text: item.name,
                                                role: item.role,
                                                branchId: item.branch_id
                                            }))
                                        };
                                    },
                                    cache: true
                                },
                                templateResult: formatStaff,
                                templateSelection: formatStaffSelection
                            });
                            
                            // Set the current field officer
                            if (visit.field_officer_id && visit.field_officer_name) {
                                const fieldOfficerOption = new Option(visit.field_officer_name, visit.field_officer_id, true, true);
                                $('#field_officer_id').append(fieldOfficerOption).trigger('change');
                                $('#field_officer_name').val(visit.field_officer_name);
                            }
                            
                            // Set the current supervisor
                            if (visit.supervisor_id && visit.supervisor_name) {
                                const supervisorOption = new Option(visit.supervisor_name, visit.supervisor_id, true, true);
                                $('#supervisor_id').append(supervisorOption).trigger('change');
                                $('#supervisor_name').val(visit.supervisor_name);
                            }
                            
                            // Add event listeners for field officer selection
                            $('#field_officer_id').on('select2:select', function(e) {
                                const staffId = e.params.data.id;
                                const staffName = e.params.data.text;
                                $('#field_officer_name').val(staffName);
                            });
                            
                            // Add event listeners for supervisor selection
                            $('#supervisor_id').on('select2:select', function(e) {
                                const staffId = e.params.data.id;
                                const staffName = e.params.data.text;
                                $('#supervisor_name').val(staffName);
                            });
                            
                            // Additional information
                            // Set alternative contact field (using correct ID 'alternativeContact')
                            console.log('Alternative contact field exists:', $('#alternativeContact').length > 0);
                            if ($('#alternativeContact').length > 0) {
                                $('#alternativeContact').val(visit.alternative_contact);
                                console.log('Alternative contact set to:', visit.alternative_contact);
                            } else {
                                console.error('Alternative contact field not found in the form');
                            }
                            
                            $('#notes').val(visit.notes);
                            
                            // Set special instructions field (using correct ID 'instructions')
                            console.log('Special instructions field exists:', $('#instructions').length > 0);
                            if ($('#instructions').length > 0) {
                                $('#instructions').val(visit.special_instructions);
                                console.log('Special instructions set to:', visit.special_instructions);
                            } else {
                                console.error('Special instructions field not found in the form');
                            }
                            
                            // Handle attachment/uploaded file
                            if (visit.attachment) {
                                console.log('Attachment exists:', visit.attachment);
                                
                                // Create a container for the current attachment if it doesn't exist
                                if (!$('#current-attachment-container').length) {
                                    const attachmentContainer = `
                                    <div id="current-attachment-container" class="mt-4 p-3 border border-gray-300 rounded-md">
                                        <h4 class="text-sm font-medium text-gray-700 mb-2">Current Attachment</h4>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                                                <span id="current-attachment-name" class="text-sm text-gray-700"></span>
                                            </div>
                                            <div class="flex space-x-2">
                                                <a id="view-attachment-link" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                                                    <i class="fas fa-eye mr-1"></i> View
                                                </a>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">Upload a new file to replace the current attachment</p>
                                        <input type="hidden" id="current_attachment_path" name="current_attachment_path" value="">
                                    </div>
                                    `;
                                    
                                    // Add the container before the attachment field (using correct ID 'visitAttachment')
                                    $('#visitAttachment').closest('.mt-1').before(attachmentContainer);
                                    console.log('Attachment container added');
                                }
                                
                                // Extract filename from path
                                const filename = visit.attachment.split('/').pop();
                                $('#current-attachment-name').text(filename);
                                $('#view-attachment-link').attr('href', visit.attachment);
                                $('#current_attachment_path').val(visit.attachment);
                            }
                            
                            // Status dropdown (only available in edit mode)
                            if (!$('#status').length) {
                                const statusField = `
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                        <option value="scheduled" ${visit.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                        <option value="in_progress" ${visit.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="completed" ${visit.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="cancelled" ${visit.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                                `;
                                $('#special_instructions').closest('.grid').append(statusField);
                            } else {
                                $('#status').val(visit.status);
                            }
                            
                            // Update submit button text
                            $('#submitFieldVisit').text('Update Field Visit');
                            
                            // Show the modal
                            openModal();
                        } else {
                            showError(response.message || 'Failed to load visit details');
                        }
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error fetching visit details:', error);
                        showError('Failed to load visit details');
                    }
                });
            })
            
            // Function to reset the form
            function resetForm() {
                $('#fieldVisitForm')[0].reset();
                $('#customer_id').val(null).trigger('change');
                $('#loan_id').val(null).trigger('change');
                $('#field_officer_id').val(null).trigger('change');
                $('#supervisor_id').val(null).trigger('change');
                $('.is-invalid').removeClass('is-invalid');
                $('.invalid-feedback').remove();
                $('#hidden_fields').remove();
            }
            
            // Reset form when modal is closed
            $('#fieldVisitModal').on('hidden.bs.modal', function() {
                resetForm();
            });
        });
    </script>
{% endblock %}
