{% extends "base.html" %}
{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .status-scheduled { background-color: #FEF3C7; color: #92400E; }
    .status-in-progress { background-color: #DBEAFE; color: #1E40AF; }
    .status-completed { background-color: #D1FAE5; color: #065F46; }
    .status-cancelled { background-color: #FEE2E2; color: #B91C1C; }
</style>
{% endblock %}

{% block content %}
    {% include 'user/post_disbursement_sidebar.html' %}
    
    <div class="p-4 sm:ml-64">
        <div class="sm:flex sm:items-center">
            <div class="sm:flex-auto">
                <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">Field Visits</h1>
                <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Schedule and track field visits to borrowers.</p>
            </div>
            {% if error_message %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline">{{ error_message }}</span>
            </div>
            {% endif %}
            <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
                <button type="button" id="openFieldVisitModal" class="inline-flex items-center justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 sm:w-auto">
                    Schedule New Visit
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-4">
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar text-blue-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Scheduled Visits</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ stats.scheduled }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Completed Visits</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ stats.completed }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-yellow-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Pending Reports</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ stats.pending_reports }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-users text-purple-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">In Progress</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ stats.in_progress }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Visit Status</label>
                    <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                        <option>All Status</option>
                        <option>Scheduled</option>
                        <option>In Progress</option>
                        <option>Completed</option>
                        <option>Cancelled</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Field Officer</label>
                    <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                        <option>All Officers</option>
                        <option>John Doe</option>
                        <option>Jane Smith</option>
                        <option>Mike Johnson</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Visit Date</label>
                    <input type="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search</label>
                    <input type="text" placeholder="Search by customer or loan number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="mt-8 flex flex-col">
            <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">ID</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Customer</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Field Officer</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Visit Date</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Visit Time</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Last Updated</th>
                                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800">
                                {% if field_visits %}
                                    {% for visit in field_visits %}
                                    <tr data-visit-id="{{ visit.id }}" data-days-in-arrears="{{ visit.days_in_arrears|default(0) }}">
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">
                                            {{ visit.id }}
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            {{ visit.customer_name }}
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            {{ visit.field_officer_name }}
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 status-cell">
                                            {% if visit.status == 'scheduled' %}
                                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Scheduled</span>
                                            {% elif visit.status == 'in_progress' %}
                                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">In Progress</span>
                                            {% elif visit.status == 'completed' %}
                                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Completed</span>
                                            {% elif visit.status == 'cancelled' %}
                                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Cancelled</span>
                                            {% else %}
                                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">{{ visit.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            {{ visit.visit_date }}
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                            {{ visit.visit_time }}
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 updated-at-cell">
                                            {{ visit.updated_at }}
                                        </td>
                                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                            <div class="flex justify-end space-x-2">
                                                <button class="add-status-history-btn {% if visit.status == 'completed' %}bg-gray-400 cursor-not-allowed{% else %}bg-green-600 hover:bg-green-700{% endif %} text-white px-3 py-1 rounded-full text-xs transition" data-visit-id="{{ visit.id }}" data-status="{{ visit.status }}" {% if visit.status == 'completed' %}disabled{% endif %} title="Update Status">
                                                    <i class="fas fa-sync-alt"></i> Update
                                                </button>
                                                <button class="view-status-history-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-full text-xs transition" data-visit-id="{{ visit.id }}" title="View Status History">
                                                    <i class="fas fa-history"></i> History
                                                </button>

                                                <button class="update-visit-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-full text-xs transition" data-visit-id="{{ visit.id }}" data-customer-id="{{ visit.customer_id }}" data-customer-name="{{ visit.customer_name }}" title="Edit Field Visit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="py-4 text-center text-sm text-gray-500 dark:text-gray-300">No field visits found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusUpdateModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity hidden z-50">
        <!-- Modal content here -->
    </div>

    <!-- Status History Modal -->
    <div id="statusModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity hidden z-50">
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                    <!-- Modal Header -->
                    <div class="bg-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold leading-6 text-gray-900">Field Visit Status History</h3>
                                <p class="text-sm text-gray-500 mt-1">View status changes and attachments</p>
                            </div>
                            <button type="button" id="closeStatusModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                <span class="sr-only">Close</span>
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Body -->
                    <div class="bg-white px-6 py-4">
                        <!-- Tabs -->
                        <div class="border-b border-gray-200 mb-4">
                            <div class="flex -mb-px">
                                <button id="status-tab-btn-statusHistory" data-tab="statusHistory" class="status-tab-btn bg-white py-2 px-4 text-sm font-medium text-blue-600 border-b-2 border-blue-500">Status History</button>
                                <button id="status-tab-btn-attachments" data-tab="attachments" class="status-tab-btn bg-gray-200 py-2 px-4 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300">Attachments</button>
                            </div>
                        </div>
                        
                        <!-- Tab Content -->
                        <div class="tab-content">
                            <!-- Status History Tab -->
                            <div id="status-tab-statusHistory" class="status-tab-content hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Previous Status</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New Status</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated By</th>
                                            </tr>
                                        </thead>
                                        <tbody id="statusHistoryTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Status history will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div id="status-tab-attachments" class="status-tab-content hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attachmentsTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Attachments will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity hidden z-50">
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                    <!-- Modal Header with blue accent -->
                    <div class="bg-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold leading-6 text-gray-900">Update Field Visit Status</h3>
                                <p class="text-sm text-gray-500 mt-1">Change the status and add supporting documentation</p>
                            </div>
                            <button type="button" id="closeReportModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                <span class="sr-only">Close</span>
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="bg-white px-6 py-5">
                        <div class="w-full">
                            <div class="mb-4">
                                <div class="w-full h-1 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="status-progress-bar h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>

                                <form id="reportForm" class="space-y-6">
                                    <input type="hidden" id="report_visit_id" name="visit_id" value="">
                                    <input type="hidden" id="previous_status" name="previous_status" value="">
                                    
                                    <!-- Status Section -->
                                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                                        <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            Status Information
                                        </h4>
                                        
                                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                            <div>
                                                <label for="new_status" class="block text-sm font-medium text-gray-700 mb-1">New Status</label>
                                                <select id="new_status" name="new_status" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                                    <option value="">Select new status</option>
                                                    <option value="scheduled" class="py-1">Scheduled</option>
                                                    <option value="in-progress" class="py-1">In Progress</option>
                                                    <option value="completed" class="py-1">Completed</option>
                                                    <option value="cancelled" class="py-1">Cancelled</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label for="status_description" class="block text-sm font-medium text-gray-700 mb-1">Current Status</label>
                                                <div id="status_description" class="text-sm text-gray-700 bg-blue-50 p-3 rounded-md border border-blue-100 h-[38px] flex items-center"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Notes Section -->
                                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                                        <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                            Notes
                                        </h4>
                                        
                                        <div>
                                            <textarea id="status_notes" name="notes" rows="4" class="block w-full py-3 px-4 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm border border-gray-300 rounded-md" placeholder="Provide detailed information about this status change..." required></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- Attachment Section -->
                                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                                        <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                                            <svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                            Attachment (Optional)
                                        </h4>
                                        
                                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 mb-4">
                                            <div>
                                                <label for="attachment_type" class="block text-sm font-medium text-gray-700 mb-1">Attachment Type</label>
                                                <select id="attachment_type" name="attachment_type" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                                    <option value="">Select attachment type</option>
                                                    <option value="report" class="py-1">Visit Report</option>
                                                    <option value="photo" class="py-1">Photo Evidence</option>
                                                    <option value="receipt" class="py-1">Payment Receipt</option>
                                                    <option value="document" class="py-1">Legal Document</option>
                                                    <option value="other" class="py-1">Other</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label for="attachment_description" class="block text-sm font-medium text-gray-700 mb-1">Attachment Description</label>
                                                <input type="text" id="attachment_description" name="description" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Brief description of the attachment">
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label for="report_attachment" class="block text-sm font-medium text-gray-700 mb-1">Attachment File</label>
                                            <input type="file" id="report_attachment" name="attachment" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                            <p class="mt-2 text-xs text-gray-500">Supported file types: PDF, Word, Excel, Images (Max size: 5MB)</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Submit Button -->
                                    <div class="flex justify-end pt-2">
                                        <button type="submit" class="inline-flex justify-center items-center py-2.5 px-5 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                                            Update Status
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status History Modal -->
    <div id="statusModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity hidden z-50">
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                    <!-- Modal Header with blue accent -->
                    <div class="bg-blue-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold leading-6 text-gray-900">Field Visit Details</h3>
                                <p class="text-sm text-gray-500 mt-1">View status history and attachments</p>
                            </div>
                            <button type="button" id="closeStatusModal" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                <span class="sr-only">Close</span>
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div class="bg-gray-100 border-b border-gray-200">
                        <div class="flex">
                            <button id="status-tab-btn-statusHistory" data-tab="statusHistory" class="status-tab-btn flex-1 py-3 px-4 text-center text-sm font-medium bg-white text-gray-900 border-r border-gray-200 focus:outline-none">
                                <svg class="w-5 h-5 mr-1 inline-block text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Status History
                            </button>
                            <button id="status-tab-btn-attachments" data-tab="attachments" class="status-tab-btn flex-1 py-3 px-4 text-center text-sm font-medium bg-gray-200 text-gray-700 focus:outline-none">
                                <svg class="w-5 h-5 mr-1 inline-block text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                Attachments
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="p-6">
                        <!-- Status History Tab -->
                        <div id="status-tab-statusHistory" class="status-tab-content">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Previous Status</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New Status</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated By</th>
                                        </tr>
                                    </thead>
                                    <tbody id="statusHistoryTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Status history will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Attachments Tab -->
                        <div id="status-tab-attachments" class="status-tab-content hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attachmentsTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Attachments will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding new field visit -->
    <div id="fieldVisitModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity hidden z-50">
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                    <!-- Modal Header -->
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Schedule New Field Visit</h3>
                                <p class="text-sm text-gray-500">Create a new field visit for a customer</p>
                            </div>
                            <button type="button" id="closeFieldVisitModal" class="text-gray-400 hover:text-gray-500">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Modal Body -->
                    <div class="px-6 py-4">
                        <form id="fieldVisitForm" action="{{ url_for('user.create_field_visit') }}" method="POST" class="space-y-6" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="assigned_branch" id="branchInput" value="{{ branch_id }}">
                            <!-- Hidden fields for raw values -->
                            <input type="hidden" name="raw_outstanding_balance" id="raw_outstanding_balance">
                            <input type="hidden" name="raw_days_in_arrears" id="raw_days_in_arrears">
                            <input type="hidden" name="raw_installment_amount" id="raw_installment_amount">
                            
                            <!-- Hidden fields for customer and loan details -->
                            <input type="hidden" name="customer_name" id="customer_name">
                            <input type="hidden" name="loan_account_no" id="loan_account_no">
                            
                            <!-- Customer Information Section -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Customer Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Customer</label>
                                        <select id="customer_id" name="customer_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="">Select Customer</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Loan Account</label>
                                        <select id="loan_id" name="loan_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="">Select Loan</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Outstanding Balance</label>
                                        <input type="text" id="outstanding_balance" name="outstanding_balance" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Days in Arrears</label>
                                        <input type="text" id="days_in_arrears" name="days_in_arrears" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" readonly>
                                    </div>
                                </div>
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Missed Payments</label>
                                        <input type="text" id="missed_payments" name="missed_payments" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Installment Amount</label>
                                        <input type="text" id="installment_amount" name="installment_amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Visit Details Section -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Visit Details</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Purpose of Visit</label>
                                        <select id="purpose" name="purpose" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="">Select Purpose</option>
                                            <option value="collection">Collection</option>
                                            <option value="verification">Address Verification</option>
                                            <option value="follow_up">Follow-up</option>
                                            <option value="legal">Legal Notice Delivery</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Priority Level</label>
                                        <select id="priority" name="priority" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Visit Date</label>
                                        <input type="date" id="visit_date" name="visit_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Visit Time</label>
                                        <input type="time" id="visit_time" name="visit_time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Assignment Section -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Staff Assignment</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Field Officer</label>
                                        <select id="field_officer_id" name="field_officer_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                            <option value="">Select Field Officer</option>
                                        </select>
                                        <input type="hidden" id="field_officer_name" name="field_officer_name" value="">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Supervisor</label>
                                        <select id="supervisor_id" name="supervisor_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3">
                                            <option value="">Select Supervisor</option>
                                        </select>
                                        <input type="hidden" id="supervisor_name" name="supervisor_name" value="">
                                    </div>
                                </div>

                            </div>
                            
                            <!-- Additional Information -->
                            <div class="bg-gray-50 p-6 rounded-lg mb-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-4">Additional Information</h4>
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Visit Location</label>
                                        <div class="mt-1">
                                            <input type="text" id="visitLocation" name="location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" placeholder="e.g., Customer's Home, Business Premises" required>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Alternative Contact Person</label>
                                        <div class="mt-1">
                                            <input type="text" id="alternativeContact" name="alternative_contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" placeholder="Name and contact of alternative person">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Visit Notes</label>
                                        <div class="mt-1">
                                            <textarea id="visit_notes" name="notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" placeholder="Important details about the visit" required></textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
                                        <div class="mt-1">
                                            <textarea id="instructions" name="special_instructions" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" placeholder="Any special handling instructions or considerations"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Attachment -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Attachment</label>
                                <div class="mt-1">
                                    <input type="file" id="visitAttachment" name="attachment" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-2">
                                </div>
                            </div>
                            
                            <!-- Modal Footer -->
                            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                                <div class="flex justify-end space-x-3">
                                    <button type="button" id="cancelFieldVisitBtn" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Cancel
                                    </button>
                                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        Schedule Visit
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for modal functionality -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Format functions for Select2 dropdowns - defined globally
        function formatCustomer(customer) {
            if (!customer.id) {
                return customer.text;
            }
            
            return $(`
                <div class="d-flex flex-column">
                    <div class="font-weight-bold">${customer.text}</div>
                    ${customer.phone ? `<div class="text-muted small">${customer.phone}</div>` : ''}
                    ${customer.id_number ? `<div class="text-muted small">${customer.id_number}</div>` : ''}
                </div>
            `);
        }
        
        function formatCustomerSelection(customer) {
            return customer.text || 'Select a customer';
        }
        
        function formatLoan(loan) {
            if (!loan.id) {
                return loan.text;
            }
            
            const outstandingBalance = loan.OutstandingBalance ? loan.OutstandingBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
            const daysInArrears = loan.DaysInArrears || 0;
            const missedPayments = Math.ceil(daysInArrears / 30);
            
            return $(`
                <div class="d-flex flex-column">
                    <div class="font-weight-bold">${loan.text}</div>
                    <div class="text-muted small">Outstanding: ${outstandingBalance}</div>
                    <div class="text-muted small">Days in Arrears: ${daysInArrears} (${missedPayments} missed payments)</div>
                </div>
            `);
        }
        
        function formatLoanSelection(loan) {
            return loan.text || 'Select a loan';
        }
        
        // Format functions for staff dropdowns
        function formatStaff(staff) {
            if (!staff.id) {
                return staff.text;
            }
            
            return $(`
                <div class="d-flex flex-column">
                    <div class="font-weight-bold">${staff.text}</div>
                    ${staff.role ? `<div class="text-muted small">${staff.role}</div>` : ''}
                    ${staff.branch ? `<div class="text-muted small">${staff.branch}</div>` : ''}
                </div>
            `);
        }
        
        function formatStaffSelection(staff) {
            return staff.text || 'Select staff';
        }
        
        // Wait for jQuery to be fully loaded
        $(document).ready(function() {
            
            // Flag to track if Select2 has been initialized
            let select2Initialized = false;
            // Helper functions
            function formatCurrency(amount) {
                if (amount === undefined || amount === null) return 'N/A';
                
                // Remove any existing commas and convert to number
                const cleanAmount = parseFloat(String(amount).replace(/,/g, ''));
                if (isNaN(cleanAmount)) return 'N/A';
                
                // Format with commas and 2 decimal places
                return cleanAmount.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
            
            function showLoading() {
                console.log('Loading...');
                // Add loading indicator if needed
            }
            
            function hideLoading() {
                console.log('Loading complete');
                // Remove loading indicator if needed
            }
            
            function showSuccess(message) {
                Swal.fire({
                    title: 'Success!',
                    text: message,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            }
            
            function showError(message) {
                Swal.fire({
                    title: 'Error!',
                    text: message,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
            
            // Modal handling
            const modal = document.getElementById('fieldVisitModal');
            const openModalBtn = document.getElementById('openFieldVisitModal');
            const closeModalBtn = document.getElementById('closeFieldVisitModal');
            const cancelBtn = document.getElementById('cancelFieldVisitBtn');
            
            // Open modal function
            function openModal() {
                modal.classList.remove('hidden');
            }
            
            // Open modal button click handler
            openModalBtn.addEventListener('click', function() {
                openModal();
                // Reset the form
                $('#fieldVisitForm')[0].reset();
                
                // Initialize Select2 only if not already initialized
                if (!select2Initialized) {
                    initializeSelect2Dropdowns();
                    select2Initialized = true;
                } else {
                    // Just clear the selections
                    $('#customer_id, #loan_id, #field_officer_id, #supervisor_id').val(null).trigger('change');
                }
            });
            
            // Close modal
            function closeModal() {
                modal.classList.add('hidden');
            }
            
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });
            // Function to initialize all Select2 dropdowns
            function initializeSelect2Dropdowns() {
                console.log('Initializing Select2 dropdowns');
                
                // Remove any existing select2 containers first
                $('.select2-container').remove();
                
                // Initialize customer select
                $('#customer_id').select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Search for a customer...',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#fieldVisitModal'),
                    ajax: {
                        url: '/api/customers/search',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            return {
                                q: params.term || '',
                                page: params.page || 1,
                                per_page: 10
                            };
                        },
                        processResults: function(data) {
                            console.log('Customer data received:', data);
                            
                            if (!data || !Array.isArray(data.items)) {
                                console.error('Invalid customer data format:', data);
                                return { results: [] };
                            }
                            
                            return {
                                results: data.items.map(item => ({
                                    id: item.id,
                                    text: item.text,
                                    loans: item.loans || []
                                })),
                                pagination: {
                                    more: data.has_more || false
                                }
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0,
                    templateResult: function(customer) {
                        return customer.loading ? 'Loading...' : customer.text;
                    },
                    templateSelection: function(customer) {
                        return customer.text;
                    }
                });
                
                // Initialize loan_id Select2 - this is handled differently as it's populated based on customer selection
                $('#loan_id').select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Select a loan',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#fieldVisitModal')
                });
                
                // Define staff select configuration
                const staffSelect2Config = {
                    theme: 'bootstrap-5',
                    placeholder: 'Select a field officer',
                    allowClear: true,
                    width: '100%',
                    ajax: {
                        url: '/api/collection-schedules/staff',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            console.log('Sending staff search:', params.term);
                            return {
                                term: params.term || '',
                                page: params.page || 1,
                                role_type: 'officer'  // Match collection schedule approach
                            };
                        },
                        processResults: function(data) {
                            console.log('Received staff data:', data);
                            if (!data || !Array.isArray(data)) {
                                console.error('Expected data to be an array:', data);
                                return { results: [] };
                            }
                            // Format the results to match the collection schedule approach
                            return {
                                results: data.map(item => ({
                                    id: item.id,
                                    text: item.name,
                                    role: item.role,
                                    branchId: item.branch_id
                                }))
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0,
                    templateResult: function(officer) {
                        if (officer.loading) return 'Loading...';
                        return officer.text || officer.name;
                    },
                    templateSelection: function(officer) {
                        return officer.text || officer.name;
                    }
                };
                
                // Initialize field_officer_id Select2
                $('#field_officer_id').select2({
                    ...staffSelect2Config,
                    dropdownParent: $('#fieldVisitModal')
                });
                
                // Update hidden field_officer_name when selection changes
                $('#field_officer_id').on('select2:select', function(e) {
                    const selectedText = e.params.data.text || e.params.data.name || '';
                    $('#field_officer_name').val(selectedText);
                });
                
                // Clear field_officer_name when field officer is cleared
                $('#field_officer_id').on('select2:clear', function() {
                    $('#field_officer_name').val('');
                });
                
                // Define supervisor select configuration
                const supervisorSelect2Config = {
                    theme: 'bootstrap-5',
                    placeholder: 'Select a supervisor',
                    allowClear: true,
                    width: '100%',
                    ajax: {
                        url: '/api/collection-schedules/staff',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            console.log('Sending supervisor search:', params.term);
                            return {
                                term: params.term || '',
                                page: params.page || 1,
                                role_type: 'supervisor'  // Match collection schedule approach
                            };
                        },
                        processResults: function(data) {
                            console.log('Received supervisor data:', data);
                            if (!data || !Array.isArray(data)) {
                                console.error('Expected data to be an array:', data);
                                return { results: [] };
                            }
                            // Format the results to match the collection schedule approach
                            return {
                                results: data.map(item => ({
                                    id: item.id,
                                    text: item.name,
                                    role: item.role,
                                    branchId: item.branch_id
                                }))
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0,
                    templateResult: function(supervisor) {
                        if (supervisor.loading) return 'Loading...';
                        return supervisor.text || supervisor.name;
                    },
                    templateSelection: function(supervisor) {
                        return supervisor.text || supervisor.name;
                    }
                };
                
                // Initialize supervisor_id Select2
                $('#supervisor_id').select2({
                    ...supervisorSelect2Config,
                    dropdownParent: $('#fieldVisitModal')
                });
                
                // Update hidden supervisor_name when selection changes
                $('#supervisor_id').on('select2:select', function(e) {
                    const selectedText = e.params.data.text || e.params.data.name || '';
                    $('#supervisor_name').val(selectedText);
                });
                
                // Clear supervisor_name when supervisor is cleared
                $('#supervisor_id').on('select2:clear', function() {
                    $('#supervisor_name').val('');
                });
            }
            
            // When customer is selected, populate loans dropdown
            $('#customer_id').on('select2:select', function(e) {
                const customerId = e.params.data.id;
                const customerName = e.params.data.text || '';
                const customerLoans = e.params.data.loans || [];
                
                console.log('Selected customer:', e.params.data);
                console.log('Selected customer loans:', customerLoans);
                
                // Store customer name in hidden field
                $('#customer_name').val(customerName);
                
                // Clear loan dropdown
                $('#loan_id').empty();
                
                // Add default option
                $('#loan_id').append(new Option('Select a loan', '', true, true));
                
                // Add loans to dropdown
                if (customerLoans.length > 0) {
                    customerLoans.forEach(loan => {
                        // Format the loan balance with commas
                        const formattedBalance = formatCurrency(loan.OutstandingBalance);
                        
                        const option = new Option(
                            `${loan.LoanNo} - Balance: ${formattedBalance}`, 
                            loan.LoanAppID, 
                            false, 
                            false
                        );
                        $(option).data('loan', loan);
                        $('#loan_id').append(option);
                    });
                } else {
                    // Fetch loans from API
                    $.ajax({
                        url: `/api/customers/${customerId}/loans`,
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            if (data.loans && data.loans.length > 0) {
                                data.loans.forEach(loan => {
                                    // Format the loan balance with commas
                                    const formattedBalance = formatCurrency(loan.OutstandingBalance);
                                    
                                    const option = new Option(
                                        `${loan.LoanNo} - Balance: ${formattedBalance}`, 
                                        loan.LoanAppID, 
                                        false, 
                                        false
                                    );
                                    $(option).data('loan', loan);
                                    $('#loan_id').append(option);
                                });
                            } else {
                                $('#loan_id').append(new Option('No loans found', '', true, true));
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error fetching loans:', error);
                            $('#loan_id').append(new Option('Error loading loans', '', true, true));
                        }
                    });
                }
                
                // Trigger change to refresh Select2
                $('#loan_id').trigger('change');
            });
            
            // When loan is selected, populate loan details
            $('#loan_id').on('select2:select', function(e) {
                const loanId = e.params.data.id;
                const loan = $(e.params.data.element).data('loan');
                
                console.log('Selected loan:', loan);
                
                if (loan) {
                    // Store loan account number in hidden field
                    $('#loan_account_no').val(loan.LoanNo);
                    
                    // Store raw values in hidden fields for form submission
                    $('#raw_outstanding_balance').val(loan.OutstandingBalance);
                    $('#raw_days_in_arrears').val(loan.DaysInArrears || 0);
                    
                    // Update form fields with loan details
                    $('#outstanding_balance').val(formatCurrency(loan.OutstandingBalance));
                    
                    // Set days in arrears (if available, otherwise default to 0)
                    const daysInArrears = loan.DaysInArrears || 0;
                    $('#days_in_arrears').val(daysInArrears);
                    
                    // Calculate missed payments (1 per 30 days, minimum 1)
                    const missedPayments = Math.max(1, Math.ceil(daysInArrears / 30));
                    $('#missed_payments').val(missedPayments);
                    
                    // Set installment amount (use OutstandingBalance as fallback if InstallmentAmount is not available)
                    const installmentAmount = loan.InstallmentAmount || (loan.OutstandingBalance / 12);
                    $('#raw_installment_amount').val(installmentAmount);
                    $('#installment_amount').val(formatCurrency(installmentAmount));
                    
                    // Set priority based on days in arrears
                    let priorityValue = 'Low';
                    if (daysInArrears >= 90) priorityValue = 'Critical';
                    else if (daysInArrears >= 60) priorityValue = 'High';
                    else if (daysInArrears >= 30) priorityValue = 'Medium';
                    
                    $('#priority').val(priorityValue);
                } else {
                    // If loan data is not available in the option, fetch it
                    const customerId = $('#customer_id').val();
                    if (customerId && loanId) {
                        $.ajax({
                            url: `/api/customers/${customerId}/loans`,
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                if (data.loans && data.loans.length > 0) {
                                    const selectedLoan = data.loans.find(l => l.id == loanId);
                                    if (selectedLoan) {
                                        updateLoanDetailsInForm(selectedLoan);
                                    }
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Error fetching loan details:', error);
                            }
                        });
                    }
                }
            });
            
            // Helper function to format currency
            function formatCurrency(amount) {
                if (amount === undefined || amount === null) return 'N/A';
                
                // Remove any existing commas and convert to number
                const cleanAmount = parseFloat(String(amount).replace(/,/g, ''));
                if (isNaN(cleanAmount)) return 'N/A';
                
                // Format with commas and 2 decimal places
                return cleanAmount.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
            
            // Function to update loan details in the form
            function updateLoanDetailsInForm(loan) {
                console.log('Updating loan details in form:', loan);
                
                const outstandingBalance = loan.outstanding_balance || 0;
                const daysInArrears = loan.days_in_arrears || 0;
                
                // Calculate missed payments based on days in arrears (1 per 30 days)
                // Using Math.ceil to round up - if 31 days in arrears, that's 2 missed payments
                const missedPayments = Math.max(1, Math.ceil(daysInArrears / 30));
                
                // Use installment_amount if available, otherwise use outstanding_balance
                const installmentAmount = loan.installment_amount || outstandingBalance;
                
                console.log('Calculated values:', {
                    outstandingBalance,
                    daysInArrears,
                    missedPayments,
                    installmentAmount
                });
                
                // Set priority based on days in arrears
                let priorityValue = 'Low';
                if (daysInArrears >= 90) priorityValue = 'Critical';
                else if (daysInArrears >= 60) priorityValue = 'High';
                else if (daysInArrears >= 30) priorityValue = 'Medium';
                
                // Update form fields - using the correct IDs that match the HTML
                $('#outstanding_balance').val(formatCurrency(outstandingBalance));
                $('#days_in_arrears').val(daysInArrears);
                $('#missed_payments').val(missedPayments);
                $('#installment_amount').val(formatCurrency(installmentAmount));
                $('#priority').val(priorityValue);
                
                // Get customer name and loan account number
                // Get customer name from Select2 data or dropdown
                let customerName = $('#customer_name').val();
                if (!customerName) {
                    const customerData = $('#customer_id').select2('data')[0];
                    customerName = customerData ? (customerData.text || customerData.name || 'Unknown Customer') : 'Unknown Customer';
                    $('#customer_name').val(customerName);
                }
                
                // Get loan account number from Select2 data or dropdown
                let loanAccountNo = $('#loan_account_no').val();
                if (!loanAccountNo) {
                    const loanData = $('#loan_id').select2('data')[0];
                    if (loanData) {
                        const loanText = loanData.text || '';
                        loanAccountNo = loanText.split(' - ')[0].trim(); // Extract loan number from the option text
                    } else {
                        loanAccountNo = 'Unknown Loan';
                    }
                    $('#loan_account_no').val(loanAccountNo);
                }
                
                // Add hidden fields for form submission
                if (!$('#hidden_fields').length) {
                    const hiddenFields = `
                        <div id="hidden_fields">
                            <input type="hidden" name="raw_outstanding_balance" value="${outstandingBalance}">
                            <input type="hidden" name="raw_days_in_arrears" value="${daysInArrears}">
                            <input type="hidden" name="raw_installment_amount" value="${installmentAmount}">
                            <input type="hidden" name="outstanding_balance" value="${formatCurrency(outstandingBalance)}">
                            <input type="hidden" name="days_in_arrears" value="${daysInArrears}">
                            <input type="hidden" name="missed_payments" value="${missedPayments}">
                            <input type="hidden" name="installment_amount" value="${formatCurrency(installmentAmount)}">
                            <input type="hidden" name="customer_name" value="${customerName}">
                            <input type="hidden" name="loan_account_no" value="${loanAccountNo}">
                        </div>
                    `;
                    $('#fieldVisitForm').append(hiddenFields);
                } else {
                    $('#hidden_fields input[name="raw_outstanding_balance"]').val(outstandingBalance);
                    $('#hidden_fields input[name="raw_days_in_arrears"]').val(daysInArrears);
                    $('#hidden_fields input[name="raw_installment_amount"]').val(installmentAmount);
                    $('#hidden_fields input[name="outstanding_balance"]').val(formatCurrency(outstandingBalance));
                    $('#hidden_fields input[name="days_in_arrears"]').val(daysInArrears);
                    $('#hidden_fields input[name="missed_payments"]').val(missedPayments);
                    $('#hidden_fields input[name="installment_amount"]').val(formatCurrency(installmentAmount));
                    $('#hidden_fields input[name="customer_name"]').val(customerName);
                    $('#hidden_fields input[name="loan_account_no"]').val(loanAccountNo);
                }
            }
            
            // Handle form submission
            $('#fieldVisitForm').on('submit', function(e) {
                e.preventDefault();
                
                // Validate form
                if (!validateForm()) {
                    return false;
                }
                
                // Show loading state
                showLoading();
                
                // Create FormData object
                const formData = new FormData(this);
                
                // Ensure staff IDs are properly handled
                const fieldOfficerId = $('#field_officer_id').val();
                const supervisorId = $('#supervisor_id').val();
                
                // Convert IDs to integers (if they exist)
                if (fieldOfficerId) {
                    formData.set('field_officer_id', parseInt(fieldOfficerId, 10));
                }
                
                if (supervisorId) {
                    formData.set('supervisor_id', parseInt(supervisorId, 10));
                }
                
                // Set default branch ID
                formData.set('assigned_branch_id', 1);
                
                // Ensure customer name and loan account number are included
                const customerName = $('#customer_name').val() || 'Unknown Customer';
                const loanAccountNo = $('#loan_account_no').val() || 'Unknown Loan';
                
                formData.set('customer_name', customerName);
                formData.set('loan_account_no', loanAccountNo);
                
                console.log('Customer Name:', customerName);
                console.log('Loan Account No:', loanAccountNo);
                
                // Log form data for debugging
                console.log('Submitting form data...');
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ': ' + pair[1]);
                }
                
                // Check if we're in edit mode
                const isEditMode = $('#fieldVisitForm').attr('data-edit-mode') === 'true';
                let url = $(this).attr('action');
                let method = isEditMode ? 'PUT' : 'POST';
                
                // For edit mode, we need to handle the method override for Flask
                if (isEditMode) {
                    // Flask doesn't natively support PUT requests in forms
                    // We'll use POST but add a special header
                    method = 'POST';
                    // Remove any existing _method field to avoid duplicates
                    formData.delete('_method');
                    // Add the method override field that Flask will recognize
                    formData.append('_method', 'PUT');
                }
                
                // Submit form via AJAX
                $.ajax({
                    url: url,
                    type: method,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            Swal.fire({
                                title: 'Success!',
                                text: isEditMode ? 'Field visit updated successfully.' : 'Field visit scheduled successfully.',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then((result) => {
                                // Close modal
                                closeModal();
                                
                                // Reload page to show updated data
                                window.location.reload();
                            });
                        } else {
                            // Show error message
                            showError(response.message || 'An error occurred');
                        }
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error submitting form:', error);
                        
                        // Parse error response
                        let errorMessage = isEditMode ? 
                            'An error occurred while updating the field visit' : 
                            'An error occurred while scheduling the field visit';
                        
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMessage = response.error;
                                
                                // Highlight missing fields if provided
                                if (response.missing_fields) {
                                    response.missing_fields.forEach(field => {
                                        $(`[name=${field}]`).addClass('border-red-500');
                                    });
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        
                        // Show error message
                        showError(errorMessage);
                    }
                });
            });
            
            // Form validation function
            function validateForm() {
                // Reset validation errors
                $('.border-red-500').removeClass('border-red-500');
                $('.invalid-feedback').remove();
                
                // Check required fields
                let isValid = true;
                const requiredFields = ['customer_id', 'loan_id', 'field_officer_id', 'visit_date', 'visit_time', 'location', 'purpose', 'visit_notes'];
                
                requiredFields.forEach(field => {
                    const value = $(`[name=${field}]`).val();
                    if (!value) {
                        const element = $(`[name=${field}]`);
                        element.addClass('border-red-500');
                        // Add specific error message for ID fields
                        if (['customer_id', 'loan_id', 'field_officer_id'].includes(field)) {
                            element.after(`<div class="invalid-feedback d-block text-red-500">This field is required and must have a valid ID</div>`);
                        }
                        isValid = false;
                    }
                });
                
                if (!isValid) {
                    showError('Please fill in all required fields');
                }
                
                // Validate date format
                const visitDate = $('#visit_date').val();
                if (visitDate && !isValidDate(visitDate)) {
                    isValid = false;
                    $('#visit_date').addClass('border-red-500');
                    $('#visit_date').after(`<div class="invalid-feedback">Please enter a valid date (YYYY-MM-DD).</div>`);
                }
                
                // Validate time format
                const visitTime = $('#visit_time').val();
                if (visitTime && !isValidTime(visitTime)) {
                    isValid = false;
                    $('#visit_time').addClass('is-invalid');
                    $('#visit_time').after(`<div class="invalid-feedback">Please enter a valid time (HH:MM).</div>`);
                }
                
                return isValid;
            }
            
            // Date validation helper
            function isValidDate(dateString) {
                const regex = /^\d{4}-\d{2}-\d{2}$/;
                if (!regex.test(dateString)) return false;
                
                const date = new Date(dateString);
                return date instanceof Date && !isNaN(date);
            }
            
            // Time validation helper
            function isValidTime(timeString) {
                const regex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
                return regex.test(timeString);
            }
            
            // Tab switching functionality for status modals
            $(document).on('click', '.status-tab-btn', function() {
                const tabId = $(this).data('tab');
                
                // Update active tab button
                $('.status-tab-btn').removeClass('active border-white text-white').addClass('border-transparent text-blue-200');
                $(this).removeClass('border-transparent text-blue-200').addClass('active border-white text-white');
                
                // Show the selected tab content
                $('.status-tab-content').addClass('hidden');
                $(`#status-tab-${tabId}`).removeClass('hidden');
            });
            
            // Handle update status button clicks
            $(document).on('click', '.update-status-btn', function() {
                // Skip if button is disabled
                if ($(this).prop('disabled')) {
                    return;
                }
                
                // Get visit ID and current status
                const visitId = $(this).data('visit-id');
                const currentStatus = $(this).data('current-status') || '';
                
                console.log('Updating status for visit:', visitId, 'Current status:', currentStatus);
                
                // Set the visit ID in the form
                $('#update_visit_id').val(visitId);
                
                // Set the current status
                $('#current_status_value').val(currentStatus);
                $('#current_status').val(currentStatus.replace('_', ' ').charAt(0).toUpperCase() + currentStatus.replace('_', ' ').slice(1));
                
                // Update the status badge
                const badgeClass = getStatusBadgeClass(currentStatus);
                $('#current_status_badge').attr('class', 'px-2 py-1 text-xs font-medium rounded-full ' + badgeClass);
                $('#current_status_badge').text(currentStatus.replace('_', ' ').charAt(0).toUpperCase() + currentStatus.replace('_', ' ').slice(1));
                
                // Reset the new status dropdown
                $('#new_status').val('');
                $('#status_description').addClass('hidden');
                
                // Clear the notes field
                $('#status_notes').val('');
                
                // Reset tabs to show update status tab by default
                $('.status-tab-btn').removeClass('active border-white text-white').addClass('border-transparent text-blue-200');
                $('.status-tab-btn[data-tab="updateStatus"]').removeClass('border-transparent text-blue-200').addClass('active border-white text-white');
                $('.status-tab-content').addClass('hidden');
                $('#status-tab-updateStatus').removeClass('hidden');
                
                // Load status history data
                loadStatusHistory(visitId);
                
                // Load attachments data
                loadAttachments(visitId);
                
                // Show the modal
                $('#statusUpdateModal').removeClass('hidden');
            });
            
            // Function to get badge class based on status
            function getStatusBadgeClass(status) {
                switch(status) {
                    case 'scheduled':
                        return 'bg-yellow-100 text-yellow-800';
                    case 'in_progress':
                        return 'bg-blue-100 text-blue-800';
                    case 'completed':
                        return 'bg-green-100 text-green-800';
                    case 'cancelled':
                        return 'bg-red-100 text-red-800';
                    default:
                        return 'bg-gray-100 text-gray-800';
                }
            }
            
            // Handle status change to show description
            $('#new_status').on('change', function() {
                const selectedStatus = $(this).val();
                if (!selectedStatus) {
                    $('#status_description').addClass('hidden').text('');
                    return;
                }
                
                let description = '';
                switch(selectedStatus) {
                    case 'scheduled':
                        description = 'Visit is planned but has not started yet.';
                        break;
                    case 'in_progress':
                        description = 'Field officer is currently conducting the visit.';
                        break;
                    case 'completed':
                        description = 'Visit has been completed. A report can now be submitted.';
                        break;
                    case 'cancelled':
                        description = 'Visit has been cancelled and will not be conducted.';
                        break;
                }
                
                $('#status_description').removeClass('hidden').text(description);
            });
            
            // Handle close status update modal button click
            $('#closeStatusUpdateModal').on('click', function() {
                $('#statusUpdateModal').addClass('hidden');
            });
            
            // Handle status form submission
            $('#statusUpdateForm').on('submit', function(e) {
                e.preventDefault();
                
                const visitId = $('#update_visit_id').val();
                const newStatus = $('#new_status').val();
                const notes = $('#status_notes').val();
                const currentStatus = $('#current_status_value').val();
                
                if (!visitId || !newStatus) {
                    return;
                }
                
                // Disable the submit button to prevent double submission
                const submitBtn = $(this).find('button[type="submit"]');
                submitBtn.prop('disabled', true);
                
                // Show loading indicator
                submitBtn.html('<i class="fas fa-spinner fa-spin mr-2"></i> Updating...');
                
                // Create FormData object for file upload
                const formData = new FormData();
                formData.append('status', newStatus);
                formData.append('notes', notes);
                formData.append('previous_status', currentStatus);
                
                // Add CSRF token - get from the hidden input in the form
                const csrfToken = $('input[name="csrf_token"]').val() || $('meta[name="csrf-token"]').attr('content');
                formData.append('csrf_token', csrfToken);
                
                // Add file if selected
                const fileInput = document.getElementById('status_attachment');
                if (fileInput.files.length > 0) {
                    formData.append('attachment', fileInput.files[0]);
                    formData.append('attachment_type', 'status_update');
                }
                
                // Submit the form data
                $.ajax({
                    url: `/user/api/field-visits/${visitId}/status`,
                    type: 'POST',
                    data: formData,
                    processData: false,  // Important for FormData
                    contentType: false,  // Important for FormData
                    success: function(response) {
                        // Re-enable the submit button
                        submitBtn.prop('disabled', false);
                        submitBtn.html('<i class="fas fa-check mr-2"></i> Update Status');
                        
                        if (response.success) {
                            // Close the modal
                            $('#statusUpdateModal').addClass('hidden');
                            
                            // Show success message
                            showSuccess('Status updated successfully');
                            
                            // Update the status in the table
                            const statusCell = $(`tr[data-visit-id="${visitId}"] .status-cell`);
                            const badgeClass = getStatusBadgeClass(newStatus);
                            const formattedStatus = newStatus.charAt(0).toUpperCase() + newStatus.slice(1).replace('_', ' ');
                            
                            statusCell.html(`<span class="px-2 py-1 text-xs font-medium rounded-full ${badgeClass}">${formattedStatus}</span>`);
                            
                            // Update the button data attribute
                            $(`.update-status-btn[data-visit-id="${visitId}"]`).data('current-status', newStatus);
                            
                            // Update the last updated timestamp if available
                            if (response.visit && response.visit.updated_at) {
                                const updatedAtCell = $(`tr[data-visit-id="${visitId}"] .updated-at-cell`);
                                if (updatedAtCell.length) {
                                    updatedAtCell.text(response.visit.updated_at);
                                }
                            }
                            
                            // Refresh both the status history and attachments tabs
                            loadStatusHistory(visitId);
                            loadAttachments(visitId);
                            
                            // Calculate missed payments based on days in arrears - per memory requirements
                            const daysInArrears = parseInt($(`tr[data-visit-id="${visitId}"]`).data('days-in-arrears')) || 0;
                            if (daysInArrears > 0) {
                                const missedPayments = Math.ceil(daysInArrears / 30);
                                const missedPaymentsCell = $(`tr[data-visit-id="${visitId}"] .missed-payments-cell`);
                                if (missedPaymentsCell.length) {
                                    missedPaymentsCell.text(missedPayments);
                                }
                            }
                        } else {
                            // Show error message
                            showError(response.message || 'Failed to update status');
                        }
                    },
                    error: function(xhr, status, error) {
                        // Re-enable the submit button
                        submitBtn.prop('disabled', false);
                        submitBtn.html('<i class="fas fa-check mr-2"></i> Update Status');
                        
                        // Show error message
                        showError('An error occurred while updating the status');
                        console.error('Error updating status:', error);
                    }
                });
            });
            
            // Handle add report button clicks
            // Handle update status button click (opens the status update modal)
            $(document).on('click', '.add-status-history-btn', function() {
                // Skip if button is disabled
                if ($(this).prop('disabled')) {
                    return;
                }
                
                const visitId = $(this).data('visit-id');
                const currentStatus = $(this).data('status') || 'scheduled';
                console.log('Updating status for visit:', visitId, 'Current status:', currentStatus);
                
                // Set values in the report modal
                $('#report_visit_id').val(visitId);
                $('#previous_status').val(currentStatus);
                
                // Update status description and progress bar
                let statusDesc = '';
                let progressPercent = 0;
                
                switch(currentStatus) {
                    case 'scheduled': 
                        statusDesc = 'Scheduled'; 
                        progressPercent = 25;
                        break;
                    case 'in-progress': 
                        statusDesc = 'In Progress'; 
                        progressPercent = 50;
                        break;
                    case 'completed': 
                        statusDesc = 'Completed'; 
                        progressPercent = 100;
                        break;
                    case 'cancelled': 
                        statusDesc = 'Cancelled'; 
                        progressPercent = 0;
                        break;
                    default: 
                        statusDesc = currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1);
                        progressPercent = 25;
                }
                
                // Update the status description with an icon
                let statusIcon = '';
                let statusColor = '';
                
                if (currentStatus === 'scheduled') {
                    statusIcon = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>';
                    statusColor = 'text-yellow-700';
                } else if (currentStatus === 'in-progress') {
                    statusIcon = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                    statusColor = 'text-blue-700';
                } else if (currentStatus === 'completed') {
                    statusIcon = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                    statusColor = 'text-green-700';
                } else if (currentStatus === 'cancelled') {
                    statusIcon = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                    statusColor = 'text-red-700';
                }
                
                $('#status_description').html('<span class="flex items-center ' + statusColor + '">' + statusIcon + statusDesc + '</span>');
                
                // Update the progress bar
                $('.status-progress-bar').css('width', progressPercent + '%');
                
                // Change progress bar color based on status
                if (currentStatus === 'cancelled') {
                    $('.status-progress-bar').removeClass('bg-blue-600').addClass('bg-red-600');
                } else if (currentStatus === 'completed') {
                    $('.status-progress-bar').removeClass('bg-blue-600').addClass('bg-green-600');
                } else {
                    $('.status-progress-bar').removeClass('bg-red-600 bg-green-600').addClass('bg-blue-600');
                }
                
                // Clear previous inputs
                $('#new_status').val('');
                $('#visit_notes').val('');
                $('#attachment_type').val('');
                $('#attachment_description').val('');
                $('#report_attachment').val('');
                
                // Show the report modal
                $('#reportModal').removeClass('hidden');
            });
            
            // Handle close report modal button click
            $('#closeReportModal').on('click', function() {
                $('#reportModal').addClass('hidden');
            });
            
            // Handle close status modal button click
            $('#closeStatusModal').on('click', function() {
                $('#statusModal').addClass('hidden');
            });
            
            // Handle view status history button click
            $(document).on('click', '.view-status-history-btn', function() {
                const visitId = $(this).data('visit-id');
                console.log('Viewing status history for visit:', visitId);
                
                // Show the status history modal first
                $('#statusModal').removeClass('hidden');
                $('#status-tab-statusHistory').removeClass('hidden');
                $('#status-tab-attachments').addClass('hidden');
                $('#status-tab-btn-statusHistory').addClass('bg-white').removeClass('bg-gray-200');
                $('#status-tab-btn-attachments').removeClass('bg-white').addClass('bg-gray-200');
                
                // Show loading state
                showLoading();
                
                // Show loading indicator in the status history table
                $('#statusHistoryTableBody').html(`
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                            <div class="flex flex-col items-center justify-center py-6">
                                <i class="fas fa-spinner fa-spin text-blue-500 text-4xl mb-3"></i>
                                <p>Loading status history...</p>
                            </div>
                        </td>
                    </tr>
                `);
                
                // Fetch status history from the API
                console.log(`Fetching status history from: /user/api/field-visits/${visitId}/status-history`);
                $.ajax({
                    url: `/user/api/field-visits/${visitId}/status-history`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        hideLoading();
                        console.log('Status history API response:', response);
                        
                        // Clear previous history
                        $('#statusHistoryTableBody').empty();
                        
                        if (response && response.success && response.history && response.history.length > 0) {
                            
                            // Populate the status history table
                            response.history.forEach(function(record) {
                                // Format the status for display (with error handling)
                                const previousStatus = record.previous_status ? 
                                    record.previous_status.charAt(0).toUpperCase() + record.previous_status.slice(1) : 'Unknown';
                                const newStatus = record.new_status ? 
                                    record.new_status.charAt(0).toUpperCase() + record.new_status.slice(1) : 'Unknown';
                                
                                // Create status badge HTML
                                let statusBadgeHtml = '';
                                if (record.new_status === 'scheduled') {
                                    statusBadgeHtml = `<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">${newStatus}</span>`;
                                } else if (record.new_status === 'in-progress') {
                                    statusBadgeHtml = `<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${newStatus}</span>`;
                                } else if (record.new_status === 'completed') {
                                    statusBadgeHtml = `<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${newStatus}</span>`;
                                } else if (record.new_status === 'cancelled') {
                                    statusBadgeHtml = `<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">${newStatus}</span>`;
                                } else {
                                    statusBadgeHtml = `<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">${newStatus}</span>`;
                                }
                                
                                // Add row to the table
                                $('#statusHistoryTableBody').append(`
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.created_at}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${previousStatus}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${statusBadgeHtml}</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">${record.notes || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.created_by_name || 'System'}</td>
                                    </tr>
                                `);
                            });
                            
                            // Also load attachments for this visit
                            loadAttachments(visitId);
                        } else {
                            // Show no history message in the table
                            $('#statusHistoryTableBody').html(`
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                                        <div class="flex flex-col items-center justify-center py-6">
                                            <i class="fas fa-history text-gray-300 text-4xl mb-3"></i>
                                            <p>No status history records found for this field visit.</p>
                                        </div>
                                    </td>
                                </tr>
                            `);
                        }
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error fetching status history:', error);
                        // Show error message in the table
                        $('#statusHistoryTableBody').html(`
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-sm text-red-500">
                                    <div class="flex flex-col items-center justify-center py-6">
                                        <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-3"></i>
                                        <p>Error loading status history. Please try again.</p>
                                    </div>
                                </td>
                            </tr>
                        `);
                    }
                });
            });
            
            // Handle report form submission
            $('#reportForm').on('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const formData = new FormData(this);
                const visitId = $('#report_visit_id').val();
                
                // Validate form
                if (!$('#new_status').val()) {
                    Swal.fire({
                        title: 'Error',
                        text: 'Please select a new status',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                if (!$('#status_notes').val()) {
                    Swal.fire({
                        title: 'Error',
                        text: 'Please enter notes about this status change',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Add created_by to the form data if available from session
                if (typeof currentUserId !== 'undefined') {
                    formData.append('created_by', currentUserId);
                }
                
                // Show loading state
                showLoading();
                
                // Submit form via AJAX
                $.ajax({
                    url: `/user/api/field-visits/${visitId}/status`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        hideLoading();
                        
                        if (response.success) {
                            // Show success message
                            Swal.fire({
                                title: 'Status Updated!',
                                text: 'Field visit status has been updated successfully.',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then((result) => {
                                // Close modal
                                $('#reportModal').addClass('hidden');
                                
                                // Reload page to show updated data
                                window.location.reload();
                            });
                        } else {
                            console.error('Failed to update visit status:', response);
                            Swal.fire({
                                title: 'Error',
                                text: response.message || 'Failed to update field visit status',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error updating visit status:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'An error occurred while updating field visit status',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });
            
            // Handle update button clicks
            $(document).on('click', '.update-visit-btn', function() {
                const visitId = $(this).data('visit-id');
                const customerId = $(this).data('customer-id');
                const customerName = $(this).data('customer-name');
                console.log('Updating visit:', visitId);
                
                // Show loading indicator
                showLoading();
                
                // Fetch the field visit data
                $.ajax({
                    url: `/user/api/field-visits/${visitId}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        hideLoading();
                        if (response.success) {
                            const visit = response.visit;
                            
                            // Show the report modal
                            $('#reportModal').removeClass('hidden');
                            
                            // Set form values
                            $('#report_visit_id').val(visitId);
                            $('#previous_status').val(visit.status);
                            $('#new_status').val(visit.status);
                            $('#status_description').text(visit.status_description || 'Not available');
                            
                            // Update progress bar
                            const progressBar = $('.status-progress-bar');
                            const progressPercentage = getStatusProgressPercentage(visit.status);
                            progressBar.css('width', `${progressPercentage}%`);
                            
                            // Debug: Log the visit data to see what we're receiving
                            console.log('Visit data received:', visit);
                            console.log('Location:', visit.location);
                            console.log('Alternative Contact:', visit.alternative_contact);
                            console.log('Special Instructions:', visit.special_instructions);
                            console.log('Attachment:', visit.attachment);
                            
                            // Update the form title to indicate edit mode
                            $('#fieldVisitModal h3').text('Edit Field Visit');
                            $('#fieldVisitModal p').text('Update field visit details');
                            
                            // Set form to edit mode
                            $('#fieldVisitForm').attr('action', `/user/api/field-visits/${visitId}`);
                            $('#fieldVisitForm').attr('data-edit-mode', 'true');
                            $('#fieldVisitForm').append(`<input type='hidden' name='_method' value='PUT'>`);
                            
                            // Populate the form with visit data
                            // Customer information - make it editable like in add new field visit
                            // Initialize the customer dropdown with Select2
                            $('#customer_id').select2({
                                theme: 'bootstrap-5',
                                placeholder: 'Search for a customer...',
                                allowClear: true,
                                width: '100%',
                                dropdownParent: $('#fieldVisitModal'),
                                ajax: {
                                    url: '/api/customers/search',
                                    dataType: 'json',
                                    delay: 250,
                                    data: function(params) {
                                        return {
                                            q: params.term || '',
                                            page: params.page || 1,
                                            per_page: 10
                                        };
                                    },
                                    processResults: function(data) {
                                        console.log('Customer data received:', data);
                                        
                                        if (!data || !Array.isArray(data.items)) {
                                            console.error('Invalid customer data format:', data);
                                            return { results: [] };
                                        }
                                        
                                        return {
                                            results: data.items.map(item => ({
                                                id: item.id,
                                                text: item.text,
                                                loans: item.loans || []
                                            })),
                                            pagination: {
                                                more: data.has_more || false
                                            }
                                        };
                                    },
                                    cache: true
                                },
                                minimumInputLength: 0,
                                templateResult: function(customer) {
                                    return customer.loading ? 'Loading...' : customer.text;
                                },
                                templateSelection: function(customer) {
                                    return customer.text;
                                }
                            });
                            
                            // Set the current customer
                            const customerOption = new Option(visit.customer_name, visit.customer_id, true, true);
                            $('#customer_id').append(customerOption).trigger('change');
                            $('#customer_name').val(visit.customer_name);
                            
                            // Create customer data object for loan selection
                            const customerData = {
                                id: visit.customer_id,
                                text: visit.customer_name,
                                loans: [{
                                    id: visit.loan_account_no,
                                    text: visit.loan_account_no,
                                    OutstandingBalance: visit.outstanding_balance,
                                    DaysInArrears: visit.days_in_arrears,
                                    InstallmentAmount: visit.installment_amount
                                }]
                            };
                            
                            // Store customer data for loan selection
                            $('#customer_id').data('customerData', customerData);
                            
                            // Add event listener for customer selection changes
                            $('#customer_id').on('select2:select', function(e) {
                                const customerId = e.params.data.id;
                                const customerName = e.params.data.text;
                                
                                // Update hidden customer name field
                                $('#customer_name').val(customerName);
                                
                                // Clear and disable loan dropdown until loans are loaded
                                $('#loan_id').empty().prop('disabled', true);
                                $('#loan_id').append(new Option('Loading loans...', '')).trigger('change');
                                
                                // Clear loan details
                                $('#outstanding_balance').val('');
                                $('#raw_outstanding_balance').val('');
                                $('#days_in_arrears').val('');
                                $('#raw_days_in_arrears').val('');
                                $('#missed_payments').val('');
                                $('#installment_amount').val('');
                                $('#raw_installment_amount').val('');
                                
                                // Fetch customer loans
                                $.ajax({
                                    url: `/user/api/customers/${customerId}/loans`,
                                    type: 'GET',
                                    dataType: 'json',
                                    success: function(response) {
                                        if (response.success && response.loans) {
                                            // Enable loan dropdown
                                            $('#loan_id').empty().prop('disabled', false);
                                            $('#loan_id').append(new Option('Select a loan', '')).trigger('change');
                                            
                                            // Store loans data for later use
                                            const customerData = {
                                                id: customerId,
                                                text: customerName,
                                                loans: response.loans
                                            };
                                            $('#customer_id').data('customerData', customerData);
                                            
                                            // Add loans to dropdown
                                            response.loans.forEach(function(loan) {
                                                const option = new Option(loan.text, loan.id, false, false);
                                                $('#loan_id').append(option);
                                            });
                                            
                                            $('#loan_id').trigger('change');
                                        } else {
                                            // No loans found
                                            $('#loan_id').empty().prop('disabled', false);
                                            $('#loan_id').append(new Option('No loans found', '')).trigger('change');
                                        }
                                    },
                                    error: function() {
                                        console.error('Failed to fetch loans for customer');
                                        $('#loan_id').empty().prop('disabled', false);
                                        $('#loan_id').append(new Option('Error loading loans', '')).trigger('change');
                                    }
                                });
                            });
                            
                            // Initialize the loan dropdown with Select2 like in add new field visit
                            $('#loan_id').select2({
                                theme: 'bootstrap-5',
                                placeholder: 'Select a loan',
                                allowClear: true,
                                width: '100%',
                                dropdownParent: $('#fieldVisitModal')
                            });
                            
                            // Remove any existing event listeners to prevent duplicates
                            $('#customer_id').off('select2:select');
                            
                            // Add event listener for customer selection changes - exactly like in add new field visit
                            $('#customer_id').on('select2:select', function(e) {
                                const customerId = e.params.data.id;
                                const customerName = e.params.data.text || '';
                                const customerLoans = e.params.data.loans || [];
                                
                                console.log('Selected customer:', e.params.data);
                                console.log('Selected customer loans:', customerLoans);
                                
                                // Store customer name in hidden field
                                $('#customer_name').val(customerName);
                                
                                // Clear loan dropdown
                                $('#loan_id').empty();
                                
                                // Add default option
                                $('#loan_id').append(new Option('Select a loan', '', true, true));
                                
                                // Add loans to dropdown
                                if (customerLoans.length > 0) {
                                    customerLoans.forEach(loan => {
                                        // Format the loan balance with commas
                                        const formattedBalance = formatCurrency(loan.OutstandingBalance);
                                        
                                        const option = new Option(
                                            `${loan.LoanNo} - Balance: ${formattedBalance}`, 
                                            loan.LoanAppID, 
                                            false, 
                                            false
                                        );
                                        $(option).data('loan', loan);
                                        $('#loan_id').append(option);
                                    });
                                } else {
                                    // If no loans, fetch them from the API - use the same API endpoint as in add new field visit
                                    $.ajax({
                                        url: `/api/customers/${customerId}/loans`,
                                        type: 'GET',
                                        dataType: 'json',
                                        success: function(data) {
                                            console.log('Loans API response:', data);
                                            if (data.loans && data.loans.length > 0) {
                                                data.loans.forEach(loan => {
                                                    // Format the loan balance with commas
                                                    const formattedBalance = formatCurrency(loan.OutstandingBalance);
                                                    
                                                    const option = new Option(
                                                        `${loan.LoanNo} - Balance: ${formattedBalance}`, 
                                                        loan.LoanAppID, 
                                                        false, 
                                                        false
                                                    );
                                                    $(option).data('loan', loan);
                                                    $('#loan_id').append(option);
                                                });
                                            } else {
                                                $('#loan_id').append(new Option('No loans found', '', true, true));
                                            }
                                        },
                                        error: function(xhr, status, error) {
                                            console.error('Error fetching loans:', error);
                                            $('#loan_id').append(new Option('Error loading loans', '', true, true));
                                        }
                                    });
                                }
                                
                                // Trigger change to refresh Select2
                                $('#loan_id').trigger('change');
                            });
                            
                            // Add event listener for loan selection changes - exactly like in add new field visit
                            $('#loan_id').on('select2:select', function(e) {
                                const loanId = e.params.data.id;
                                const loan = $(e.params.data.element).data('loan');
                                
                                console.log('Selected loan:', loan);
                                
                                if (loan) {
                                    // Store loan account number in hidden field
                                    $('#loan_account_no').val(loan.LoanNo);
                                    
                                    // Store raw values in hidden fields for form submission
                                    $('#raw_outstanding_balance').val(loan.OutstandingBalance);
                                    $('#raw_days_in_arrears').val(loan.DaysInArrears || 0);
                                    
                                    // Update form fields with loan details
                                    $('#outstanding_balance').val(formatCurrency(loan.OutstandingBalance));
                                    
                                    // Set days in arrears (if available, otherwise default to 0)
                                    const daysInArrears = loan.DaysInArrears || 0;
                                    $('#days_in_arrears').val(daysInArrears);
                                    
                                    // Calculate missed payments (1 per 30 days, minimum 1) - per memory requirements
                                    const missedPayments = Math.ceil(daysInArrears / 30);
                                    $('#missed_payments').val(missedPayments);
                                    
                                    // Set installment amount (use OutstandingBalance as fallback if InstallmentAmount is not available)
                                    const installmentAmount = loan.InstallmentAmount || loan.OutstandingBalance || 0;
                                    $('#raw_installment_amount').val(installmentAmount);
                                    $('#installment_amount').val(formatCurrency(installmentAmount));
                                    
                                    // Set priority based on days in arrears
                                    let priorityValue = 'Low';
                                    if (daysInArrears >= 90) priorityValue = 'Critical';
                                    else if (daysInArrears >= 60) priorityValue = 'High';
                                    else if (daysInArrears >= 30) priorityValue = 'Medium';
                                    
                                    $('#priority').val(priorityValue);
                                } else {
                                    // If loan data is not available in the option, fetch it
                                    const customerId = $('#customer_id').val();
                                    if (customerId && loanId) {
                                        $.ajax({
                                            url: `/api/customers/${customerId}/loans`,
                                            type: 'GET',
                                            dataType: 'json',
                                            success: function(data) {
                                                if (data.loans && data.loans.length > 0) {
                                                    const selectedLoan = data.loans.find(l => l.LoanAppID == loanId);
                                                    if (selectedLoan) {
                                                        // Store loan account number in hidden field
                                                        $('#loan_account_no').val(selectedLoan.LoanNo);
                                                        
                                                        // Update form fields with loan details
                                                        $('#outstanding_balance').val(formatCurrency(selectedLoan.OutstandingBalance));
                                                        $('#raw_outstanding_balance').val(selectedLoan.OutstandingBalance);
                                                        
                                                        const daysInArrears = selectedLoan.DaysInArrears || 0;
                                                        $('#days_in_arrears').val(daysInArrears);
                                                        $('#raw_days_in_arrears').val(daysInArrears);
                                                        
                                                        const missedPayments = Math.ceil(daysInArrears / 30);
                                                        $('#missed_payments').val(missedPayments);
                                                        
                                                        const installmentAmount = selectedLoan.InstallmentAmount || selectedLoan.OutstandingBalance || 0;
                                                        $('#installment_amount').val(formatCurrency(installmentAmount));
                                                        $('#raw_installment_amount').val(installmentAmount);
                                                    }
                                                }
                                            }
                                        });
                                    }
                                }
                            });
                            
                            // Set the current loan - create a proper loan option with all the data
                            // Create a loan object similar to what we get from the API
                            const loanData = {
                                LoanAppID: visit.loan_id,
                                LoanNo: visit.loan_account_no,
                                OutstandingBalance: visit.outstanding_balance,
                                DaysInArrears: visit.days_in_arrears,
                                InstallmentAmount: visit.installment_amount
                            };
                            
                            // Format the loan balance with commas for display
                            const formattedBalance = formatCurrency(visit.outstanding_balance);
                            
                            // Create the loan option with formatted text
                            const loanOption = new Option(
                                `${visit.loan_account_no} - Balance: ${formattedBalance}`,
                                visit.loan_id,
                                true,
                                true
                            );
                            
                            // Attach the loan data to the option for later use
                            $(loanOption).data('loan', loanData);
                            
                            // Add the option to the dropdown and trigger change
                            $('#loan_id').append(loanOption).trigger('change');
                            
                            // Set the hidden loan account number field
                            $('#loan_account_no').val(visit.loan_account_no);
                            
                            // Loan details - make them editable
                            // Outstanding Balance - editable with proper formatting
                            const outstandingBalance = visit.outstanding_balance || 0;
                            $('#outstanding_balance').val(formatCurrency(outstandingBalance));
                            $('#raw_outstanding_balance').val(outstandingBalance);
                            $('#outstanding_balance').prop('readonly', false);
                            
                            // Days in Arrears - editable
                            const daysInArrears = visit.days_in_arrears || 0;
                            $('#days_in_arrears').val(daysInArrears);
                            $('#raw_days_in_arrears').val(daysInArrears);
                            $('#days_in_arrears').prop('readonly', false);
                            
                            // Calculate missed payments based on days in arrears per memory requirements
                            const missedPayments = Math.ceil(daysInArrears / 30);
                            $('#missed_payments').val(missedPayments);
                            $('#missed_payments').prop('readonly', false);
                            
                            // Installment Amount - editable with proper formatting
                            // Use outstanding_balance as fallback if installment_amount is not available
                            const installmentAmount = visit.installment_amount || visit.outstanding_balance || 0;
                            $('#installment_amount').val(formatCurrency(installmentAmount));
                            $('#raw_installment_amount').val(installmentAmount);
                            $('#installment_amount').prop('readonly', false);
                            
                            // Add event listener to days_in_arrears to update missed_payments
                            $('#days_in_arrears').on('input', function() {
                                const daysValue = parseInt($(this).val()) || 0;
                                const missedPaymentsValue = Math.ceil(daysValue / 30);
                                $('#missed_payments').val(missedPaymentsValue);
                                $('#raw_days_in_arrears').val(daysValue);
                            });
                            
                            // Visit details
                            $('#purpose').val(visit.purpose);
                            $('#priority').val(visit.priority);
                            $('#visit_date').val(visit.visit_date);
                            $('#visit_time').val(visit.visit_time);
                            
                            // Set location field (using correct ID 'visitLocation')
                            console.log('Location field exists:', $('#visitLocation').length > 0);
                            if ($('#visitLocation').length > 0) {
                                $('#visitLocation').val(visit.location);
                                console.log('Location set to:', visit.location);
                            } else {
                                console.error('Location field not found in the form');
                            }
                            
                            // Staff assignments - make fully editable with Select2
                            // Initialize field officer dropdown with Select2 and AJAX loading
                            $('#field_officer_id').select2({
                                theme: 'bootstrap-5',
                                width: '100%',
                                placeholder: 'Search for Field Officer',
                                minimumInputLength: 0,
                                dropdownParent: $('#fieldVisitModal'),
                                ajax: {
                                    url: '/api/collection-schedules/staff',
                                    dataType: 'json',
                                    delay: 250,
                                    data: function(params) {
                                        console.log('Sending staff search:', params.term);
                                        return {
                                            term: params.term || '',
                                            page: params.page || 1,
                                            role_type: 'officer'  // Match collection schedule approach
                                        };
                                    },
                                    processResults: function(data) {
                                        console.log('Received staff data:', data);
                                        if (!data || !Array.isArray(data)) {
                                            console.error('Expected data to be an array:', data);
                                            return { results: [] };
                                        }
                                        // Format the results to match the collection schedule approach
                                        return {
                                            results: data.map(item => ({
                                                id: item.id,
                                                text: item.name,
                                                role: item.role,
                                                branchId: item.branch_id
                                            }))
                                        };
                                    },
                                    cache: true
                                },
                                templateResult: formatStaff,
                                templateSelection: formatStaffSelection
                            });
                            
                            // Initialize supervisor dropdown with Select2 and AJAX loading
                            $('#supervisor_id').select2({
                                theme: 'bootstrap-5',
                                width: '100%',
                                placeholder: 'Search for Supervisor',
                                minimumInputLength: 0,
                                dropdownParent: $('#fieldVisitModal'),
                                ajax: {
                                    url: '/api/collection-schedules/staff',
                                    dataType: 'json',
                                    delay: 250,
                                    data: function(params) {
                                        return {
                                            term: params.term || '',
                                            page: params.page || 1,
                                            role_type: 'supervisor'  // Match collection schedule approach
                                        };
                                    },
                                    processResults: function(data) {
                                        if (!data || !Array.isArray(data)) {
                                            console.error('Expected supervisor data to be an array:', data);
                                            return { results: [] };
                                        }
                                        // Format the results to match the collection schedule approach
                                        return {
                                            results: data.map(item => ({
                                                id: item.id,
                                                text: item.name,
                                                role: item.role,
                                                branchId: item.branch_id
                                            }))
                                        };
                                    },
                                    cache: true
                                },
                                templateResult: formatStaff,
                                templateSelection: formatStaffSelection
                            });
                            
                            // Set the current field officer
                            if (visit.field_officer_id && visit.field_officer_name) {
                                const fieldOfficerOption = new Option(visit.field_officer_name, visit.field_officer_id, true, true);
                                $('#field_officer_id').append(fieldOfficerOption).trigger('change');
                                $('#field_officer_name').val(visit.field_officer_name);
                            }
                            
                            // Set the current supervisor
                            if (visit.supervisor_id && visit.supervisor_name) {
                                const supervisorOption = new Option(visit.supervisor_name, visit.supervisor_id, true, true);
                                $('#supervisor_id').append(supervisorOption).trigger('change');
                                $('#supervisor_name').val(visit.supervisor_name);
                            }
                            
                            // Add event listeners for field officer selection
                            $('#field_officer_id').on('select2:select', function(e) {
                                const staffId = e.params.data.id;
                                const staffName = e.params.data.text;
                                $('#field_officer_name').val(staffName);
                            });
                            
                            // Add event listeners for supervisor selection
                            $('#supervisor_id').on('select2:select', function(e) {
                                const staffId = e.params.data.id;
                                const staffName = e.params.data.text;
                                $('#supervisor_name').val(staffName);
                            });
                            
                            // Additional information
                            // Set alternative contact field (using correct ID 'alternativeContact')
                            console.log('Alternative contact field exists:', $('#alternativeContact').length > 0);
                            if ($('#alternativeContact').length > 0) {
                                $('#alternativeContact').val(visit.alternative_contact);
                                console.log('Alternative contact set to:', visit.alternative_contact);
                            } else {
                                console.error('Alternative contact field not found in the form');
                            }
                            
                            $('#visit_notes').val(visit.notes);
                            
                            // Set special instructions field (using correct ID 'instructions')
                            console.log('Special instructions field exists:', $('#instructions').length > 0);
                            if ($('#instructions').length > 0) {
                                $('#instructions').val(visit.special_instructions);
                                console.log('Special instructions set to:', visit.special_instructions);
                            } else {
                                console.error('Special instructions field not found in the form');
                            }
                            
                            // Handle attachment/uploaded file
                            if (visit.attachment) {
                                console.log('Attachment exists:', visit.attachment);
                                
                                // Create a container for the current attachment if it doesn't exist
                                if (!$('#current-attachment-container').length) {
                                    const attachmentContainer = `
                                    <div id="current-attachment-container" class="mt-4 p-3 border border-gray-300 rounded-md">
                                        <h4 class="text-sm font-medium text-gray-700 mb-2">Current Attachment</h4>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                                                <span id="current-attachment-name" class="text-sm text-gray-700"></span>
                                            </div>
                                            <div class="flex space-x-2">
                                                <a id="view-attachment-link" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                                                    <i class="fas fa-eye mr-1"></i> View
                                                </a>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">Upload a new file to replace the current attachment</p>
                                        <input type="hidden" id="current_attachment_path" name="current_attachment_path" value="">
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label for="attachment_type" class="block text-sm font-medium text-gray-700">Attachment Type</label>
                                                <select id="attachment_type" name="attachment_type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                    <option value="">Select attachment type</option>
                                                    <option value="report">Visit Report</option>
                                                    <option value="photo">Photo Evidence</option>
                                                    <option value="receipt">Payment Receipt</option>
                                                    <option value="document">Legal Document</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label for="attachment_description" class="block text-sm font-medium text-gray-700">Attachment Description</label>
                                                <input type="text" id="attachment_description" name="description" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Brief description of the attachment">
                                            </div>
                                            
                                            <div>
                                            <label for="report_attachment" class="block text-sm font-medium text-gray-700">Attachment File</label>
                                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                                <div class="space-y-1 text-center">
                                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                    </svg>
                                                    <div class="flex text-sm text-gray-600">
                                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                                            <span>Upload a file</span>
                                                            <input id="file-upload" name="attachment" type="file" class="sr-only">
                                                        </label>
                                                        <p class="pl-1">or drag and drop</p>
                                                    </div>
                                                    <p class="text-xs text-gray-500">
                                                        PNG, JPG, PDF up to 10MB
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                    
                                    // Add the container before the attachment field (using correct ID 'visitAttachment')
                                    $('#visitAttachment').closest('.mt-1').before(attachmentContainer);
                                    console.log('Attachment container added');
                                }
                                
                                // Extract filename from path
                                const filename = visit.attachment.split('/').pop();
                                $('#current-attachment-name').text(filename);
                                $('#view-attachment-link').attr('href', visit.attachment);
                                $('#current_attachment_path').val(visit.attachment);
                            }
                            
                            // Status dropdown (only available in edit mode)
                            if (!$('#status').length) {
                                const statusField = `
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-4 py-3" required>
                                        <option value="scheduled" ${visit.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                        <option value="in_progress" ${visit.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="completed" ${visit.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="cancelled" ${visit.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                                `;
                                $('#special_instructions').closest('.grid').append(statusField);
                            } else {
                                $('#status').val(visit.status);
                            }
                            
                            // Update submit button text
                            $('#submitFieldVisit').text('Update Field Visit');
                            
                            // Show the modal
                            openModal();
                        } else {
                            showError(response.message || 'Failed to load visit details');
                        }
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error fetching visit details:', error);
                        showError('Failed to load visit details');
                    }
                });
            })
            
            // Function to reset the form
            function resetForm() {
                $('#fieldVisitForm')[0].reset();
                $('#customer_id').val(null).trigger('change');
                $('#loan_id').val(null).trigger('change');
                $('#field_officer_id').val(null).trigger('change');
                $('#supervisor_id').val(null).trigger('change');
                $('.is-invalid').removeClass('is-invalid');
                $('.invalid-feedback').remove();
                $('#hidden_fields').remove();
            }
            
            // Function to load status history data
            function loadStatusHistory(visitId) {
                // Show loading indicator in the status history tab
                $('#statusHistoryTableBody').html(`
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                            <div class="flex flex-col items-center justify-center py-6">
                                <i class="fas fa-spinner fa-spin text-blue-500 text-4xl mb-3"></i>
                                <p>Loading status history...</p>
                            </div>
                        </td>
                    </tr>
                `);
                
                // Fetch status history data from API
                $.ajax({
                    url: `/user/api/field-visits/${visitId}/status-history`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response.success && response.history && response.history.length > 0) {
                            // Clear the loading indicator
                            $('#statusHistoryTableBody').empty();
                            
                            // Add each history record to the table
                            response.history.forEach(function(record) {
                                const previousStatusBadge = getStatusBadgeHtml(record.previous_status);
                                const newStatusBadge = getStatusBadgeHtml(record.new_status);
                                
                                $('#statusHistoryTableBody').append(`
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.created_at}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">${previousStatusBadge}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm">${newStatusBadge}</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">${record.notes || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.created_by_name || 'System'}</td>
                                    </tr>
                                `);
                            });
                        } else {
                            // Show no data message
                            $('#statusHistoryTableBody').html(`
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                                        <div class="flex flex-col items-center justify-center py-6">
                                            <i class="fas fa-history text-gray-300 text-4xl mb-3"></i>
                                            <p>No status history available</p>
                                        </div>
                                    </td>
                                </tr>
                            `);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading status history:', error);
                        // Show error message
                        $('#statusHistoryTableBody').html(`
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-sm text-red-500">
                                    <div class="flex flex-col items-center justify-center py-6">
                                        <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-3"></i>
                                        <p>Error loading status history. Please try again.</p>
                                    </div>
                                </td>
                            </tr>
                        `);
                    }
                });
            }

            // Function to load attachments data
            function loadAttachments(visitId) {
                // Show loading state
                showLoading();
                
                // Fetch attachments from the API
                $.ajax({
                    url: `/user/api/field-visits/${visitId}/attachments`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        hideLoading();
                        
                        // Clear previous attachments
                        $('#attachmentsTableBody').empty();
                        
                        if (response.success && response.attachments && response.attachments.length > 0) {
                            // Populate the attachments table
                            response.attachments.forEach(function(attachment) {
                                // Format the attachment type for display
                                const attachmentType = attachment.attachment_type ? 
                                    attachment.attachment_type.charAt(0).toUpperCase() + attachment.attachment_type.slice(1) : 
                                    'Document';
                                
                                // Format file size
                                const fileSize = formatFileSize(attachment.file_size);
                                
                                // Get file type icon based on file extension
                                let fileIcon = '<i class="fas fa-file text-gray-500"></i>';
                                if (attachment.file_name) {
                                    const extension = attachment.file_name.split('.').pop().toLowerCase();
                                    if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(extension)) {
                                        fileIcon = '<i class="fas fa-file-image text-blue-500"></i>';
                                    } else if (['pdf'].includes(extension)) {
                                        fileIcon = '<i class="fas fa-file-pdf text-red-500"></i>';
                                    } else if (['doc', 'docx'].includes(extension)) {
                                        fileIcon = '<i class="fas fa-file-word text-blue-700"></i>';
                                    } else if (['xls', 'xlsx', 'csv'].includes(extension)) {
                                        fileIcon = '<i class="fas fa-file-excel text-green-600"></i>';
                                    } else if (['ppt', 'pptx'].includes(extension)) {
                                        fileIcon = '<i class="fas fa-file-powerpoint text-orange-500"></i>';
                                    } else if (['zip', 'rar', '7z'].includes(extension)) {
                                        fileIcon = '<i class="fas fa-file-archive text-yellow-600"></i>';
                                    } else if (['txt', 'rtf'].includes(extension)) {
                                        fileIcon = '<i class="fas fa-file-alt text-gray-600"></i>';
                                    }
                                }
                                
                                // Add row to the table
                                $('#attachmentsTableBody').append(`
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <div class="flex items-center">
                                                <span class="mr-2">${fileIcon}</span>
                                                ${attachment.file_name}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${attachmentType}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fileSize}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${attachment.uploaded_at}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <a href="${attachment.download_url}" class="text-blue-600 hover:text-blue-900" target="_blank">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        </td>
                                    </tr>
                                `);
                            });
                        } else {
                            // Show no attachments message
                            $('#attachmentsTableBody').append(`
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No attachments found for this field visit.</td>
                                </tr>
                            `);
                        }
                    },
                    error: function(xhr, status, error) {
                        hideLoading();
                        console.error('Error fetching attachments:', error);
                        
                        // Show error message in the table
                        $('#attachmentsTableBody').empty();
                        $('#attachmentsTableBody').append(`
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-sm text-red-500">
                                    <i class="fas fa-exclamation-circle mr-2"></i>
                                    Error loading attachments. Please try again.
                                </td>
                            </tr>
                        `);
                    }
                });
            }
            
            // Helper function to format file size
            function formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Helper function to get status progress percentage
            function getStatusProgressPercentage(status) {
                const statusMap = {
                    'scheduled': 25,
                    'in-progress': 50,
                    'completed': 100,
                    'cancelled': 0
                };
                return statusMap[status] || 0;
            }
            
            // Reset form when modal is closed
            $('#fieldVisitModal').on('hidden.bs.modal', function() {
                resetForm();
            });
        });
    </script>
{% endblock %}
