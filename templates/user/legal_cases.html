{% extends "base.html" %}
{% block content %}
    {% include 'user/post_disbursement_sidebar.html' %}
    
    <div class="p-4 sm:ml-64">
        <div class="sm:flex sm:items-center">
            <div class="sm:flex-auto">
                <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">Legal Cases</h1>
                <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Track and manage legal proceedings for defaulted loans.</p>
            </div>
            <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
                <button type="button" onclick="openNewCaseModal()" class="inline-flex items-center justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 sm:w-auto">
                    Register New Case
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-4">
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-gavel text-blue-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Cases</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ active_cases }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-check text-green-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Resolved Cases</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ resolved_cases }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-alt text-yellow-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Upcoming Hearings</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ upcoming_hearings }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-dollar-sign text-red-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Amount in Litigation</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ amount_in_litigation }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Case Status</label>
                    <select id="statusFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Closed">Closed</option>
                        <option value="Appealed">Appealed</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search</label>
                    <input type="text" id="searchFilter" placeholder="Search by ID, name, or details..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                </div>
                <div class="flex items-end">
                    <button type="button" onclick="resetFilters()" class="inline-flex items-center px-6 py-2.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
                        Reset Filters
                    </button>
                </div>
            </div>
            <!-- Date Filters -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filing Date Range</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">From</label>
                            <input type="date" id="filingDateFrom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">To</label>
                            <input type="date" id="filingDateTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Hearing Date Range</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">From</label>
                            <input type="date" id="hearingDateFrom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">To</label>
                            <input type="date" id="hearingDateTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="mt-8 flex flex-col">
            <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6">Case ID</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Loan ID</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Status</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Plaintiff</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Defendant</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Amount Claimed</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Next Hearing</th>
                                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800">
                                {% if legal_cases %}
                                    {% for case in legal_cases %}
                                    <tr>
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 dark:text-gray-100 sm:pl-6">{{ case.id }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.loan_id }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm">
                                            <span class="inline-flex rounded-full px-2 text-xs font-semibold 
                                                {% if case.status == 'Active' %}bg-green-100 text-green-800
                                                {% elif case.status == 'Pending' %}bg-yellow-100 text-yellow-800
                                                {% elif case.status == 'Closed' %}bg-red-100 text-red-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ case.status }}
                                            </span>
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.plaintiff }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.defendant }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.amount_claimed|default('N/A', true) }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.next_hearing_date|default('N/A', true) }}</td>
                                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                            <a href="#" class="text-primary hover:text-primary-dark">View Details</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-4 text-gray-500 dark:text-gray-400">No legal cases found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Case Modal -->
    <div id="newCaseModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                <form id="newCaseForm" class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Create New Legal Case</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="loan_id" class="block text-sm font-medium text-gray-700">Loan ID</label>
                            <input type="text" id="loan_id" name="loan_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="case_number" class="block text-sm font-medium text-gray-700">Case Number</label>
                            <input type="text" id="case_number" name="case_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="court_name" class="block text-sm font-medium text-gray-700">Court Name</label>
                            <input type="text" id="court_name" name="court_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="case_type" class="block text-sm font-medium text-gray-700">Case Type</label>
                            <select id="case_type" name="case_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                <option value="">Select Case Type</option>
                                <option value="Civil">Civil</option>
                                <option value="Criminal">Criminal</option>
                                <option value="Commercial">Commercial</option>
                            </select>
                        </div>
                        <div>
                            <label for="filing_date" class="block text-sm font-medium text-gray-700">Filing Date</label>
                            <input type="date" id="filing_date" name="filing_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                <option value="">Select Status</option>
                                <option value="Active">Active</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Resolved">Resolved</option>
                                <option value="Appealed">Appealed</option>
                            </select>
                        </div>
                        <div>
                            <label for="plaintiff" class="block text-sm font-medium text-gray-700">Plaintiff</label>
                            <input type="text" id="plaintiff" name="plaintiff" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="defendant" class="block text-sm font-medium text-gray-700">Defendant</label>
                            <input type="text" id="defendant" name="defendant" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="amount_claimed" class="block text-sm font-medium text-gray-700">Amount Claimed</label>
                            <input type="number" step="0.01" id="amount_claimed" name="amount_claimed" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="lawyer_name" class="block text-sm font-medium text-gray-700">Lawyer Name</label>
                            <input type="text" id="lawyer_name" name="lawyer_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="lawyer_contact" class="block text-sm font-medium text-gray-700">Lawyer Contact</label>
                            <input type="tel" id="lawyer_contact" name="lawyer_contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="next_hearing_date" class="block text-sm font-medium text-gray-700">Next Hearing Date</label>
                            <input type="date" id="next_hearing_date" name="next_hearing_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3"></textarea>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button type="button" onclick="closeNewCaseModal()" class="inline-flex justify-center rounded-md border border-transparent bg-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            Cancel
                        </button>
                        <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
                            Create Case
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal JavaScript -->
    <script>
        function openNewCaseModal() {
            document.getElementById('newCaseModal').classList.remove('hidden');
        }

        function closeNewCaseModal() {
            document.getElementById('newCaseModal').classList.add('hidden');
        }

        // Filter functionality
        const statusFilter = document.getElementById('statusFilter');
        const searchFilter = document.getElementById('searchFilter');
        const filingDateFrom = document.getElementById('filingDateFrom');
        const filingDateTo = document.getElementById('filingDateTo');
        const hearingDateFrom = document.getElementById('hearingDateFrom');
        const hearingDateTo = document.getElementById('hearingDateTo');
        const tbody = document.querySelector('tbody');
        const rows = Array.from(tbody.getElementsByTagName('tr'));

        // Add event listeners
        statusFilter.addEventListener('change', filterCases);
        searchFilter.addEventListener('input', filterCases);
        filingDateFrom.addEventListener('change', filterCases);
        filingDateTo.addEventListener('change', filterCases);
        hearingDateFrom.addEventListener('change', filterCases);
        hearingDateTo.addEventListener('change', filterCases);

        function isDateInRange(dateStr, fromDate, toDate) {
            if (dateStr === 'N/A') return false;
            
            const date = new Date(dateStr);
            let isValid = true;

            if (fromDate) {
                const from = new Date(fromDate);
                isValid = isValid && date >= from;
            }

            if (toDate) {
                const to = new Date(toDate);
                to.setHours(23, 59, 59, 999); // Include the entire "to" day
                isValid = isValid && date <= to;
            }

            return isValid;
        }

        function filterCases() {
            const status = statusFilter.value.toLowerCase();
            const search = searchFilter.value.toLowerCase();
            const filingFrom = filingDateFrom.value;
            const filingTo = filingDateTo.value;
            const hearingFrom = hearingDateFrom.value;
            const hearingTo = hearingDateTo.value;

            rows.forEach(row => {
                if (row.classList.contains('no-results')) return;
                
                let showRow = true;

                // Status filter
                if (status && row.cells.length > 2) {
                    const caseStatus = row.cells[2].textContent.trim().toLowerCase();
                    if (!caseStatus.includes(status)) {
                        showRow = false;
                    }
                }

                // Search filter
                if (search && row.cells.length > 0) {
                    const rowText = Array.from(row.cells)
                        .map(cell => cell.textContent.trim().toLowerCase())
                        .join(' ');
                    if (!rowText.includes(search)) {
                        showRow = false;
                    }
                }

                // Filing date filter
                if ((filingFrom || filingTo) && row.cells.length > 5) {
                    const filingDate = row.cells[5].textContent.trim();
                    if (!isDateInRange(filingDate, filingFrom, filingTo)) {
                        showRow = false;
                    }
                }

                // Hearing date filter
                if ((hearingFrom || hearingTo) && row.cells.length > 6) {
                    const hearingDate = row.cells[6].textContent.trim();
                    if (!isDateInRange(hearingDate, hearingFrom, hearingTo)) {
                        showRow = false;
                    }
                }

                // Show/hide row
                row.style.display = showRow ? '' : 'none';
            });

            // Show "No results found" message if all rows are hidden
            const visibleRows = rows.filter(row => !row.classList.contains('no-results') && row.style.display !== 'none');
            const noResultsRow = tbody.querySelector('.no-results');
            
            if (visibleRows.length === 0) {
                if (!noResultsRow) {
                    const tr = document.createElement('tr');
                    tr.className = 'no-results';
                    tr.innerHTML = '<td colspan="8" class="text-center py-4 text-gray-500 dark:text-gray-400">No matching cases found</td>';
                    tbody.appendChild(tr);
                }
            } else if (noResultsRow) {
                noResultsRow.remove();
            }
        }

        function resetFilters() {
            statusFilter.value = '';
            searchFilter.value = '';
            filingDateFrom.value = '';
            filingDateTo.value = '';
            hearingDateFrom.value = '';
            hearingDateTo.value = '';
            filterCases();
        }

        document.getElementById('newCaseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = {
                loan_id: document.getElementById('loan_id').value,
                case_number: document.getElementById('case_number').value,
                court_name: document.getElementById('court_name').value,
                case_type: document.getElementById('case_type').value,
                filing_date: document.getElementById('filing_date').value,
                status: document.getElementById('status').value,
                plaintiff: document.getElementById('plaintiff').value,
                defendant: document.getElementById('defendant').value,
                amount_claimed: document.getElementById('amount_claimed').value,
                lawyer_name: document.getElementById('lawyer_name').value,
                lawyer_contact: document.getElementById('lawyer_contact').value,
                description: document.getElementById('description').value,
                next_hearing_date: document.getElementById('next_hearing_date').value
            };

            console.log('Sending form data:', formData);

            // Send data to backend
            fetch('/user/create_legal_case', {
                method: 'POST',
                credentials: 'same-origin', // Include cookies for CSRF
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Full Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers),
                    type: response.type,
                    url: response.url
                });
                
                // Always try to parse as JSON, even for error responses
                return response.json().then(data => ({
                    data: data,
                    response: response
                })).catch(err => {
                    // If JSON parsing fails, return the raw response
                    return response.text().then(text => ({
                        error: 'Failed to parse JSON',
                        text: text,
                        response: response
                    }));
                });
            })
            .then(result => {
                console.log('Parsed Result:', result);
                
                // Check if there's an error in parsing or in the response
                if (result.error) {
                    throw new Error(result.error + ': ' + result.text);
                }
                
                // Check response status and data
                if (result.response.ok && result.data.case_id) {
                    // Success: show success message and close modal
                    Swal.fire({
                        icon: 'success',
                        title: 'Legal Case Created',
                        text: 'The legal case has been successfully created.',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        closeNewCaseModal();
                        location.reload();
                    });
                } else {
                    // Error: show error message
                    throw new Error(result.data.error || 'Failed to create legal case');
                }
            })
            .catch(error => {
                console.error('Full Submission Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Error',
                    text: `Could not submit form: ${error.message}`,
                    confirmButtonText: 'OK'
                });
            });
        });
    </script>
{% endblock %}
