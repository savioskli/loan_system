{% extends "base.html" %}
{% block content %}
    {% include 'user/post_disbursement_sidebar.html' %}
    
    <div class="p-4 sm:ml-64">
        <div class="sm:flex sm:items-center">
            <div class="sm:flex-auto">
                <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">Legal Cases</h1>
                <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Track and manage legal proceedings for defaulted loans.</p>
            </div>
            <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
                <button type="button" onclick="openNewCaseModal()" class="inline-flex items-center justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 sm:w-auto">
                    Register New Case
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-4">
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-gavel text-blue-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Cases</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ active_cases }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-check text-green-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Resolved Cases</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ resolved_cases }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-alt text-yellow-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Upcoming Hearings</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ upcoming_hearings }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-dollar-sign text-red-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Amount in Litigation</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ amount_in_litigation }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Case Status</label>
                    <select id="statusFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Closed">Closed</option>
                        <option value="Appealed">Appealed</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search</label>
                    <input type="text" id="searchFilter" placeholder="Search by ID, name, or details..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                </div>
                <div class="flex items-end">
                    <button type="button" onclick="resetFilters()" class="inline-flex items-center px-6 py-2.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
                        Reset Filters
                    </button>
                </div>
            </div>
            <!-- Date Filters -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filing Date Range</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">From</label>
                            <input type="date" id="filingDateFrom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">To</label>
                            <input type="date" id="filingDateTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Hearing Date Range</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">From</label>
                            <input type="date" id="hearingDateFrom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">To</label>
                            <input type="date" id="hearingDateTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="mt-8 flex flex-col">
            <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6">Case ID</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Loan ID</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Status</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Plaintiff</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Defendant</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Amount Claimed</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Next Hearing</th>
                                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800">
                                {% if legal_cases %}
                                    {% for case in legal_cases %}
                                    <tr>
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 dark:text-gray-100 sm:pl-6">{{ case.id }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.loan_id }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm">
                                            <span class="inline-flex rounded-full px-2 text-xs font-semibold 
                                                {% if case.status == 'Active' %}bg-green-100 text-green-800
                                                {% elif case.status == 'Pending' %}bg-yellow-100 text-yellow-800
                                                {% elif case.status == 'Closed' %}bg-red-100 text-red-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ case.status }}
                                            </span>
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.plaintiff }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.defendant }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.amount_claimed|default('N/A', true) }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.next_hearing_date|default('N/A', true) }}</td>
                                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                            <div class="flex space-x-2">
                                                <button onclick="viewCaseDetails('{{ case.id }}')" class="text-primary hover:text-primary-dark">
                                                    View Details
                                                </button>
                                                <button onclick="openAddHistoryModal('{{ case.id }}')" class="text-green-600 hover:text-green-700">
                                                    Add History
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-4 text-gray-500 dark:text-gray-400">No legal cases found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Case Modal -->
    <div id="newCaseModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                <form id="newCaseForm" class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Create New Legal Case</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="loan_id" class="block text-sm font-medium text-gray-700">Loan ID</label>
                            <input type="text" id="loan_id" name="loan_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="case_number" class="block text-sm font-medium text-gray-700">Case Number</label>
                            <input type="text" id="case_number" name="case_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="court_name" class="block text-sm font-medium text-gray-700">Court Name</label>
                            <input type="text" id="court_name" name="court_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="case_type" class="block text-sm font-medium text-gray-700">Case Type</label>
                            <select id="case_type" name="case_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                <option value="">Select Case Type</option>
                                <option value="Civil">Civil</option>
                                <option value="Criminal">Criminal</option>
                                <option value="Commercial">Commercial</option>
                            </select>
                        </div>
                        <div>
                            <label for="filing_date" class="block text-sm font-medium text-gray-700">Filing Date</label>
                            <input type="date" id="filing_date" name="filing_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                <option value="">Select Status</option>
                                <option value="Active">Active</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Resolved">Resolved</option>
                                <option value="Appealed">Appealed</option>
                            </select>
                        </div>
                        <div>
                            <label for="plaintiff" class="block text-sm font-medium text-gray-700">Plaintiff</label>
                            <input type="text" id="plaintiff" name="plaintiff" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="defendant" class="block text-sm font-medium text-gray-700">Defendant</label>
                            <input type="text" id="defendant" name="defendant" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="amount_claimed" class="block text-sm font-medium text-gray-700">Amount Claimed</label>
                            <input type="number" step="0.01" id="amount_claimed" name="amount_claimed" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="lawyer_name" class="block text-sm font-medium text-gray-700">Lawyer Name</label>
                            <input type="text" id="lawyer_name" name="lawyer_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="lawyer_contact" class="block text-sm font-medium text-gray-700">Lawyer Contact</label>
                            <input type="tel" id="lawyer_contact" name="lawyer_contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                        <div>
                            <label for="next_hearing_date" class="block text-sm font-medium text-gray-700">Next Hearing Date</label>
                            <input type="date" id="next_hearing_date" name="next_hearing_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3"></textarea>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button type="button" onclick="closeNewCaseModal()" class="inline-flex justify-center rounded-md border border-transparent bg-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            Cancel
                        </button>
                        <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
                            Create Case
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add History Modal -->
    <div id="addHistoryModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:align-middle">
                <form id="addHistoryForm" onsubmit="submitCaseHistory(event)" class="px-6 pt-5 pb-4">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Add Case History</h3>
                            <button type="button" onclick="closeAddHistoryModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                <span class="sr-only">Close</span>
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <input type="hidden" id="historyFormCaseId" name="case_id">
                        
                        <!-- Action Type -->
                        <div class="mb-4">
                            <label for="actionType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Action Type</label>
                            <select id="actionType" name="action" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                                <option value="">Select Action Type</option>
                                <option value="Hearing">Hearing</option>
                                <option value="Filing">Filing</option>
                                <option value="Decision">Decision</option>
                                <option value="Settlement">Settlement</option>
                                <option value="Appeal">Appeal</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Action Date -->
                        <div class="mb-4">
                            <label for="actionDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Action Date</label>
                            <input type="datetime-local" id="actionDate" name="date" required 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                            <textarea id="notes" name="notes" rows="3" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
                                placeholder="Enter detailed notes about the action..."></textarea>
                        </div>

                        <!-- Attachments -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Attachments</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md dark:border-gray-600">
                                <div class="space-y-1 text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="attachments" class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-dark focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary">
                                            <span>Upload files</span>
                                            <input id="attachments" name="attachments" type="file" class="sr-only" multiple>
                                        </label>
                                        <p class="pl-1 text-gray-500">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500">PDF, DOC, DOCX, JPG, PNG up to 10MB each</p>
                                </div>
                            </div>
                            <div id="fileList" class="mt-2 space-y-2"></div>
                        </div>
                    </div>

                    <div class="bg-gray-100 dark:bg-gray-700 px-6 py-3 sm:flex sm:flex-row-reverse">
                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm">
                            Save History
                        </button>
                        <button type="button" onclick="closeAddHistoryModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 dark:hover:bg-gray-500">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewDetailsModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                <div class="px-6 pt-6 pb-4">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Case Details</h3>
                            <p id="viewCaseId" class="mt-1 text-sm text-gray-500 dark:text-gray-400"></p>
                        </div>
                        <button onclick="closeViewDetailsModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                            <span class="sr-only">Close</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Main Content -->
                    <div class="space-y-8">
                        <!-- Case Information -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Case Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Loan ID</label>
                                    <p id="viewLoanId" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Status</label>
                                    <p id="viewStatus" class="mt-1"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Amount Claimed</label>
                                    <p id="viewAmount" class="mt-1 text-sm text-gray-900 dark:text-gray-100 font-semibold"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Important Dates</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Filing Date</label>
                                    <p id="viewFilingDate" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Next Hearing Date</label>
                                    <p id="viewHearingDate" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Parties Involved -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Parties Involved</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Plaintiff</label>
                                    <p id="viewPlaintiff" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Defendant</label>
                                    <p id="viewDefendant" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Legal Representation -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Legal Representation</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Lawyer Name</label>
                                    <p id="viewLawyerName" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Lawyer Contact</label>
                                    <p id="viewLawyerContact" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Case Details -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Case Details</h4>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Description</label>
                                <p id="viewDescription" class="mt-1 text-sm text-gray-900 dark:text-gray-100 whitespace-pre-wrap"></p>
                            </div>
                        </div>

                        <!-- Case History -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Case History</h4>
                            <div id="viewCaseHistory" class="space-y-3">
                                <!-- Case history items will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="bg-gray-100 dark:bg-gray-700 px-6 py-4">
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeViewDetailsModal()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 dark:hover:bg-gray-500">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal JavaScript -->
    <script>
        function openNewCaseModal() {
            document.getElementById('newCaseModal').classList.remove('hidden');
        }

        function closeNewCaseModal() {
            document.getElementById('newCaseModal').classList.add('hidden');
        }

        // Filter functionality
        const statusFilter = document.getElementById('statusFilter');
        const searchFilter = document.getElementById('searchFilter');
        const filingDateFrom = document.getElementById('filingDateFrom');
        const filingDateTo = document.getElementById('filingDateTo');
        const hearingDateFrom = document.getElementById('hearingDateFrom');
        const hearingDateTo = document.getElementById('hearingDateTo');
        const tbody = document.querySelector('tbody');
        const rows = Array.from(tbody.getElementsByTagName('tr'));

        // Add event listeners
        statusFilter.addEventListener('change', filterCases);
        searchFilter.addEventListener('input', filterCases);
        filingDateFrom.addEventListener('change', filterCases);
        filingDateTo.addEventListener('change', filterCases);
        hearingDateFrom.addEventListener('change', filterCases);
        hearingDateTo.addEventListener('change', filterCases);

        function isDateInRange(dateStr, fromDate, toDate) {
            if (dateStr === 'N/A') return false;
            
            const date = new Date(dateStr);
            let isValid = true;

            if (fromDate) {
                const from = new Date(fromDate);
                isValid = isValid && date >= from;
            }

            if (toDate) {
                const to = new Date(toDate);
                to.setHours(23, 59, 59, 999); // Include the entire "to" day
                isValid = isValid && date <= to;
            }

            return isValid;
        }

        function filterCases() {
            const status = statusFilter.value.toLowerCase();
            const search = searchFilter.value.toLowerCase();
            const filingFrom = filingDateFrom.value;
            const filingTo = filingDateTo.value;
            const hearingFrom = hearingDateFrom.value;
            const hearingTo = hearingDateTo.value;

            rows.forEach(row => {
                if (row.classList.contains('no-results')) return;
                
                let showRow = true;

                // Status filter
                if (status && row.cells.length > 2) {
                    const caseStatus = row.cells[2].textContent.trim().toLowerCase();
                    if (!caseStatus.includes(status)) {
                        showRow = false;
                    }
                }

                // Search filter
                if (search && row.cells.length > 0) {
                    const rowText = Array.from(row.cells)
                        .map(cell => cell.textContent.trim().toLowerCase())
                        .join(' ');
                    if (!rowText.includes(search)) {
                        showRow = false;
                    }
                }

                // Filing date filter
                if ((filingFrom || filingTo) && row.cells.length > 5) {
                    const filingDate = row.cells[5].textContent.trim();
                    if (!isDateInRange(filingDate, filingFrom, filingTo)) {
                        showRow = false;
                    }
                }

                // Hearing date filter
                if ((hearingFrom || hearingTo) && row.cells.length > 6) {
                    const hearingDate = row.cells[6].textContent.trim();
                    if (!isDateInRange(hearingDate, hearingFrom, hearingTo)) {
                        showRow = false;
                    }
                }

                // Show/hide row
                row.style.display = showRow ? '' : 'none';
            });

            // Show "No results found" message if all rows are hidden
            const visibleRows = rows.filter(row => !row.classList.contains('no-results') && row.style.display !== 'none');
            const noResultsRow = tbody.querySelector('.no-results');
            
            if (visibleRows.length === 0) {
                if (!noResultsRow) {
                    const tr = document.createElement('tr');
                    tr.className = 'no-results';
                    tr.innerHTML = '<td colspan="8" class="text-center py-4 text-gray-500 dark:text-gray-400">No matching cases found</td>';
                    tbody.appendChild(tr);
                }
            } else if (noResultsRow) {
                noResultsRow.remove();
            }
        }

        function resetFilters() {
            statusFilter.value = '';
            searchFilter.value = '';
            filingDateFrom.value = '';
            filingDateTo.value = '';
            hearingDateFrom.value = '';
            hearingDateTo.value = '';
            filterCases();
        }

        document.getElementById('newCaseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = {
                loan_id: document.getElementById('loan_id').value,
                case_number: document.getElementById('case_number').value,
                court_name: document.getElementById('court_name').value,
                case_type: document.getElementById('case_type').value,
                filing_date: document.getElementById('filing_date').value,
                status: document.getElementById('status').value,
                plaintiff: document.getElementById('plaintiff').value,
                defendant: document.getElementById('defendant').value,
                amount_claimed: document.getElementById('amount_claimed').value,
                lawyer_name: document.getElementById('lawyer_name').value,
                lawyer_contact: document.getElementById('lawyer_contact').value,
                description: document.getElementById('description').value,
                next_hearing_date: document.getElementById('next_hearing_date').value
            };

            console.log('Sending form data:', formData);

            // Send data to backend
            fetch('/user/create_legal_case', {
                method: 'POST',
                credentials: 'same-origin', // Include cookies for CSRF
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Full Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers),
                    type: response.type,
                    url: response.url
                });
                
                // Always try to parse as JSON, even for error responses
                return response.json().then(data => ({
                    data: data,
                    response: response
                })).catch(err => {
                    // If JSON parsing fails, return the raw response
                    return response.text().then(text => ({
                        error: 'Failed to parse JSON',
                        text: text,
                        response: response
                    }));
                });
            })
            .then(result => {
                console.log('Parsed Result:', result);
                
                // Check if there's an error in parsing or in the response
                if (result.error) {
                    throw new Error(result.error + ': ' + result.text);
                }
                
                // Check response status and data
                if (result.response.ok && result.data.case_id) {
                    // Success: show success message and close modal
                    Swal.fire({
                        icon: 'success',
                        title: 'Legal Case Created',
                        text: 'The legal case has been successfully created.',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        closeNewCaseModal();
                        location.reload();
                    });
                } else {
                    // Error: show error message
                    throw new Error(result.data.error || 'Failed to create legal case');
                }
            })
            .catch(error => {
                console.error('Full Submission Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Error',
                    text: `Could not submit form: ${error.message}`,
                    confirmButtonText: 'OK'
                });
            });
        });

        function viewCaseDetails(caseId) {
            fetch(`/user/legal-cases/${caseId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update case information
                    document.getElementById('viewCaseId').textContent = `Case #${data.case_number || data.id}`;
                    document.getElementById('viewLoanId').textContent = data.loan_id || 'N/A';
                    
                    // Format status with badge
                    const statusElement = document.getElementById('viewStatus');
                    const statusClass = getStatusClass(data.status);
                    statusElement.innerHTML = `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${data.status}</span>`;
                    
                    // Format amount with currency
                    document.getElementById('viewAmount').textContent = formatCurrency(data.amount_claimed);
                    
                    // Format dates
                    document.getElementById('viewFilingDate').textContent = formatDate(data.filing_date) || 'N/A';
                    document.getElementById('viewHearingDate').textContent = formatDate(data.next_hearing_date) || 'Not Scheduled';
                    
                    // Update parties involved
                    document.getElementById('viewPlaintiff').textContent = data.plaintiff || 'N/A';
                    document.getElementById('viewDefendant').textContent = data.defendant || 'N/A';
                    
                    // Update legal representation
                    document.getElementById('viewLawyerName').textContent = data.lawyer_name || 'Not Assigned';
                    document.getElementById('viewLawyerContact').textContent = data.lawyer_contact || 'N/A';
                    
                    // Update description
                    document.getElementById('viewDescription').textContent = data.description || 'No description available';
                    
                    // Update case history
                    const historyContainer = document.getElementById('viewCaseHistory');
                    historyContainer.innerHTML = '';
                    
                    if (data.history && data.history.length > 0) {
                        data.history.forEach(item => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'flex items-start space-x-3 p-3 bg-white dark:bg-gray-600 rounded-lg';
                            
                            historyItem.innerHTML = `
                                <div class="flex-shrink-0">
                                    <div class="w-2 h-2 mt-2 rounded-full bg-primary"></div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 dark:text-gray-100">${item.action}</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${formatDate(item.date)}</p>
                                    ${item.notes ? `<p class="mt-1 text-sm text-gray-600 dark:text-gray-300">${item.notes}</p>` : ''}
                                </div>
                            `;
                            
                            historyContainer.appendChild(historyItem);
                        });
                    } else {
                        historyContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No history available</p>';
                    }
                    
                    // Show modal
                    document.getElementById('viewDetailsModal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error fetching case details:', error);
                    showErrorToast('Error fetching case details');
                });
        }

        function getStatusClass(status) {
            const statusClasses = {
                'Active': 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100',
                'Pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100',
                'Resolved': 'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100',
                'Dismissed': 'bg-gray-100 text-gray-800'
            };
            return statusClasses[status] || 'bg-gray-100 text-gray-800';
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        function formatCurrency(amount) {
            if (!amount) return 'N/A';
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function closeViewDetailsModal() {
            document.getElementById('viewDetailsModal').classList.add('hidden');
        }

        function openAddHistoryModal(caseId) {
            document.getElementById('historyFormCaseId').value = caseId;
            document.getElementById('addHistoryModal').classList.remove('hidden');
            
            // Reset form
            document.getElementById('addHistoryForm').reset();
            document.getElementById('fileList').innerHTML = '';
            
            // Set default date to current date and time
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('actionDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function closeAddHistoryModal() {
            document.getElementById('addHistoryModal').classList.add('hidden');
        }

        function submitCaseHistory(event) {
            event.preventDefault();
            
            const form = document.getElementById('addHistoryForm');
            const formData = new FormData(form);
            
            // Get file input and append files to formData
            const fileInput = document.getElementById('attachments');
            const files = fileInput.files;
            for (let i = 0; i < files.length; i++) {
                formData.append('attachments', files[i]);
            }

            fetch('/add_case_history', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('error', data.error);
                } else {
                    showToast('success', 'Case history added successfully');
                    closeAddHistoryModal();
                    // Optionally refresh the case details
                    if (currentCaseId) {
                        loadCaseDetails(currentCaseId);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Failed to add case history');
            });
        }

        // Add event listener to the form
        document.getElementById('addHistoryForm').addEventListener('submit', submitCaseHistory);

        // Handle file selection
        document.getElementById('attachments').addEventListener('change', function(e) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            Array.from(e.target.files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between text-sm text-gray-600 dark:text-gray-300';
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                        </svg>
                        <span>${file.name}</span>
                    </div>
                    <span class="text-xs">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                `;
                fileList.appendChild(fileItem);
            });
        });

        // Handle drag and drop
        const dropZone = document.querySelector('form');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('border-primary');
        }

        function unhighlight(e) {
            dropZone.classList.remove('border-primary');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('attachments').files = files;
            
            // Trigger the change event manually
            const event = new Event('change');
            document.getElementById('attachments').dispatchEvent(event);
        }
    </script>
{% endblock %}
