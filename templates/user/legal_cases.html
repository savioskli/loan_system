{% extends "base.html" %}
{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
    {% include 'user/post_disbursement_sidebar.html' %}
    
    <div class="p-4 sm:ml-64">
        <div class="sm:flex sm:items-center">
            <div class="sm:flex-auto">
                <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">Legal Cases</h1>
                <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Track and manage legal proceedings for defaulted loans.</p>
            </div>
            <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
                <button type="button" onclick="openNewCaseModal()" class="inline-flex items-center justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 sm:w-auto">
                    Register New Case
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-4">
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-gavel text-blue-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Cases</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ active_cases }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-check text-green-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Resolved Cases</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ resolved_cases }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-alt text-yellow-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Upcoming Hearings</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ upcoming_hearings }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-dollar-sign text-red-600 text-3xl"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Amount in Litigation</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{{ amount_in_litigation }}</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Case Status</label>
                    <select id="statusFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Closed">Closed</option>
                        <option value="Appealed">Appealed</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search</label>
                    <input type="text" id="searchFilter" placeholder="Search by ID, name, or details..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                </div>
                <div class="flex items-end">
                    <button type="button" onclick="resetFilters()" class="inline-flex items-center px-6 py-2.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
                        Reset Filters
                    </button>
                </div>
            </div>
            <!-- Date Filters -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filing Date Range</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">From</label>
                            <input type="date" id="filingDateFrom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">To</label>
                            <input type="date" id="filingDateTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Hearing Date Range</label>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">From</label>
                            <input type="date" id="hearingDateFrom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400">To</label>
                            <input type="date" id="hearingDateTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm dark:bg-gray-700 dark:border-gray-600 px-4 py-2.5">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="mt-8 flex flex-col">
            <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                    <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 sm:pl-6">Case ID</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Loan ID</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Status</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Plaintiff</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Defendant</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Amount Claimed</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">Next Hearing</th>
                                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800">
                                {% if legal_cases %}
                                    {% for case in legal_cases %}
                                    <tr>
                                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 dark:text-gray-100 sm:pl-6">{{ case.id }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.loan_id }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm">
                                            <span class="inline-flex rounded-full px-2 text-xs font-semibold 
                                                {% if case.status == 'Active' %}bg-green-100 text-green-800
                                                {% elif case.status == 'Pending' %}bg-yellow-100 text-yellow-800
                                                {% elif case.status == 'Closed' %}bg-red-100 text-red-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ case.status }}
                                            </span>
                                        </td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.plaintiff }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.defendant }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.amount_claimed|default('N/A', true) }}</td>
                                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">{{ case.next_hearing_date|default('N/A', true) }}</td>
                                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                            <div class="flex space-x-2">
                                                <button onclick="viewCaseDetails('{{ case.id }}')" 
                                                        class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-primary bg-primary-50 hover:bg-primary-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                                    <svg class="-ml-0.5 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                                    </svg>
                                                    View Details
                                                </button>
                                                <button onclick="openAddHistoryModal('{{ case.id }}')" 
                                                        class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-green-600 bg-green-50 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                                    <svg class="-ml-0.5 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                                    </svg>
                                                    Add History
                                                </button>
                                                <button onclick="confirmDeleteCase('{{ case.id }}')" 
                                                        class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-red-600 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                                    <svg class="-ml-0.5 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                    </svg>
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-4 text-gray-500 dark:text-gray-400">No legal cases found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Case Modal -->    
    <div id="newCaseModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                <!-- Modal Header -->
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Register New Legal Case</h3>
                            <p class="text-sm text-gray-500">Create a new legal case for a customer</p>
                        </div>
                        <button type="button" onclick="closeNewCaseModal()" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="px-6 py-4">
                    <form id="newCaseForm" action="{{ url_for('user.create_legal_case') }}" method="POST" class="wizard-form" enctype="multipart/form-data">
                        <div class="space-y-6">
                            <!-- Wizard Steps Indicator -->
                            <div class="wizard-steps flex mb-6">
                                <div class="step flex-1 text-center py-2 border-b-2 border-gray-200 text-gray-400" data-step="1">1. Customer</div>
                                <div class="step flex-1 text-center py-2 border-b-2 border-gray-200 text-gray-400" data-step="2">2. Case</div>
                                <div class="step flex-1 text-center py-2 border-b-2 border-gray-200 text-gray-400" data-step="3">3. Parties</div>
                                <div class="step flex-1 text-center py-2 border-b-2 border-gray-200 text-gray-400" data-step="4">4. Legal Rep</div>
                                <div class="step flex-1 text-center py-2 border-b-2 border-gray-200 text-gray-400" data-step="5">5. Docs</div>
                            </div>
                            
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="assigned_branch" id="branchInput" value="{{ branch_id }}">
                            
                            <!-- Hidden fields for raw values -->
                            <input type="hidden" name="raw_outstanding_balance" id="raw_outstanding_balance">
                            <input type="hidden" name="raw_days_in_arrears" id="raw_days_in_arrears">
                            <input type="hidden" name="raw_installment_amount" id="raw_installment_amount">
                            
                            <!-- Step 1: Customer & Loan Info -->
                            <div class="wizard-step" data-step="1">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Customer Information</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Customer</label>
                                            <select id="customer_id" name="customer_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                                <option value="">Select Customer</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Loan Account</label>
                                            <select id="loan_id" name="loan_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                                <option value="">Select Loan</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Outstanding Balance</label>
                                            <input type="text" id="outstanding_balance" name="outstanding_balance" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" readonly>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Days in Arrears</label>
                                            <input type="text" id="days_in_arrears" name="days_in_arrears" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" readonly>
                                        </div>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Missed Payments</label>
                                            <input type="text" id="missed_payments" name="missed_payments" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" readonly>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Installment Amount</label>
                                            <input type="text" id="installment_amount" name="installment_amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Case Details -->
                            <div class="wizard-step hidden" data-step="2">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Case Details</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="case_number" class="block text-sm font-medium text-gray-700">Case Number</label>
                                            <input type="text" id="case_number" name="case_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                        <div>
                                            <label for="case_type" class="block text-sm font-medium text-gray-700">Case Type</label>
                                            <select id="case_type" name="case_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                                <option value="">Select Case Type</option>
                                                <option value="Civil">Civil</option>
                                                <option value="Criminal">Criminal</option>
                                                <option value="Commercial">Commercial</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="court_name" class="block text-sm font-medium text-gray-700">Court Name</label>
                                            <input type="text" id="court_name" name="court_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                        <div>
                                            <label for="filing_date" class="block text-sm font-medium text-gray-700">Filing Date</label>
                                            <input type="date" id="filing_date" name="filing_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                                            <select id="status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                                <option value="">Select Status</option>
                                                <option value="Active">Active</option>
                                                <option value="On Hold">On Hold</option>
                                                <option value="Resolved">Resolved</option>
                                                <option value="Appealed">Appealed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="next_hearing_date" class="block text-sm font-medium text-gray-700">Next Hearing Date</label>
                                            <input type="date" id="next_hearing_date" name="next_hearing_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label for="description" class="block text-sm font-medium text-gray-700">Case Description</label>
                                        <textarea id="description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" placeholder="Enter detailed case description..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Case Parties -->
                            <div class="wizard-step hidden" data-step="3">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Case Parties</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="plaintiff" class="block text-sm font-medium text-gray-700">Plaintiff</label>
                                            <input type="text" id="plaintiff" name="plaintiff" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                        <div>
                                            <label for="defendant" class="block text-sm font-medium text-gray-700">Defendant</label>
                                            <input type="text" id="defendant" name="defendant" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                    </div>
                                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="amount_claimed" class="block text-sm font-medium text-gray-700">Amount Claimed</label>
                                            <input type="number" step="0.01" id="amount_claimed" name="amount_claimed" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                        </div>
                                        <div>
                                            <label for="lawyer_name" class="block text-sm font-medium text-gray-700">Lawyer Name</label>
                                            <input type="text" id="lawyer_name" name="lawyer_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label for="lawyer_contact" class="block text-sm font-medium text-gray-700">Lawyer Contact</label>
                                        <input type="tel" id="lawyer_contact" name="lawyer_contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 4: Legal Representative -->
                            <div class="wizard-step hidden" data-step="4">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Legal Officer Assignment</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Legal Officer</label>
                                            <select id="legal_officer_id" name="legal_officer_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" required>
                                                <option value="">Select Legal Officer</option>
                                            </select>
                                            <input type="hidden" id="legal_officer_name" name="legal_officer_name" value="">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Supervisor</label>
                                            <select id="supervisor_id" name="supervisor_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                                <option value="">Select Supervisor</option>
                                            </select>
                                            <input type="hidden" id="supervisor_name" name="supervisor_name" value="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 5: Documents -->
                            <div class="wizard-step hidden" data-step="5">
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Case Documents</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label for="attachment_type" class="block text-sm font-medium text-gray-700">Attachment Type</label>
                                            <select id="attachment_type" name="attachment_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3">
                                                <option value="">Select Type</option>
                                                <option value="court_document">Court Document</option>
                                                <option value="legal_notice">Legal Notice</option>
                                                <option value="evidence">Evidence</option>
                                                <option value="correspondence">Correspondence</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="attachment_description" class="block text-sm font-medium text-gray-700">Description</label>
                                            <input type="text" id="attachment_description" name="attachment_description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm py-2.5 px-3" placeholder="Brief description of the attachment">
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload File</label>
                                        <div id="dropZone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:bg-gray-50 transition-colors duration-200">
                                            <div class="space-y-1 text-center">
                                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                                <div class="flex text-sm text-gray-600">
                                                    <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-primary hover:text-primary-dark focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary">
                                                        <span>Upload a file</span>
                                                        <input id="file-upload" name="attachment" type="file" class="sr-only">
                                                    </label>
                                                    <p class="pl-1">or drag and drop</p>
                                                </div>
                                                <p class="text-xs text-gray-500">PDF, DOC, DOCX, JPG, PNG up to 10MB</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Wizard Navigation -->
                            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                                <button type="button" id="cancelCaseBtn" onclick="closeNewCaseModal()" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    Cancel
                                </button>
                                <div id="navButtons" class="flex items-center space-x-3">
                                    <button type="button" id="prevBtn" class="inline-flex justify-center px-4 py-2 bg-gray-100 text-gray-700 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary hidden" onclick="previousStep()">Back</button>
                                    <button type="button" id="nextBtn" class="inline-flex justify-center px-4 py-2 bg-primary text-white border border-transparent rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" onclick="nextStep()">Next</button>
                                    <button type="submit" id="submitBtn" class="inline-flex justify-center px-4 py-2 bg-primary text-white border border-transparent rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary hidden">Create Case</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add History Modal -->
    <div id="addHistoryModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:align-middle">
                <form id="addHistoryForm" onsubmit="submitCaseHistory(event)" class="px-6 pt-5 pb-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="case_id" name="case_id">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Add Case History</h3>
                            <button type="button" onclick="closeAddHistoryModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                                <span class="sr-only">Close</span>
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>

                        <!-- Action Type -->
                        <div class="mb-4">
                            <label for="actionType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Action Type</label>
                            <select id="actionType" name="actionType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 px-4 py-2">
                                <option value="">Select Action Type</option>
                                <option value="Hearing">Hearing</option>
                                <option value="Filing">Filing</option>
                                <option value="Decision">Decision</option>
                                <option value="Settlement">Settlement</option>
                                <option value="Appeal">Appeal</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Action Date -->
                        <div class="mb-4">
                            <label for="actionDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Action Date</label>
                            <input type="datetime-local" id="actionDate" name="actionDate" required 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 px-4 py-2">
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                            <textarea id="notes" name="notes" rows="3" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 px-4 py-2"
                                placeholder="Enter detailed notes about the action..."></textarea>
                        </div>

                        <!-- Attachments -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Attachments</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md dark:border-gray-600">
                                <div class="space-y-1 text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="flex text-sm text-gray-600 dark:text-gray-300">
                                        <label for="attachments" class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-dark focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary">
                                            <span>Upload files</span>
                                            <input id="attachments" name="attachments" type="file" class="sr-only" multiple>
                                        </label>
                                        <p class="pl-1 text-gray-500 dark:text-gray-400">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">PDF, DOC, DOCX, JPG, PNG up to 10MB each</p>
                                </div>
                            </div>
                            <div id="fileList" class="mt-2 space-y-2"></div>
                        </div>
                    </div>

                    <div class="bg-gray-100 dark:bg-gray-700 px-6 py-3 sm:flex sm:flex-row-reverse">
                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm">
                            Save History
                        </button>
                        <button type="button" onclick="closeAddHistoryModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 dark:hover:bg-gray-500">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewDetailsModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
            <div class="inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                <div class="px-6 pt-6 pb-4">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Case Details</h3>
                            <p id="viewCaseId" class="mt-1 text-sm text-gray-500 dark:text-gray-400"></p>
                        </div>
                        <button onclick="closeViewDetailsModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                            <span class="sr-only">Close</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Main Content -->
                    <div class="space-y-8">
                        <!-- Case Information -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Case Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Loan ID</label>
                                    <p id="viewLoanId" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Status</label>
                                    <p id="viewStatus" class="mt-1"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Amount Claimed</label>
                                    <p id="viewAmount" class="mt-1 text-sm text-gray-900 dark:text-gray-100 font-semibold"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Important Dates</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Filing Date</label>
                                    <p id="viewFilingDate" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Next Hearing Date</label>
                                    <p id="viewHearingDate" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Parties Involved -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Parties Involved</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Plaintiff</label>
                                    <p id="viewPlaintiff" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Defendant</label>
                                    <p id="viewDefendant" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Legal Representation -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Legal Representation</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Lawyer Name</label>
                                    <p id="viewLawyerName" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Lawyer Contact</label>
                                    <p id="viewLawyerContact" class="mt-1 text-sm text-gray-900 dark:text-gray-100"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Case Details -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Case Details</h4>
                            <div>
                                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Description</label>
                                <p id="viewDescription" class="mt-1 text-sm text-gray-900 dark:text-gray-100 whitespace-pre-wrap"></p>
                            </div>
                        </div>

                        <!-- Case Attachments -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Case Attachments</h4>
                            <div id="viewAttachments" class="space-y-3">
                                <!-- Attachments will be inserted here -->
                            </div>
                        </div>

                        <!-- Case History -->
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-4">Case History</h4>
                            <div id="viewCaseHistory" class="space-y-3">
                                <!-- Case history items will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="bg-gray-100 dark:bg-gray-700 px-6 py-4">
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeViewDetailsModal()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 dark:hover:bg-gray-500">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Format functions for Select2 dropdowns - defined globally
        function formatCustomer(customer) {
            if (!customer.id) {
                return customer.text;
            }
            
            return $(`
                <div class="d-flex flex-column">
                    <div class="font-weight-bold">${customer.text}</div>
                    ${customer.phone ? `<div class="text-muted small">${customer.phone}</div>` : ''}
                    ${customer.id_number ? `<div class="text-muted small">${customer.id_number}</div>` : ''}
                </div>
            `);
        }

        function formatCustomerSelection(customer) {
            return customer.text || customer.name || '';
        }

        function formatLoan(loan) {
            if (!loan.id) {
                return loan.text;
            }
            
            // Format the loan amount with currency
            const formattedAmount = loan.amount ? formatCurrency(loan.amount) : 'N/A';
            const formattedBalance = loan.outstanding_balance ? formatCurrency(loan.outstanding_balance) : 'N/A';
            const daysInArrears = loan.days_in_arrears || 0;
            
            return $(`
                <div class="d-flex flex-column">
                    <div class="font-weight-bold">${loan.text || loan.account_number}</div>
                    <div class="text-muted small">Amount: ${formattedAmount}</div>
                    <div class="text-muted small">Balance: ${formattedBalance}</div>
                    <div class="text-muted small">Days in Arrears: ${daysInArrears}</div>
                </div>
            `);
        }

        function formatLoanSelection(loan) {
            return loan.text || loan.account_number || '';
        }

        // Format functions for staff dropdowns
        function formatStaff(staff) {
            if (!staff.id) {
                return staff.text;
            }
            
            return $(`
                <div class="d-flex flex-column">
                    <div class="font-weight-bold">${staff.text}</div>
                    ${staff.role ? `<div class="text-muted small">${staff.role}</div>` : ''}
                </div>
            `);
        }

        function formatStaffSelection(staff) {
            return staff.text || staff.name || '';
        }
        
        // Helper functions
        function formatCurrency(amount) {
            if (!amount) return 'N/A';
            
            // Convert to number if it's a string
            const numAmount = typeof amount === 'string' ? parseFloat(amount) : amount;
            
            // Check if it's a valid number
            if (isNaN(numAmount)) return 'N/A';
            
            // Format with 2 decimal places and thousands separator
            return numAmount.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            });
        }
        
        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} transition-opacity duration-300`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function openNewCaseModal() {
            document.getElementById('newCaseModal').classList.remove('hidden');
        }

       

        // Filter functionality
        const statusFilter = document.getElementById('statusFilter');
        const searchFilter = document.getElementById('searchFilter');
        const filingDateFrom = document.getElementById('filingDateFrom');
        const filingDateTo = document.getElementById('filingDateTo');
        const hearingDateFrom = document.getElementById('hearingDateFrom');
        const hearingDateTo = document.getElementById('hearingDateTo');
        const tbody = document.querySelector('tbody');
        const rows = Array.from(tbody.getElementsByTagName('tr'));

        // Add event listeners
        statusFilter.addEventListener('change', filterCases);
        searchFilter.addEventListener('input', filterCases);
        filingDateFrom.addEventListener('change', filterCases);
        filingDateTo.addEventListener('change', filterCases);
        hearingDateFrom.addEventListener('change', filterCases);
        hearingDateTo.addEventListener('change', filterCases);

        function isDateInRange(dateStr, fromDate, toDate) {
            if (dateStr === 'N/A') return false;
            
            const date = new Date(dateStr);
            let isValid = true;

            if (fromDate) {
                const from = new Date(fromDate);
                isValid = isValid && date >= from;
            }

            if (toDate) {
                const to = new Date(toDate);
                to.setHours(23, 59, 59, 999); // Include the entire "to" day
                isValid = isValid && date <= to;
            }

            return isValid;
        }

        function filterCases() {
            const status = statusFilter.value.toLowerCase();
            const search = searchFilter.value.toLowerCase();
            const filingFrom = filingDateFrom.value;
            const filingTo = filingDateTo.value;
            const hearingFrom = hearingDateFrom.value;
            const hearingTo = hearingDateTo.value;

            rows.forEach(row => {
                if (row.classList.contains('no-results')) return;
                
                let showRow = true;

                // Status filter
                if (status && row.cells.length > 2) {
                    const caseStatus = row.cells[2].textContent.trim().toLowerCase();
                    if (!caseStatus.includes(status)) {
                        showRow = false;
                    }
                }

                // Search filter
                if (search && row.cells.length > 0) {
                    const rowText = Array.from(row.cells)
                        .map(cell => cell.textContent.trim().toLowerCase())
                        .join(' ');
                    if (!rowText.includes(search)) {
                        showRow = false;
                    }
                }

                // Filing date filter
                if ((filingFrom || filingTo) && row.cells.length > 5) {
                    const filingDate = row.cells[5].textContent.trim();
                    if (!isDateInRange(filingDate, filingFrom, filingTo)) {
                        showRow = false;
                    }
                }

                // Hearing date filter
                if ((hearingFrom || hearingTo) && row.cells.length > 6) {
                    const hearingDate = row.cells[6].textContent.trim();
                    if (!isDateInRange(hearingDate, hearingFrom, hearingTo)) {
                        showRow = false;
                    }
                }

                // Show/hide row
                row.style.display = showRow ? '' : 'none';
            });

            // Show "No results found" message if all rows are hidden
            const visibleRows = rows.filter(row => !row.classList.contains('no-results') && row.style.display !== 'none');
            const noResultsRow = tbody.querySelector('.no-results');
            
            if (visibleRows.length === 0) {
                if (!noResultsRow) {
                    const tr = document.createElement('tr');
                    tr.className = 'no-results';
                    tr.innerHTML = '<td colspan="8" class="text-center py-4 text-gray-500 dark:text-gray-400">No matching cases found</td>';
                    tbody.appendChild(tr);
                }
            } else if (noResultsRow) {
                noResultsRow.remove();
            }
        }

        function resetFilters() {
            statusFilter.value = '';
            searchFilter.value = '';
            filingDateFrom.value = '';
            filingDateTo.value = '';
            hearingDateFrom.value = '';
            hearingDateTo.value = '';
            filterCases();
        }

        // Initialize Select2 when opening the modal
function initializeSelect2Dropdowns() {
    console.log('Initializing Select2 dropdowns for legal case modal');
    
    // Remove any existing select2 containers first
    $('.select2-container').remove();
    
    // Make sure the modal is visible before initializing Select2
    // This ensures proper positioning of the dropdowns
    $('#newCaseModal').css('display', 'block');
    
    // Add a specific class to the modal for z-index handling
    $('#newCaseModal').addClass('select2-modal');
    
    // Add CSS to ensure Select2 dropdowns appear within the modal
    $('<style>\
        .select2-container--open {\
            z-index: 9999;\
        }\
        .select2-modal {\
            z-index: 1050;\
        }\
        .select2-dropdown {\
            z-index: 9999;\
        }\
    </style>').appendTo('head');
    
    // Initialize customer select
    $('#customer_id').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search for a customer...',
        allowClear: true,
        width: '100%',
        dropdownParent: $('#newCaseModal .modal-body').length ? $('#newCaseModal .modal-body') : $('#newCaseModal'),
        ajax: {
            url: '/api/customers/search',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return {
                    q: params.term || '',
                    page: params.page || 1,
                    per_page: 10
                };
            },
            processResults: function(data) {
                console.log('Customer data received:', data);
                
                if (!data || !Array.isArray(data.items)) {
                    console.error('Invalid customer data format:', data);
                    return { results: [] };
                }
                
                return {
                    results: data.items.map(item => ({
                        id: item.id,
                        text: item.text,
                        loans: item.loans || []
                    })),
                    pagination: {
                        more: data.has_more || false
                    }
                };
            },
            cache: true
        },
        minimumInputLength: 0,
        templateResult: formatCustomer,
        templateSelection: formatCustomerSelection
    });
    
    // Initialize loan_id Select2 - this is handled differently as it's populated based on customer selection
    $('#loan_id').select2({
        theme: 'bootstrap-5',
        placeholder: 'Select a loan',
        allowClear: true,
        width: '100%',
        dropdownParent: $('#newCaseModal .modal-body').length ? $('#newCaseModal .modal-body') : $('#newCaseModal')
    });
    
    // Define staff select configuration
    const staffSelect2Config = {
        theme: 'bootstrap-5',
        placeholder: 'Select a staff member',
        allowClear: true,
        width: '100%',
        ajax: {
            url: '/api/collection-schedules/staff',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                console.log('Sending staff search:', params.term);
                return {
                    term: params.term || '',
                    page: params.page || 1
                    // Removed role_type filter to get all staff members
                };
            },
            processResults: function(data) {
                console.log('Received staff data:', data);
                if (!data || !Array.isArray(data)) {
                    console.error('Expected data to be an array:', data);
                    return { results: [] };
                }
                // Filter for collection officers and format the results
                const filteredData = data.filter(item => 
                    item.role && item.role.toLowerCase().includes('officer')
                );
                return {
                    results: filteredData.map(item => ({
                        id: item.id,
                        text: item.name,
                        role: item.role,
                        branchId: item.branch_id
                    }))
                };
            },
            cache: true
        },
        minimumInputLength: 0,
        templateResult: formatStaff,
        templateSelection: formatStaffSelection
    };
    
    // Initialize legal_officer_id Select2
    $('#legal_officer_id').select2({
        ...staffSelect2Config,
        dropdownParent: $('#newCaseModal .modal-body').length ? $('#newCaseModal .modal-body') : $('#newCaseModal')
    });
    
    // Update hidden legal_officer_name when selection changes
    $('#legal_officer_id').on('select2:select', function(e) {
        const selectedText = e.params.data.text || e.params.data.name || '';
        $('#legal_officer_name').val(selectedText);
    });
    
    // Clear legal_officer_name when legal officer is cleared
    $('#legal_officer_id').on('select2:clear', function() {
        $('#legal_officer_name').val('');
    });
    
    // Define supervisor select configuration
    const supervisorSelect2Config = {
        theme: 'bootstrap-5',
        placeholder: 'Select a supervisor',
        allowClear: true,
        width: '100%',
        ajax: {
            url: '/api/collection-schedules/staff',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                console.log('Sending supervisor search:', params.term);
                return {
                    term: params.term || '',
                    page: params.page || 1
                    // Removed role_type filter to get all staff members
                };
            },
            processResults: function(data) {
                console.log('Received supervisor data:', data);
                if (!data || !Array.isArray(data)) {
                    console.error('Expected data to be an array:', data);
                    return { results: [] };
                }
                // Filter for supervisors and format the results
                const filteredData = data.filter(item => 
                    item.role && (item.role.toLowerCase().includes('supervisor') || 
                                  item.role.toLowerCase().includes('manager'))
                );
                return {
                    results: filteredData.map(item => ({
                        id: item.id,
                        text: item.name,
                        role: item.role,
                        branchId: item.branch_id
                    }))
                };
            },
            cache: true
        },
        minimumInputLength: 0,
        templateResult: formatStaff,
        templateSelection: formatStaffSelection
    };
    
    // Initialize supervisor_id Select2
    $('#supervisor_id').select2({
        ...supervisorSelect2Config,
        dropdownParent: $('#newCaseModal .modal-body').length ? $('#newCaseModal .modal-body') : $('#newCaseModal')
    });
    
    // Update hidden supervisor_name when selection changes
    $('#supervisor_id').on('select2:select', function(e) {
        const selectedText = e.params.data.text || e.params.data.name || '';
        $('#supervisor_name').val(selectedText);
    });
    
    // Clear supervisor_name when supervisor is cleared
    $('#supervisor_id').on('select2:clear', function() {
        $('#supervisor_name').val('');
    });
}

// When customer is selected, populate loans dropdown
$('#customer_id').on('select2:select', function(e) {
    const customerId = e.params.data.id;
    const customerName = e.params.data.text || '';
    const customerLoans = e.params.data.loans || [];
    
    console.log('Selected customer:', e.params.data);
    console.log('Selected customer loans:', customerLoans);
    
    // Store customer name in hidden field
    $('#customer_name').val(customerName);
    
    // Clear loan dropdown and add placeholder
    $('#loan_id').empty().append('<option value="">Select Loan</option>');
    
    // If customer has loans, populate them directly
    if (customerLoans && customerLoans.length > 0) {
        console.log('Populating loans from customer data');
        customerLoans.forEach(loan => {
            // Map the loan properties to a consistent format
            // The API might return different property names than what we expect
            const loanId = loan.id || loan.LoanAppID;
            const loanNumber = loan.account_number || loan.LoanNo;
            const outstandingBalance = loan.outstanding_balance || loan.OutstandingBalance;
            const daysInArrears = loan.days_in_arrears || loan.DaysInArrears || 0;
            const installmentAmount = loan.installment_amount || loan.InstallmentAmount;
            
            // Create a standardized loan object
            const standardizedLoan = {
                id: loanId,
                account_number: loanNumber,
                outstanding_balance: outstandingBalance,
                days_in_arrears: daysInArrears,
                installment_amount: installmentAmount,
                customer_name: customerName
            };
            
            // Create the option with the loan number as text
            const option = new Option(loanNumber, loanId, false, false);
            
            // Store the standardized loan data with the option
            $(option).data('loan', standardizedLoan);
            
            // Add the option to the dropdown
            $('#loan_id').append(option);
        });
        
        // Trigger change to refresh Select2
        $('#loan_id').trigger('change');
    } else {
        // Otherwise fetch loans via API
        console.log('Fetching loans via API for customer:', customerId);
        $.ajax({
            url: `/api/customers/${customerId}/loans`,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log('Loans data received:', data);
                if (data && Array.isArray(data)) {
                    data.forEach(loan => {
                        const option = new Option(loan.account_number, loan.id, false, false);
                        $(option).data('loan', loan); // Store full loan data
                        $('#loan_id').append(option);
                    });
                    
                    // Trigger change to refresh Select2
                    $('#loan_id').trigger('change');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching loans:', error);
            }
        });
    }
});

// When loan is selected, populate loan details
$('#loan_id').on('select2:select', function(e) {
    const loan = e.params.data;
    const loanId = loan.id;
    const loanAccountNo = loan.text || '';
    
    console.log('Selected loan:', loan);
    
    // Update visible fields with loan details
    $(this).val(loanId).trigger('change'); // Set the value and trigger change
    $('#loan_account_no').val(loanAccountNo);
    
    // Check if we already have the loan data
    const loanData = $(e.params.data.element).data('loan');
    if (loanData) {
        console.log('Using cached loan data:', loanData);
        updateLoanDetailsInForm(loanData);
    } else {
        // Otherwise fetch loan details via API
        console.log('Fetching loan details via API for loan:', loanId);
        $.ajax({
            url: `/api/loans/${loanId}`,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                console.log('Loan details received:', data);
                // Standardize the loan data format
                const standardizedData = {
                    id: data.id || data.LoanAppID,
                    account_number: data.account_number || data.LoanNo,
                    outstanding_balance: data.outstanding_balance || data.OutstandingBalance,
                    days_in_arrears: data.days_in_arrears || data.DaysInArrears || 0,
                    installment_amount: data.installment_amount || data.InstallmentAmount,
                    customer_name: data.customer_name || $('#customer_name').val()
                };
                updateLoanDetailsInForm(standardizedData);
            },
            error: function(xhr, status, error) {
                console.error('Error fetching loan details:', error);
            }
        });
    }
});

// Function to update loan details in the form
function updateLoanDetailsInForm(loan) {
    // Format currency values
    const formattedOutstandingBalance = formatCurrency(loan.outstanding_balance);
    const formattedInstallmentAmount = formatCurrency(loan.installment_amount || loan.outstanding_balance);
    
    // Set raw values in hidden fields
    $('#raw_outstanding_balance').val(loan.outstanding_balance || 0);
    $('#raw_days_in_arrears').val(loan.days_in_arrears || 0);
    $('#raw_installment_amount').val(loan.installment_amount || loan.outstanding_balance || 0);
    
    // Set formatted values in visible fields
    $('#outstanding_balance').val(formattedOutstandingBalance);
    $('#days_in_arrears').val(loan.days_in_arrears || 0);
    
    // Calculate missed payments based on days in arrears
    const daysInArrears = parseInt(loan.days_in_arrears || 0);
    const missedPayments = daysInArrears > 0 ? Math.ceil(daysInArrears / 30) : 0;
    $('#missed_payments').val(missedPayments);
    
    // Set installment amount, using outstanding_balance as fallback if not available
    if (loan.installment_amount) {
        $('#installment_amount').val(formattedInstallmentAmount);
    } else {
        // Use outstanding_balance as fallback per memory instructions
        $('#installment_amount').val(formattedOutstandingBalance + ' (estimated)');
    }
    
    // Set default values for case form
    $('#plaintiff').val('Your Company Name'); // Default plaintiff
    $('#defendant').val(loan.customer_name || $('#customer_name').val()); // Default defendant
    $('#amount_claimed').val(loan.outstanding_balance || 0); // Default amount claimed
}

// Function to fetch and display case attachments
function fetchCaseAttachments(caseId) {
    fetch(`/user/legal-cases/${caseId}/attachments`)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            const attachmentsContainer = document.getElementById('viewAttachments');
            attachmentsContainer.innerHTML = '';
            
            if (data.attachments && data.attachments.length > 0) {
                data.attachments.forEach(attachment => {
                    const attachmentElement = document.createElement('div');
                    attachmentElement.className = 'bg-gray-50 dark:bg-gray-700 rounded-md p-3';
                    attachmentElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h5 class="text-sm font-medium text-gray-900 dark:text-gray-100">${attachment.filename}</h5>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    ${attachment.file_type}  Uploaded on ${attachment.upload_date}
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <a href="${attachment.file_path}" target="_blank" class="text-primary hover:text-primary-dark">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </a>
                                <button onclick="deleteAttachment(${caseId}, ${attachment.id})" class="text-red-500 hover:text-red-600">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    attachmentsContainer.appendChild(attachmentElement);
                });
            } else {
                attachmentsContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No attachments available</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching attachments:', error);
            const attachmentsContainer = document.getElementById('viewAttachments');
            attachmentsContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Error loading attachments</p>';
        });
}

// Function to delete an attachment
function deleteAttachment(caseId, attachmentId) {
    if (confirm('Are you sure you want to delete this attachment? This action cannot be undone.')) {
        fetch(`/user/legal-cases/${caseId}/attachments/${attachmentId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete attachment');
            }
            return response.json();
        })
        .then(data => {
            // Refresh attachments list
            fetchCaseAttachments(caseId);
        })
        .catch(error => {
            console.error('Error deleting attachment:', error);
            alert('Failed to delete attachment. Please try again.');
        });
    }
}

// Initialize Select2 when opening the modal
function openNewCaseModal() {
    const modal = document.getElementById('newCaseModal');
    modal.classList.remove('hidden');
    
    // Use setTimeout to ensure the modal is visible before initializing Select2
    // This ensures proper positioning of the dropdowns
    setTimeout(function() {
        initializeSelect2Dropdowns();
    }, 100);
}
function closeNewCaseModal() {
    const modal = document.getElementById('newCaseModal');
    
    // Hide modal
    modal.classList.add('hidden');
    modal.style.display = 'none';
    
    // Cleanup Select2
    ['#customer_id', '#loan_id', '#legal_officer_id', '#supervisor_id'].forEach(selector => {
        const $element = $(selector);
        if ($element.data('select2')) {
            $element.select2('destroy');
        }
    });

    // Reset form
    document.getElementById('newCaseForm').reset();
}

// Delete case confirmation dialog
function confirmDeleteCase(caseId) {
    // Create a modal dialog
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
    
    const modalContent = document.createElement('div');
    modalContent.className = 'bg-white rounded-lg p-6 max-w-md w-full mx-4';
    
    modalContent.innerHTML = `
        <div class="text-center">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Delete Legal Case</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this legal case? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDelete" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                    Cancel
                </button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                    Delete
                </button>
            </div>
        </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // Add event listeners
    const cancelBtn = modal.querySelector('#cancelDelete');
    const confirmBtn = modal.querySelector('#confirmDelete');
    
    cancelBtn.addEventListener('click', () => {
        modal.remove();
    });

    confirmBtn.addEventListener('click', () => {
        // Send delete request
        fetch(`/user/legal-cases/${caseId}/delete`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete case');
            }
            return response.json();
        })
        .then(data => {
            // Show success message
            const successModal = document.createElement('div');
            successModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
            successModal.innerHTML = `
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Success!</strong>
                    <span class="block sm:inline"> ${data.message}</span>
                </div>
            `;
            document.body.appendChild(successModal);
            
            // Refresh the page after 1 second
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            const errorModal = document.createElement('div');
            errorModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
            errorModal.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline"> Failed to delete case. Please try again.</span>
                </div>
            `;
            document.body.appendChild(errorModal);
        })
        .finally(() => {
            modal.remove();
        });
    });

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Handle file attachment with drag and drop
const legalCaseDropZone = document.getElementById('dropZone');
const fileUpload = document.getElementById('file-upload');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    legalCaseDropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    legalCaseDropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    legalCaseDropZone.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    legalCaseDropZone.classList.add('border-primary', 'bg-blue-50');
    legalCaseDropZone.classList.remove('border-gray-300');
}

function unhighlight() {
    legalCaseDropZone.classList.remove('border-primary', 'bg-blue-50');
    legalCaseDropZone.classList.add('border-gray-300');
}

// Handle dropped files
legalCaseDropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        fileUpload.files = files;
        updateFileInfo(files[0]);
    }
}

// Handle file selection via input
fileUpload.addEventListener('change', function() {
    if (this.files.length > 0) {
        updateFileInfo(this.files[0]);
    }
});

// Update file info display
function updateFileInfo(file) {
    const fileNameDisplay = document.createElement('div');
    fileNameDisplay.className = 'mt-2 text-sm text-gray-700';
    fileNameDisplay.innerHTML = `<strong>Selected file:</strong> ${file.name} (${formatFileSize(file.size)})`;
    
    // Remove any existing file info display
    const existingFileInfo = legalCaseDropZone.querySelector('.mt-2.text-sm.text-gray-700');
    if (existingFileInfo) {
        existingFileInfo.remove();
    }
    
    // Add the new file info display
    legalCaseDropZone.appendChild(fileNameDisplay);
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Form submission handler
document.getElementById('newCaseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Get the form element
    const form = this;
    
    // Create FormData from the form
    const formData = new FormData(form);
    
    // Log form data for debugging
    console.log('Submitting form data:');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }

            console.log('Sending form data:', formData);

            // Send data to backend
            fetch('/user/create_legal_case', {
                method: 'POST',
                credentials: 'same-origin', // Include cookies for CSRF
                body: formData
            })
            .then(response => {
                console.log('Full Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers),
                    type: response.type,
                    url: response.url
                });
                
                // Always try to parse as JSON, even for error responses
                return response.json().then(data => ({
                    data: data,
                    response: response
                })).catch(err => {
                    // If JSON parsing fails, return the raw response
                    return response.text().then(text => ({
                        error: 'Failed to parse JSON',
                        text: text,
                        response: response
                    }));
                });
            })
            .then(result => {
                console.log('Parsed Result:', result);
                
                // Check if there's an error in parsing or in the response
                if (result.error) {
                    throw new Error(result.error + ': ' + result.text);
                }
                
                // Check response status and data
                if (result.response.ok && result.data.case_id) {
                    // Success: show success message and close modal
                    Swal.fire({
                        icon: 'success',
                        title: 'Legal Case Created',
                        text: 'The legal case has been successfully created.',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        closeNewCaseModal();
                        location.reload();
                    });
                } else {
                    // Error: show error message
                    throw new Error(result.data.error || 'Failed to create legal case');
                }
            })
            .catch(error => {
                console.error('Full Submission Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Error',
                    text: `Could not submit form: ${error.message}`,
                    confirmButtonText: 'OK'
                });
            });
        });

        function viewCaseDetails(caseId) {
    fetch(`/user/legal-cases/${caseId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            // Update case information
            document.getElementById('viewCaseId').textContent = `Case #${data.case_number || data.id}`;
            document.getElementById('viewLoanId').textContent = data.loan_id || 'N/A';
            
            // Format status with badge
            const statusElement = document.getElementById('viewStatus');
            const statusClass = getStatusClass(data.status);
            statusElement.innerHTML = `<span class="px-2 py-1 text-xs font-medium ${statusClass}">${data.status}</span>`;
            
            // Format amount with currency
            document.getElementById('viewAmount').textContent = formatCurrency(data.amount_claimed);
            
            // Format dates
            document.getElementById('viewFilingDate').textContent = formatDate(data.filing_date) || 'N/A';
            document.getElementById('viewHearingDate').textContent = formatDate(data.next_hearing_date) || 'Not Scheduled';
            
            // Update parties involved
            document.getElementById('viewPlaintiff').textContent = data.plaintiff || 'N/A';
            document.getElementById('viewDefendant').textContent = data.defendant || 'N/A';
            
            // Update legal representation
            document.getElementById('viewLawyerName').textContent = data.lawyer_name || 'Not Assigned';
            document.getElementById('viewLawyerContact').textContent = data.lawyer_contact || 'N/A';
            
            // Update description
            document.getElementById('viewDescription').textContent = data.description || 'No description available';
            
            // Show modal first
            document.getElementById('viewDetailsModal').classList.remove('hidden');
            
            // Fetch and update case attachments
            fetchCaseAttachments(caseId);
            
            // Update case history
            const historyContainer = document.getElementById('viewCaseHistory');
            historyContainer.innerHTML = '';
            
            if (data.history && data.history.length > 0) {
                data.history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'flex items-start space-x-3 p-3 bg-white dark:bg-gray-600 rounded-lg';
                    
                    historyItem.innerHTML = `
                        <div class="flex-shrink-0">
                            <div class="w-2 h-2 mt-2 rounded-full bg-primary"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100">${item.action}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${formatDate(item.date)}</p>
                            ${item.notes ? `<p class="mt-1 text-sm text-gray-600 dark:text-gray-300">${item.notes}</p>` : ''}
                        </div>
                    `;
                    
                    historyContainer.appendChild(historyItem);
                });
            } else {
                historyContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No history available</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching case details:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load case details. Please try again.',
                confirmButtonText: 'OK'
            });
        });
}

        function getStatusClass(status) {
            const statusClasses = {
                'Active': 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100',
                'Pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100',
                'Resolved': 'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100',
                'Dismissed': 'bg-gray-100 text-gray-800'
            };
            return statusClasses[status] || 'bg-gray-100 text-gray-800';
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        function formatCurrency(amount) {
            if (!amount) return 'N/A';
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function closeViewDetailsModal() {
            document.getElementById('viewDetailsModal').classList.add('hidden');
        }

        let currentCaseId;
        function openAddHistoryModal(caseId) {
            currentCaseId = caseId;
            document.getElementById('case_id').value = caseId;
            document.getElementById('addHistoryModal').classList.remove('hidden');
            
            // Reset form
            document.getElementById('addHistoryForm').reset();
            document.getElementById('fileList').innerHTML = '';
            
            // Set default date to current date and time
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('actionDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function closeAddHistoryModal() {
            document.getElementById('addHistoryModal').classList.add('hidden');
        }

        function submitCaseHistory(event) {
            event.preventDefault();
            
            const form = document.getElementById('addHistoryForm');
            const formData = new FormData(form);
            
            // Add case_id to formData
            formData.append('case_id', currentCaseId);
            
            // Get file input and append files to formData
            const fileInput = document.getElementById('attachments');
            const files = fileInput.files;
            for (let i = 0; i < files.length; i++) {
                formData.append('attachments', files[i]);
            }

            fetch('/user/add_case_history', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    showToast('error', data.error);
                } else {
                    showToast('success', 'Case history added successfully');
                    closeAddHistoryModal();
                    // Optionally refresh the case details
                    if (currentCaseId) {
                        viewCaseDetails(currentCaseId);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Failed to add case history');
            });
        }

        // Add event listener to the form
        document.getElementById('addHistoryForm').addEventListener('submit', submitCaseHistory);

        // Handle file selection
        document.getElementById('attachments').addEventListener('change', function(e) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            Array.from(e.target.files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between text-sm text-gray-600 dark:text-gray-300';
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                        </svg>
                        <span>${file.name}</span>
                    </div>
                    <span class="text-xs">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                `;
                fileList.appendChild(fileItem);
            });
        });

        // Handle drag and drop
        const dropZone = document.querySelector('form');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropZone.classList.add('border-primary');
        }

        function unhighlight() {
            dropZone.classList.remove('border-primary');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('attachments').files = files;
            
            // Trigger the change event manually
            const event = new Event('change');
            document.getElementById('attachments').dispatchEvent(event);
        }
    </script>
    <script>
        let currentStep = 1;
        const totalSteps = 5;
        
        function updateStepIndicator(step) {
            document.querySelectorAll('.wizard-steps .step').forEach((el, index) => {
                el.classList.toggle('border-primary', index < step);
                el.classList.toggle('text-primary', index < step);
            });
        }
        
        function validateStep(step) {
            const inputs = document.querySelectorAll(`.wizard-step[data-step="${step}"] [required]`);
            return Array.from(inputs).every(input => input.reportValidity());
        }
        
        function nextStep() {
            if (validateStep(currentStep) && currentStep < totalSteps) {
                currentStep++;
                updateStepDisplay();
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }
        
        function updateStepDisplay() {
            document.querySelectorAll('.wizard-step').forEach(el => el.classList.add('hidden'));
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('hidden');
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === totalSteps);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== totalSteps);
            updateStepIndicator(currentStep);
        }
        
        // Initialize the wizard when the modal opens
        document.addEventListener('DOMContentLoaded', () => {
            updateStepDisplay();
        });
    </script>
{% endblock %}
